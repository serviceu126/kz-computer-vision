<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∏–æ—Å–∫ —É–ø–∞–∫–æ–≤–∫–∏ –∫—Ä–æ–≤–∞—Ç–µ–π</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --card-bg: #0f172a;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --error: #ef4444;
      --warn: #facc15;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 40%, #020617 100%);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 16px 20px;
      gap: 16px;
    }

    /* –õ–û–ì–û–¢–ò–ü */

    .logo-bar {
      display: flex;
      align-items: center;
      padding: 4px 4px 0 4px;
      margin-bottom: 4px;
    }

    .logo-img {
      height: 44px;
      opacity: 0.95;
      filter: drop-shadow(0 10px 18px rgba(0, 0, 0, 0.55));
    }

    .top-bar {
      display: grid;
      grid-template-columns: 1.3fr 1.3fr 1.4fr;
      gap: 16px;
      align-items: stretch;
    }

    .card {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
      border-radius: var(--radius);
      border: 1px solid var(--border-soft);
      padding: 14px 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      opacity: 0.08;
      background:
        radial-gradient(circle at 0 0, #22c55e, transparent 55%),
        radial-gradient(circle at 100% 0, #38bdf8, transparent 55%);
      pointer-events: none;
    }

    .card-content {
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .card-main {
      font-size: 22px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* –¢–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ "–¢–µ–∫—É—â–∞—è –∫—Ä–æ–≤–∞—Ç—å": –¥–µ–ª–∞–µ–º SKU –æ–¥–Ω–æ–π –±–æ–ª—å—à–æ–π —Å—Ç—Ä–æ–∫–æ–π */
.bed-mainline {
  display: block;          /* –Ω–µ –ª–æ–º–∞–µ–º —Å–µ—Ç–∫—É, –ø—Ä–æ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ */
  font-size: 26px;         /* –∫—Ä—É–ø–Ω–µ–µ, —á–µ–º –æ–±—ã—á–Ω—ã–π card-main (22px) */
  font-weight: 700;
  line-height: 1.15;
}


    .card-sub {
      font-size: 15px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .badge {
      font-size: 13px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 6px var(--accent);
    }

    .status-pill {
      font-size: 14px;
      border-radius: 999px;
      padding: 4px 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .status-ok {
      background: rgba(16, 185, 129, 0.15);
      color: #6ee7b7;
      border: 1px solid rgba(16, 185, 129, 0.6);
    }

    .status-warn {
      background: rgba(250, 204, 21, 0.14);
      color: #facc15;
      border: 1px solid rgba(250, 204, 21, 0.7);
    }

    .status-error {
      background: rgba(239, 68, 68, 0.18);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.8);
    }

    .timer {
      font-variant-numeric: tabular-nums;
      font-size: 26px;
      font-weight: 600;
    }

    .timers {
      display: flex;
      gap: 16px;
      margin-top: 6px;
      font-size: 13px;
    }

    .timer-chip {
      flex: 1;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-variant-numeric: tabular-nums;
    }

    .timer-chip-label {
      color: var(--text-muted);
    }

    .timer-chip-value {
      font-weight: 500;
    }

    .middle {
      display: grid;
      grid-template-columns: 2.2fr 1.6fr;
      gap: 16px;
      flex: 1;
      min-height: 0;
    }

    .camera-card {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .camera-frame {
      position: relative;
      flex: 1;
      border-radius: 16px;
      overflow: hidden;
      background: #020617;
      border: 1px solid var(--border-soft);
    }

    .camera-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: brightness(0.95);
    }

    .camera-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .slot {
      position: absolute;
      border-radius: 12px;
      border: 2px dashed rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 4px;
      font-size: 12px;
      color: var(--text-muted);
      transition: all 0.2s ease-out;
    }

    .slot-title {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .slot-status {
      font-size: 11px;
    }

    .slot.pending {
      opacity: 0.35;
      border-style: dashed;
    }

    .slot.current {
      opacity: 1;
      border-style: solid;
      border-color: #38bdf8;
      background: rgba(8, 47, 73, 0.85);
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.8);
      color: #e0f2fe;
    }

    .slot.done {
      opacity: 0.9;
      border-style: solid;
      border-color: #22c55e;
      background: rgba(22, 101, 52, 0.85);
      color: #bbf7d0;
    }

    .slot.done .slot-status::before {
      content: "‚úî ";
    }

    .camera-caption {
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .camera-caption span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .instruction-card {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 18px 22px;
    }

    .instruction-main {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .instruction-sub {
      font-size: 19px;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    .instruction-extra {
      font-size: 15px;
      color: var(--text-muted);
    }

    .big-icon {
      font-size: 34px;
      margin-right: 10px;
    }

    .steps-card {
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid var(--border-soft);
    }

    .progress-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      width: 0%;
      transition: width 0.25s ease-out;
    }

    .steps-list {
      margin-top: 6px;
      max-height: 100%;
      overflow: hidden;
    }

    .step-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px 0;
      font-size: 15px;
    }

    .step-index {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      background: #020617;
      border: 1px solid var(--border-soft);
      color: var(--text-muted);
    }

    .step-row.done .step-index {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: #bbf7d0;
    }

    .step-row.current .step-index {
      background: #0ea5e9;
      border-color: #38bdf8;
      color: #e0f2fe;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.6);
    }

    .step-title {
      font-weight: 500;
    }

    .step-meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    .bottom {
      display: grid;
      grid-template-columns: 2.2fr 1.6fr;
      gap: 16px;
      align-items: stretch;
    }

    .events-card {
      padding: 10px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 140px;
    }

    .events-list {
      font-size: 13px;
      flex: 1;
      overflow: hidden;
    }

    .event-row {
      display: flex;
      gap: 8px;
      padding: 2px 0;
      color: var(--text-muted);
    }

    .event-time {
      font-variant-numeric: tabular-nums;
      width: 60px;
      color: #6b7280;
    }

    .event-text {
      flex: 1;
    }

    .stats-card {
      padding: 10px 16px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 140px;
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
    }

    .stats-label {
      color: var(--text-muted);
    }

    .stats-value {
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }

    .status-strip {
      position: fixed;
      inset-inline: 0;
      bottom: 0;
      height: 4px;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      opacity: 0.9;
      transition: background 0.2s ease-out;
    }

    .status-strip.warn {
      background: linear-gradient(90deg, #facc15, #f97316);
    }

    .status-strip.error {
      background: linear-gradient(90deg, #ef4444, #b91c1c);
    }
  </style>
</head>
<body>
<div class="app">
  <div class="logo-bar">
    <!--<img src="/static/logo.png" class="logo-img" alt="–ù–æ–≤—ã–µ –º–µ–±–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏" /> -->
  </div>

  <!-- –í–µ—Ä—Ö -->
  <div class="top-bar">
    <div class="card">
      <div class="card-content">
        <div class="card-title">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</div>
        <div class="card-main">
          <span id="workerName">‚Äî</span>
          <span class="badge" id="shiftLabel">
            <span class="dot"></span>
            <span id="shiftInfo">–°–º–µ–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
          </span>
        </div>
        <div class="card-sub" id="workerStats">
          –°–µ–≥–æ–¥–Ω—è: 0 –∫—Ä–æ–≤–∞—Ç–µ–π, –ø—Ä–æ—Å—Ç–æ–µ–≤ 0 –º–∏–Ω
        </div>
        <div class="card-sub" id="workerScanHint"></div> <!-- –ù–û–í–ê–Ø –°–¢–†–û–ö–ê -->
      </div>
    </div>

<div class="card">
  <div class="card-content">
    <div class="card-title">–¢–µ–∫—É—â–∞—è –∫—Ä–æ–≤–∞—Ç—å</div>

    <!-- –ë–æ–ª—å—à–∞—è —Å—Ç—Ä–æ–∫–∞: SKU -->
    <div class="card-main bed-mainline">
      <span id="bedSkuBig">SKU ‚Äî</span>
    </div>

    <!-- –ü–æ—è—Å–Ω–µ–Ω–∏–µ + –¥–µ—Ç–∞–ª–∏ -->
    <div class="card-sub" id="bedDetails">
      –ú–æ–¥–µ–ª—å ‚Äî | –†–∞–∑–º–µ—Ä ‚Äî | –¶–≤–µ—Ç ‚Äî
    </div>
  </div>
</div>


    <div class="card">
      <div class="card-content">
        <div class="card-title">–í—Ä–µ–º—è —É–ø–∞–∫–æ–≤–∫–∏</div>
        <div class="card-main" style="margin-bottom:4px;">
          <span class="timer" id="sessionTimer">00:00</span>
          <span id="statusPill" class="status-pill status-warn">
            <span class="dot"></span>
            <span id="statusText">–û–∂–∏–¥–∞–Ω–∏–µ</span>
          </span>
        </div>
        <div class="timers">
          <div class="timer-chip">
            <span class="timer-chip-label">–†–∞–±–æ—Ç–∞</span>
            <span class="timer-chip-value" id="workTimer">00:00</span>
          </div>
          <div class="timer-chip">
            <span class="timer-chip-label">–ü—Ä–æ—Å—Ç–æ–π</span>
            <span class="timer-chip-value" id="idleTimer">00:00</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –¶–µ–Ω—Ç—Ä -->
  <div class="middle">
    <div class="card camera-card">
      <div class="card-title">–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª (–≤–∏–¥ —Å–≤–µ—Ä—Ö—É)</div>
      <div class="camera-frame">
        <img id="cameraImage" class="camera-image" src="" alt="–ü–æ—Ç–æ–∫ —Å –∫–∞–º–µ—Ä—ã" />
        <div id="cameraOverlay" class="camera-overlay"></div>
      </div>
      <div class="camera-caption">
        <span id="cameraHint">
          –ó–æ–Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è: ~3.5‚Äì4.0√ó1.5 –º. –°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–≤–µ—Ç–∫–µ –¥–µ—Ç–∞–ª–µ–π –Ω–∞ —Å—Ç–æ–ª–µ.
        </span>
        <span id="workerStateLabel">–°–æ—Å—Ç–æ—è–Ω–∏–µ: ‚Äî</span>
      </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:12px; min-height:0;">
      <div class="card instruction-card">
        <div>
          <div class="card-title">–¢–µ–∫—É—â–∞—è –∫–æ–º–∞–Ω–¥–∞</div>
          <div class="instruction-main">
            <span class="big-icon">üõ†Ô∏è</span>
            <span id="instructionMain">–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —É–ø–∞–∫–æ–≤–∫–∏‚Ä¶</span>
          </div>
          <div class="instruction-sub" id="instructionSub">
            –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.
          </div>
        </div>
        <div class="instruction-extra" id="instructionExtra">
          –ì–æ–ª–æ—Å–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥—É–±–ª–∏—Ä—É—é—Ç —Ç–µ–∫—Å—Ç. –†–∞–±–æ—Ç–∞–π—Ç–µ –ø–æ –≥–æ–ª–æ—Å—É, –Ω–∞ —ç–∫—Ä–∞–Ω –ø–æ–≥–ª—è–¥—ã–≤–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
        </div>
      </div>

      <div class="card steps-card" style="flex:1; min-height:0;">
        <div>
          <div class="card-title">–ü—Ä–æ–≥—Ä–µ—Å—Å –∫–æ–º–ø–ª–µ–∫—Ç–∞</div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <div id="stepsSummary">–®–∞–≥ 0 –∏–∑ 0</div>
            <div style="font-size:13px; color:var(--text-muted);" id="stepsCounters">
              0 –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ, 0 –æ—à–∏–±–æ–∫
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>
        <div class="steps-list" id="stepsList"></div>
      </div>
    </div>
  </div>

  <!-- –ù–∏–∑ -->
  <div class="bottom">
    <div class="card events-card">
      <div class="card-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</div>
      <div class="events-list" id="eventsList"></div>
    </div>
    <div class="card stats-card">
      <div class="card-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É–ø–∞–∫–æ–≤–∫–µ —ç—Ç–æ–π –∫—Ä–æ–≤–∞—Ç–∏</div>
      <div class="stats-row">
        <span class="stats-label">–ü–æ—Å–ª–µ–¥–Ω—è—è —É–ø–∞–∫–æ–≤–∫–∞</span>
        <span class="stats-value" id="lastPack">‚Äî</span>
      </div>
      <div class="stats-row">
        <span class="stats-label">–õ—É—á—à–µ–µ –≤—Ä–µ–º—è</span>
        <span class="stats-value" id="bestPack">‚Äî</span>
      </div>
      <div class="stats-row">
        <span class="stats-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</span>
        <span class="stats-value" id="avgPack">‚Äî</span>
      </div>
      <div style="margin-top:8px; font-size:12px; color:var(--text-muted);">
        –í—Ä–µ–º—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º —Å–µ—Å—Å–∏—è–º —É–ø–∞–∫–æ–≤–∫–∏ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏ (–ø–æ SKU).
      </div>
    </div>
  </div>

  <div id="statusStrip" class="status-strip"></div>
</div>

<script>
  const API_STATE_URL = "/api/kiosk/state";

  let lastState = null;
  let timerStart = null;
  let workBase = 0;
  let idleBase = 0;

  function pad(n) { return n.toString().padStart(2, "0"); }

  function formatDuration(seconds) {
    const s = Math.max(0, Math.floor(seconds));
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return pad(m) + ":" + pad(sec);
  }

  function setStatus(status) {
    const pill = document.getElementById("statusPill");
    const text = document.getElementById("statusText");
    const strip = document.getElementById("statusStrip");

    pill.classList.remove("status-ok", "status-warn", "status-error");
    strip.classList.remove("warn", "error");

    if (status === "running") {
      pill.classList.add("status-ok");
      text.textContent = "–ò–¥—ë—Ç —É–ø–∞–∫–æ–≤–∫–∞";
    } else if (status === "idle") {
      pill.classList.add("status-warn");
      strip.classList.add("warn");
      text.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ";
    } else if (status === "error") {
      pill.classList.add("status-error");
      strip.classList.add("error");
      text.textContent = "–û—à–∏–±–∫–∞";
    } else if (status === "done") {
      pill.classList.add("status-ok");
      text.textContent = "–ì–æ—Ç–æ–≤–æ";
    } else {
      pill.classList.add("status-warn");
      text.textContent = status || "–û–∂–∏–¥–∞–Ω–∏–µ";
    }
  }

  function renderOverlays(state) {
    const overlayEl = document.getElementById("cameraOverlay");
    overlayEl.innerHTML = "";
    const slots = state.overlay_slots || [];
    const rect = overlayEl.getBoundingClientRect();
    const W = rect.width || 1;
    const H = rect.height || 1;

    slots.forEach((slot) => {
      const div = document.createElement("div");
      div.className = "slot";

      const status = slot.status || "pending";
      div.classList.add(status);

      const x = (slot.x || 0) * W;
      const y = (slot.y || 0) * H;
      const w = (slot.w || 0.2) * W;
      const h = (slot.h || 0.15) * H;

      div.style.left = x + "px";
      div.style.top = y + "px";
      div.style.width = w + "px";
      div.style.height = h + "px";

      const title = document.createElement("div");
      title.className = "slot-title";
      title.textContent = slot.title || "";

      const statusEl = document.createElement("div");
      statusEl.className = "slot-status";
      statusEl.textContent =
        status === "done" ? "–ì–æ—Ç–æ–≤–æ" :
        status === "current" ? "–°–µ–π—á–∞—Å" :
        "–ü–æ –ø–ª–∞–Ω—É";

      div.appendChild(title);
      div.appendChild(statusEl);
      overlayEl.appendChild(div);
    });
  }

  function renderState(state) {
    lastState = state;

const workerId = state.worker_id || "";

// –£–±–∏—Ä–∞–µ–º –±—É–∫–≤—É W, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å (W123 -> 123)
const workerNumber = workerId.replace(/^W/i, "");

document.getElementById("workerName").textContent =
  workerNumber ? `–°–æ—Ç—Ä—É–¥–Ω–∏–∫ ‚Ññ${workerNumber}` : "‚Äî";

    document.getElementById("shiftInfo").textContent =
      state.shift_label || "–°–º–µ–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞";
    document.getElementById("workerStats").textContent =
      state.worker_stats || "–°–µ–≥–æ–¥–Ω—è: 0 –∫—Ä–æ–≤–∞—Ç–µ–π, –ø—Ä–æ—Å—Ç–æ–µ–≤ 0 –º–∏–Ω";

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ö—Ä–æ–≤–∞—Ç—å: –∫—Ä—É–ø–Ω–æ SKU + —Å–Ω–∏–∑—É –ø–æ—è—Å–Ω–µ–Ω–∏–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// –ö–∞—Ä—Ç–∞ "–∫–æ–¥ –º–æ–¥–µ–ª–∏" -> "–Ω–∞–∑–≤–∞–Ω–∏–µ"
const BED_NAME_BY_PREFIX = {
  "001": "–°–æ–Ω–Ω–∞",
  "003": "–°–µ–Ω–Ω–∞",
};

// –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 —Ü–∏—Ñ—Ä—ã –∏–∑ SKU (–Ω–∞–ø—Ä–∏–º–µ—Ä "MM.–ö—Ä–æ–≤–∞—Ç—å.003-16-VelutaLux.07" -> "003")
function getModelPrefixFromSku(sku) {
  if (!sku) return "";
  const m = String(sku).match(/\b(\d{3})\b/); // –∏—â–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ —Å—Ç–æ—è—â–∏–µ 3 —Ü–∏—Ñ—Ä—ã
  return m ? m[1] : "";
}

// –ü–æ–ª—É—á–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è –∫—Ä–æ–≤–∞—Ç–∏ –ø–æ SKU
function getBedHumanName(sku) {
  const prefix = getModelPrefixFromSku(sku);
  return BED_NAME_BY_PREFIX[prefix] || "‚Äî";
}

const skuValue = state.bed_sku || "‚Äî";
const bedHumanName = getBedHumanName(skuValue);

// 1) –ö—Ä—É–ø–Ω–æ SKU
const skuBigEl = document.getElementById("bedSkuBig");
if (skuBigEl) {
  skuBigEl.textContent = "SKU " + skuValue;
}

// 2) –í–Ω–∏–∑—É: –ú–æ–¥–µ–ª—å + –¥–µ—Ç–∞–ª–∏ (—Ä–∞–∑–º–µ—Ä/—Ü–≤–µ—Ç/–≤–∏–¥ ‚Äî –∫–∞–∫ –æ—Ç–¥–∞—ë—Ç –±—ç–∫)
const detailsValue = state.bed_details || "–†–∞–∑–º–µ—Ä ‚Äî | –¶–≤–µ—Ç ‚Äî | –í–∏–¥ ‚Äî";
document.getElementById("bedDetails").textContent =
  "–ú–æ–¥–µ–ª—å " + bedHumanName + " | " + detailsValue;


    const status = state.status || "idle";
    setStatus(status);

    if (state.camera_stream_url) {
      const img = document.getElementById("cameraImage");
      const url = state.camera_stream_url;
      img.src = url.includes("?") ? url + "&t=" + Date.now() : url + "?t=" + Date.now();
    }
    const ws = state.worker_state || "idle";
    document.getElementById("workerStateLabel").textContent =
      "–°–æ—Å—Ç–æ—è–Ω–∏–µ: " + (ws === "working" ? "—Ä–∞–±–æ—Ç–∞" : ws === "idle" ? "–ø—Ä–æ—Å—Ç–æ–π" : ws);

    if (state.started_at_epoch) {
      timerStart = state.started_at_epoch * 1000;
    } else {
      timerStart = null;
      document.getElementById("sessionTimer").textContent = "00:00";
    }

    workBase = state.work_seconds || 0;
    idleBase = state.idle_seconds || 0;
    document.getElementById("workTimer").textContent =
      formatDuration(workBase);
    document.getElementById("idleTimer").textContent =
      formatDuration(idleBase);

    document.getElementById("instructionMain").textContent =
      state.instruction_main || "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —É–ø–∞–∫–æ–≤–∫–∏‚Ä¶";
    document.getElementById("instructionSub").textContent =
      state.instruction_sub ||
      "–ü—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫—Ä–æ–≤–∞—Ç–∏ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.";
    document.getElementById("instructionExtra").textContent =
      state.instruction_extra ||
      "–ì–æ–ª–æ—Å–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç —Ç–µ–∫—Å—Ç. –†–∞–±–æ—Ç–∞–π—Ç–µ –ø–æ –≥–æ–ª–æ—Å—É.";

    const currentStep = state.current_step_index || 0;
    const totalSteps = state.total_steps || 0;
    document.getElementById("stepsSummary").textContent =
      "–®–∞–≥ " + currentStep + " –∏–∑ " + totalSteps;
    document.getElementById("stepsCounters").textContent =
      (state.completed_steps || 0) +
      " –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ, " +
      (state.error_steps || 0) +
      " –æ—à–∏–±–æ–∫";

    const percent =
      totalSteps > 0 ? Math.round((currentStep / totalSteps) * 100) : 0;
    document.getElementById("progressFill").style.width = percent + "%";

    const stepsListEl = document.getElementById("stepsList");
    stepsListEl.innerHTML = "";
    if (state.steps && Array.isArray(state.steps)) {
      state.steps.forEach((step, idx) => {
        const row = document.createElement("div");
        row.className = "step-row";
        if (idx + 1 < currentStep) row.classList.add("done");
        if (idx + 1 === currentStep) row.classList.add("current");

        const indexEl = document.createElement("div");
        indexEl.className = "step-index";
        indexEl.textContent = idx + 1;

        const textWrap = document.createElement("div");
        const title = document.createElement("div");
        title.className = "step-title";
        title.textContent = step.title || "–®–∞–≥ " + (idx + 1);

        const meta = document.createElement("div");
        meta.className = "step-meta";
        meta.textContent = step.meta || "";

        textWrap.appendChild(title);
        textWrap.appendChild(meta);
        row.appendChild(indexEl);
        row.appendChild(textWrap);
        stepsListEl.appendChild(row);
      });
    }

    const eventsEl = document.getElementById("eventsList");
    eventsEl.innerHTML = "";
    if (state.events && Array.isArray(state.events)) {
      state.events.slice(-6).forEach((ev) => {
        const row = document.createElement("div");
        row.className = "event-row";

        const time = document.createElement("div");
        time.className = "event-time";
        time.textContent = ev.time || "";

        const txt = document.createElement("div");
        txt.className = "event-text";
        txt.textContent = ev.text || "";

        row.appendChild(time);
        row.appendChild(txt);
        eventsEl.appendChild(row);
      });
    }

    function fmtSec(v) {
      if (!v && v !== 0) return "‚Äî";
      return formatDuration(v);
    }
    document.getElementById("lastPack").textContent =
      fmtSec(state.last_pack_seconds);
    document.getElementById("bestPack").textContent =
      fmtSec(state.best_pack_seconds);
    document.getElementById("avgPack").textContent =
      fmtSec(state.avg_pack_seconds);

    renderOverlays(state);
  }

  function tickTimers() {
    if (!lastState) return;
    if (timerStart) {
      const diffSec = (Date.now() - timerStart) / 1000;
      document.getElementById("sessionTimer").textContent =
        formatDuration(diffSec);
    }
  }

  async function fetchState() {
    try {
      const resp = await fetch(API_STATE_URL, { cache: "no-store" });
      if (!resp.ok) return;
      const data = await resp.json();
      data.client_timestamp = Date.now() / 1000;
      renderState(data);
    } catch (e) {
      console.warn("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∏–æ—Å–∫–∞:", e);
    }
  }

  setInterval(fetchState, 1500);
  setInterval(tickTimers, 1000);
  fetchState();

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –°–∫–∞–Ω–µ—Ä –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  let scanBuffer = "";
  let currentWorkerId = null;          // W000
  let workerScanMode = "idle";         // "idle" | "waiting-worker"

  const shiftLabelEl = document.getElementById("shiftLabel");
  const shiftInfoEl = document.getElementById("shiftInfo");
  const workerScanHintEl = document.getElementById("workerScanHint");

  // —Ñ–æ—Ä–º–∞—Ç QR –∫—Ä–æ–≤–∞—Ç–∏:
  //   MM.BED.003-16-VelutaLux.07
  //   –∏–ª–∏ MM.–ö—Ä–æ–≤–∞—Ç—å.003-16-VelutaLux.07
  function normalizeSkuFromQr(raw) {
    let sku = (raw || "").trim();
    if (!sku) return "";

    // BED -> –ö—Ä–æ–≤–∞—Ç—å
    sku = sku.replace("BED", "–ö—Ä–æ–≤–∞—Ç—å");

    // –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç —Å –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è–º–∏: MM_BED_003-16-VelutaLux_07
    if (sku.startsWith("MM_")) {
      const parts = sku.split("_"); // ["MM","BED","003-16-VelutaLux","07"] –∏–ª–∏ ["MM","003-16-VelutaLux","07"]
      if (parts.length >= 4 && parts[1] === "BED") {
        const body = parts[2];
        const color = parts[3];
        sku = "MM.–ö—Ä–æ–≤–∞—Ç—å." + body + "." + color;
      } else if (parts.length >= 3 && parts[1] !== "–ö—Ä–æ–≤–∞—Ç—å") {
        const body = parts[1];
        const color = parts[2];
        sku = "MM.–ö—Ä–æ–≤–∞—Ç—å." + body + "." + color;
      }
    }

    return sku;
  }

  function updateWorkerButtonLabel() {
    if (!shiftLabelEl) return;

    // –¢–µ–∫—Å—Ç –º–µ–Ω—è–µ–º –≤ span#shiftInfo, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Ç–æ—á–∫—É-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä.
    if (!shiftInfoEl) return;

    if (workerScanMode === "waiting-worker") {
      shiftInfoEl.textContent = "–û—Ç–º–µ–Ω–∏—Ç—å";
    } else if (!currentWorkerId) {
      shiftInfoEl.textContent = "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞";
    } else {
      shiftInfoEl.textContent = "–°–º–µ–Ω–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞";
    }
  }

  if (shiftLabelEl) {
    shiftLabelEl.style.cursor = "pointer";
    shiftLabelEl.addEventListener("click", () => {
      if (workerScanMode === "waiting-worker") {
        // –æ—Ç–º–µ–Ω–∞ –æ–∂–∏–¥–∞–Ω–∏—è
        workerScanMode = "idle";
        if (workerScanHintEl) workerScanHintEl.textContent = "";
      } else {
        // –≤—Ö–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        workerScanMode = "waiting-worker";
        if (workerScanHintEl) {
          workerScanHintEl.textContent = "–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ W000.";
        }
      }
      updateWorkerButtonLabel();
    });
  }

  // helper –¥–ª—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏ –≤–Ω–∏–∑—É
  const scanDebug = document.createElement("div");
  scanDebug.style.position = "fixed";
  scanDebug.style.left = "8px";
  scanDebug.style.bottom = "6px";
  scanDebug.style.fontSize = "11px";
  scanDebug.style.color = "#6b7280";
  scanDebug.style.opacity = "0.8";
  scanDebug.style.pointerEvents = "none";
  scanDebug.style.zIndex = "9999";
  document.body.appendChild(scanDebug);

  async function startPackSession(workerId, sku) {
    const payload = {
      worker_id: workerId,
      // —á—Ç–æ–±—ã –±—ç–∫ –Ω–µ –ø–∞–¥–∞–ª –Ω–∞ None –∏ –º–æ–≥ –ø–æ–∫–∞–∑–∞—Ç—å –∏–º—è —Å—Ä–∞–∑—É
      worker_name: workerId,
      shift_label: "–°–º–µ–Ω–∞ –ê",
      // —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: –∫—Ç–æ-—Ç–æ –∂–¥—ë—Ç sku, –∫—Ç–æ-—Ç–æ product_code
      sku: sku,
      product_code: sku,
    };

    console.log("START SESSION:", payload);

    try {
      await fetch("/api/kiosk/session/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ /api/kiosk/session/start:", err);
    }
  }


    // –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏, –Ω–∞–±—Ä–∞–Ω–Ω–æ–π –≤ —Ä—É—Å—Å–∫–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ, –∫ –ª–∞—Ç–∏–Ω—Å–∫–æ–π (QWERTY ‚Üí –ô–¶–£–ö–ï–ù)
  function normalizeLayout(str) {
    const map = {
      '–π':'q','—Ü':'w','—É':'e','–∫':'r','–µ':'t','–Ω':'y','–≥':'u','—à':'i','—â':'o','–∑':'p','—Ö':'[','—ä':']',
      '—Ñ':'a','—ã':'s','–≤':'d','–∞':'f','–ø':'g','—Ä':'h','–æ':'j','–ª':'k','–¥':'l','–∂':';','—ç':'\'',
      '—è':'z','—á':'x','—Å':'c','–º':'v','–∏':'b','—Ç':'n','—å':'m','—é':'.','–±':',',
      '–ô':'Q','–¶':'W','–£':'E','–ö':'R','–ï':'T','–ù':'Y','–ì':'U','–®':'I','–©':'O','–ó':'P','–•':'{','–™':'}',
      '–§':'A','–´':'S','–í':'D','–ê':'F','–ü':'G','–†':'H','–û':'J','–õ':'K','–î':'L','–ñ':':','–≠':'"',
      '–Ø':'Z','–ß':'X','–°':'C','–ú':'V','–ò':'B','–¢':'N','–¨':'M','–Æ':'.','–ë':',',
    };
    return str.split("").map(ch => map[ch] || ch).join("");
  }

   async function handleScan(codeRaw) {
    // 1) –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É, —á—Ç–æ–±—ã –¶ ‚Üí W, –¨ ‚Üí M –∏ —Ç.–ø.
    const normalized = normalizeLayout(codeRaw || "");
    const code = normalized.trim();
    if (!code) return;

    scanDebug.textContent = "SCAN: " + code;   // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π
    console.log("SCAN RAW:", JSON.stringify(codeRaw));
    console.log("SCAN NORM:", JSON.stringify(code));

    // –¥–∞–ª—å—à–µ –≤—Å—è —Ç–≤–æ—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏–π


    // –†–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    if (workerScanMode === "waiting-worker") {
      // —Å—Ç—Ä–æ–≥–æ W + —Ü–∏—Ñ—Ä—ã
      // ‚úÖ –ê–≤—Ç–æ-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ë–ï–ó –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
    // –ï—Å–ª–∏ —Å–∫–∞–Ω–µ—Ä –ø—Ä–∏—Å–ª–∞–ª W123 ‚Äî —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º (–æ—á–µ–Ω—å —É–¥–æ–±–Ω–æ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ).
    if (/^W\d+$/.test(code)) {
      currentWorkerId = code;
      workerScanMode = "idle";

      if (workerScanHintEl) {
        workerScanHintEl.textContent = `–°–æ—Ç—Ä—É–¥–Ω–∏–∫ ${code} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –¢–µ–ø–µ—Ä—å —Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∫—Ä–æ–≤–∞—Ç—å.`;
      }
      updateWorkerButtonLabel();
      return;
    }
      currentWorkerId = code;
      workerScanMode = "idle";
      // –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–∏–º UI (–±–µ–∫ –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Å—Å–∏–∏)
      const wn = document.getElementById("workerName");
      if (wn) wn.textContent = code;
      if (workerScanHintEl) {
        workerScanHintEl.textContent = `–°–æ—Ç—Ä—É–¥–Ω–∏–∫ ${code} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –¢–µ–ø–µ—Ä—å —Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∫—Ä–æ–≤–∞—Ç–∏.`;
      }
      updateWorkerButtonLabel();
      return;
    }

    // –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —Å–∫–∞–Ω–∏—Ä—É—é—Ç –∫—Ä–æ–≤–∞—Ç—å
    if (!currentWorkerId) {
      if (workerScanHintEl) {
        workerScanHintEl.textContent = "–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–∫–Ω–æ–ø–∫–∞ —Å–≤–µ—Ä—Ö—É).";
      }
      console.warn("–°–∫–∞–Ω –∫—Ä–æ–≤–∞—Ç–∏ –±–µ–∑ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:", code);
      return;
    }

    const sku = normalizeSkuFromQr(code);
    if (!sku) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫–æ–¥ –∫—Ä–æ–≤–∞—Ç–∏ –∫ SKU:", code);
      return;
    }

    await startPackSession(currentWorkerId, sku);
  }

  // –°–∫–∞–Ω–µ—Ä –∫–∞–∫ HID-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞: –∫–æ–ø–∏–º –≤—Å—ë –¥–æ Enter
  document.addEventListener("keydown", (e) => {
    const tag = (e.target && e.target.tagName) || "";
    if (tag === "INPUT" || tag === "TEXTAREA") return;

    if (e.key === "Enter") {
      const code = scanBuffer;
      scanBuffer = "";
      if (code) {
        handleScan(code);
      }
      e.preventDefault();
      return;
    }

    if (e.key.length === 1) {
      scanBuffer += e.key;
    }
  });

  // –Ω–∞—á–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
  updateWorkerButtonLabel();
</script>
</body>
</html>
