<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∏–æ—Å–∫ —É–ø–∞–∫–æ–≤–∫–∏ –∫—Ä–æ–≤–∞—Ç–µ–π</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/static/kiosk.css" />
  <style>
    :root {
      --bg: #050816;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --error: #ef4444;
      --warn: #facc15;
      --warn-strong: #f97316;
      --accent-strong: #4ade80;
      --error-strong: #b91c1c;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --info: #38bdf8;
      --info-strong: #0ea5e9;
      --info-soft: rgba(56, 189, 248, 0.7);
      --info-bg: rgba(8, 47, 73, 0.85);
      --info-text: var(--info-text);
      --neutral-200: #e5e7eb;
      --success-text: #bbf7d0;
      --success-soft: #6ee7b7;
      --success-bg: rgba(22, 101, 52, 0.85);
      --danger-bg: rgba(127, 29, 29, 0.4);
      --danger-text: #fecaca;
      --danger-soft: #fca5a5;
      --neutral-700: #6b7280;
      --neutral-900: #020617;
      --neutral-950: #050816;
      --bg-top: #111827;
      --surface-panel-gradient-start: rgba(15, 23, 42, 0.96);
      --surface-panel-gradient-end: rgba(15, 23, 42, 0.9);
      --surface-panel-modal-start: rgba(15, 23, 42, 0.98);
      --surface-panel-modal-end: rgba(15, 23, 42, 0.92);
      --surface-panel-soft: rgba(15, 23, 42, 0.55);
      --surface-panel-ghost: rgba(15, 23, 42, 0.35);
      --surface-panel-strong: rgba(15, 23, 42, 0.9);
      --surface-slot: rgba(15, 23, 42, 0.6);
      --surface-panel-note: rgba(15, 23, 42, 0.4);
      --surface-deep: rgba(2, 6, 23, 0.55);
      --surface-deep-strong: rgba(2, 6, 23, 0.72);
      --surface-info-soft: rgba(8, 47, 73, 0.55);
      --surface-info-accent: rgba(14, 165, 233, 0.14);
      --surface-success: rgba(16, 185, 129, 0.15);
      --surface-warn: rgba(250, 204, 21, 0.14);
      --surface-error: rgba(239, 68, 68, 0.18);
      --surface-info-pill: rgba(56, 189, 248, 0.14);
      --surface-danger-pill: rgba(239, 68, 68, 0.16);
      --radius: 18px;
      --radius-sm: 10px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-pill: 999px;
      --radius-panel: 18px;
      --space-3xs: 2px;
      --space-2xs: 4px;
      --space-xs: 6px;
      --space-sm: 8px;
      --space-md: 10px;
      --space-lg: 12px;
      --space-xl: 14px;
      --space-2xl: 16px;
      --space-3xl: 18px;
      --space-4xl: 20px;
      --space-5xl: 22px;
      --space-6xl: 24px;
      --shadow-panel: 0 18px 40px rgba(0, 0, 0, 0.45);
      --shadow-soft: 0 10px 18px rgba(0, 0, 0, 0.55);
      --shadow-pill: 0 0 12px rgba(16, 185, 129, 0.18);
      --shadow-pill-danger: 0 0 12px rgba(239, 68, 68, 0.18);
      --shadow-pill-primary: 0 0 12px rgba(56, 189, 248, 0.18);
      --shadow-status: 0 0 6px var(--accent);
      --shadow-modal: 0 24px 60px rgba(0, 0, 0, 0.6);
      --shadow-slot-current: 0 0 18px rgba(56, 189, 248, 0.8);
      --shadow-step-current: 0 0 10px rgba(56, 189, 248, 0.6);
      --shadow-dot-info: 0 0 6px rgba(56, 189, 248, 0.9);
      --shadow-dot-danger: 0 0 6px var(--error);
      --border-default: 1px solid var(--border-soft);
      --border-pill: 1px solid rgba(148, 163, 184, 0.55);
      --border-accent: 1px solid rgba(16, 185, 129, 0.75);
      --border-warn: 1px solid rgba(250, 204, 21, 0.7);
      --border-error: 1px solid rgba(239, 68, 68, 0.8);
      --border-muted: 1px solid rgba(148, 163, 184, 0.35);
      --border-danger-soft: 1px solid rgba(239, 68, 68, 0.6);
      --border-badge: 1px solid rgba(148, 163, 184, 0.5);
      --border-success: 1px solid rgba(16, 185, 129, 0.6);
      --border-slot: 2px dashed rgba(148, 163, 184, 0.7);
      --border-muted-strong: 1px solid rgba(148, 163, 184, 0.6);
      --border-info-soft: 1px solid rgba(56, 189, 248, 0.35);
      --border-info-strong: 1px solid rgba(56, 189, 248, 0.8);
      --border-ghost: 1px solid rgba(148, 163, 184, 0.4);
      --dot-disabled: rgba(148, 163, 184, 0.6);
      --border-primary: 1px solid rgba(56, 189, 248, 0.75);
      --border-danger: 1px solid rgba(239, 68, 68, 0.75);
      --font-xs: 12px;
      --font-sm: 13px;
      --font-md: 14px;
      --font-lg: 16px;
      --font-xl: 18px;
      --font-2xl: 22px;
      --font-3xl: 26px;
      --font-4xl: 32px;
      --font-2xs: 11px;
      --size-pack-min: 280px;
      --size-events-min: 140px;
      --size-step-index: 26px;
      --size-catalog-min: 110px;
      --size-settings-label: 220px;
      --blur-md: 6px;
      --modal-max-width: 1400px;
      --debug-offset-x: 8px;
      --debug-offset-y: 6px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, var(--bg-top) 0, var(--neutral-900) 40%, var(--neutral-900) 100%);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: var(--space-2xl) var(--space-4xl);
      gap: var(--space-2xl);
    }

    /* –õ–û–ì–û–¢–ò–ü */

    .logo-bar {
      display: flex;
      align-items: center;
      padding: var(--space-2xs) var(--space-2xs) 0 var(--space-2xs);
      margin-bottom: var(--space-2xs);
    }

    .logo-img {
      height: calc(var(--space-6xl) + var(--space-2xs));
      opacity: 0.95;
      filter: drop-shadow(var(--shadow-soft));
    }

    .top-bar {
      display: grid;
      grid-template-columns: 1.3fr 1.3fr 1.4fr;
      gap: var(--space-2xl);
      align-items: stretch;
    }

    .panel {
      background: linear-gradient(145deg, var(--surface-panel-gradient-start), var(--surface-panel-gradient-end));
      border-radius: var(--radius-panel);
      border: var(--border-default);
      padding: var(--space-xl) var(--space-3xl);
      box-shadow: var(--shadow-panel);
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: -40%;
      opacity: 0.08;
      background:
        radial-gradient(circle at 0 0, var(--accent), transparent 55%),
        radial-gradient(circle at 100% 0, var(--info), transparent 55%);
      pointer-events: none;
    }

    .panel-header {
      position: relative;
      z-index: 1;
      margin-bottom: var(--space-sm);
    }

    .panel-body {
      position: relative;
      z-index: 1;
    }

    .panel-title {
      font-size: var(--font-sm);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: var(--space-sm);
    }

    .panel-title--compact {
      margin-bottom: var(--space-xs);
    }

    .panel-main {
      font-size: var(--font-2xl);
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-main--compact {
      margin-bottom: var(--space-2xs);
    }

    /* –¢–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ "–¢–µ–∫—É—â–∞—è –∫—Ä–æ–≤–∞—Ç—å": –¥–µ–ª–∞–µ–º SKU –æ–¥–Ω–æ–π –±–æ–ª—å—à–æ–π —Å—Ç—Ä–æ–∫–æ–π */
.bed-mainline {
  display: block;          /* –Ω–µ –ª–æ–º–∞–µ–º —Å–µ—Ç–∫—É, –ø—Ä–æ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ */
  font-size: var(--font-3xl);         /* –∫—Ä—É–ø–Ω–µ–µ, —á–µ–º –æ–±—ã—á–Ω—ã–π panel-main */
  font-weight: 700;
  line-height: 1.15;
}


    .panel-sub {
      font-size: var(--font-lg);
      color: var(--text-muted);
      margin-top: var(--space-2xs);
    }

    .badge {
      font-size: var(--font-sm);
      border-radius: var(--radius-pill);
      padding: var(--space-2xs) var(--space-md);
      border: var(--border-badge);
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .dot {
      width: var(--space-sm);
      height: var(--space-sm);
      border-radius: var(--radius-pill);
      background: var(--accent);
      box-shadow: var(--shadow-status);
    }

    .status-pill {
      font-size: var(--font-md);
      border-radius: var(--radius-pill);
      padding: var(--space-2xs) var(--space-lg);
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      font-weight: 500;
    }

    .status-ok {
      background: var(--surface-success);
      color: var(--success-soft);
      border: var(--border-success);
    }

    .status-warn {
      background: var(--surface-warn);
      color: var(--warn);
      border: var(--border-warn);
    }

    .status-error {
      background: var(--surface-error);
      color: var(--danger-soft);
      border: var(--border-error);
    }

    .timer {
      font-variant-numeric: tabular-nums;
      font-size: var(--font-3xl);
      font-weight: 600;
    }

    .timers {
      display: flex;
      gap: var(--space-2xl);
      margin-top: var(--space-xs);
      font-size: var(--font-sm);
    }

    .timer-chip {
      flex: 1;
      border-radius: var(--radius-pill);
      padding: var(--space-2xs) var(--space-md);
      border: var(--border-default);
      background: var(--surface-panel-strong);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-variant-numeric: tabular-nums;
    }

    .timer-chip-label {
      color: var(--text-muted);
    }

    .timer-chip-value {
      font-weight: 500;
    }

    .middle {
      display: grid;
      grid-template-columns: 3.2fr 1fr;
      gap: var(--space-2xl);
      flex: 1;
      min-height: 0;
    }

    .panel--camera {
      padding: var(--space-md);
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .camera-frame {
      position: relative;
      flex: 1;
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--neutral-900);
      border: var(--border-default);
    }

    .camera-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: brightness(0.95);
    }

    .camera-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .slot {
      position: absolute;
      border-radius: var(--radius-md);
      border: var(--border-slot);
      background: var(--surface-slot);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: var(--space-2xs);
      font-size: var(--font-xs);
      color: var(--text-muted);
      transition: all 0.2s ease-out;
    }

    .slot-title {
      font-weight: 500;
      margin-bottom: var(--space-3xs);
    }

    .slot-status {
      font-size: var(--font-2xs);
    }

    .slot.pending {
      opacity: 0.35;
      border-style: dashed;
    }

    .slot.current {
      opacity: 1;
      border-style: solid;
      border-color: var(--info);
      background: var(--info-bg);
      box-shadow: var(--shadow-slot-current);
      color: var(--info-text);
    }

    .slot.done {
      opacity: 0.9;
      border-style: solid;
      border-color: var(--accent);
      background: var(--success-bg);
      color: var(--success-text);
    }

    .slot.done .slot-status::before {
      content: "‚úî ";
    }

    .camera-caption {
      font-size: var(--font-sm);
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: var(--space-lg);
    }

    .camera-caption span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .panel--instruction {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: var(--space-3xl) var(--space-5xl);
    }

    .instruction-main {
      font-size: var(--font-4xl);
      font-weight: 700;
      margin-bottom: var(--space-sm);
    }

    .instruction-sub {
      font-size: var(--font-xl);
      color: var(--text-muted);
      margin-bottom: var(--space-3xl);
    }

    .instruction-extra {
      font-size: var(--font-lg);
      color: var(--text-muted);
    }

    .big-icon {
      font-size: calc(var(--font-4xl) + var(--space-2xs));
      margin-right: var(--space-md);
    }

    .panel--steps {
      padding: var(--space-2xl) var(--space-3xl);
      display: flex;
      flex-direction: column;
      gap: var(--space-2xl);
    }

    .progress-bar {
      width: 100%;
      height: var(--space-md);
      border-radius: var(--radius-pill);
      background: var(--neutral-900);
      overflow: hidden;
      border: var(--border-default);
    }

    .progress-fill {
      height: 100%;
      border-radius: var(--radius-pill);
      background: linear-gradient(90deg, var(--accent), var(--accent-strong));
      width: 0%;
      transition: width 0.25s ease-out;
    }

    .steps-list {
      margin-top: var(--space-xs);
      max-height: 100%;
      overflow: auto;
    }

    .step-row {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-xs) 0;
      font-size: var(--font-lg);
    }

    .step-index {
      width: var(--size-step-index);
      height: var(--size-step-index);
      border-radius: var(--radius-pill);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-sm);
      background: var(--neutral-900);
      border: var(--border-default);
      color: var(--text-muted);
    }

    .step-row.done .step-index {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--success-text);
    }

    .step-row.current .step-index {
      background: var(--info-strong);
      border-color: var(--info);
      color: var(--info-text);
      box-shadow: var(--shadow-step-current);
    }

    .step-title {
      font-weight: 500;
    }

    .step-meta {
      font-size: var(--font-sm);
      color: var(--text-muted);
    }

    .bottom {
      display: grid;
      grid-template-columns: 2.2fr 1.6fr;
      gap: var(--space-2xl);
      align-items: stretch;
    }

    .panel--events {
      padding: var(--space-md) var(--space-2xl);
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
      min-height: var(--size-events-min);
    }

    .events-list {
      font-size: var(--font-sm);
      flex: 1;
      overflow: hidden;
    }

    .event-row {
      display: flex;
      gap: var(--space-sm);
      padding: var(--space-3xs) 0;
      color: var(--text-muted);
    }

    .event-time {
      font-variant-numeric: tabular-nums;
      width: calc(var(--space-6xl) * 2 + var(--space-sm));
      color: var(--neutral-700);
    }

    .event-text {
      flex: 1;
    }

    .panel--stats {
      padding: var(--space-md) var(--space-2xl);
      font-size: var(--font-sm);
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
      min-height: var(--size-events-min);
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
    }

    .stats-label {
      color: var(--text-muted);
    }

    .stats-value {
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }

    .status-strip {
      position: fixed;
      inset-inline: 0;
      bottom: 0;
      height: var(--space-2xs);
      background: linear-gradient(90deg, var(--accent), var(--accent-strong));
      opacity: 0.9;
      transition: background 0.2s ease-out;
    }

    .status-strip.warn {
      background: linear-gradient(90deg, var(--warn), var(--warn-strong));
    }

    .status-strip.error {
      background: linear-gradient(90deg, var(--error), var(--error-strong));
    }

    /* –†—è–¥ –¥–ª—è –∫–Ω–æ–ø–æ–∫-–ø–∏–ª—é–ª—å. */
    .pill-row {
      margin-top: var(--space-md);
      display: flex;
      gap: var(--space-md);
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .pill-row--start {
      justify-content: flex-start;
    }

    /* –ë–∞–∑–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞-–ø–∏–ª—é–ª—è (–µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –ø–æ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º–µ). */
    .pill-btn {
      cursor: pointer;
      user-select: none;
      border-radius: var(--radius-pill);
      padding: var(--space-xs) var(--space-lg);
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--font-md);
      font-weight: 500;
      border: var(--border-pill);
      background: var(--surface-panel-soft);
      color: var(--text-main);
      transition: transform 0.06s ease, box-shadow 0.18s ease, border-color 0.18s ease, background 0.18s ease;
    }

    .pill-btn:active {
      transform: translateY(var(--space-3xs));
    }

    .pill-btn .dot {
      background: var(--neutral-200);
      box-shadow: none;
    }

    .pill-btn--active {
      background: var(--surface-success);
      border: var(--border-accent);
      box-shadow: var(--shadow-pill);
    }

    .pill-btn--active .dot {
      background: var(--accent);
      box-shadow: var(--shadow-status);
    }

    .pill-btn--disabled {
      opacity: 0.45;
      cursor: not-allowed;
      filter: grayscale(0.2);
      box-shadow: none;
    }

    .pill-btn--disabled .dot {
      background: var(--dot-disabled);
      box-shadow: none;
    }

    .pill-btn--ghost {
      opacity: 0.78;
      border-color: var(--border-ghost);
      background: var(--surface-panel-ghost);
    }

    .pill-btn--primary {
      background: var(--surface-info-pill);
      border: var(--border-primary);
      box-shadow: var(--shadow-pill-primary);
    }

    .pill-btn--primary .dot {
      background: var(--info);
      box-shadow: var(--shadow-dot-info);
    }

    .pill-btn--danger {
      background: var(--surface-danger-pill);
      border: var(--border-danger);
      box-shadow: var(--shadow-pill-danger);
    }

    .pill-btn--danger .dot {
      background: var(--error);
      box-shadow: var(--shadow-dot-danger);
    }

    .pill-btn--mini {
      padding: var(--space-2xs) var(--space-sm);
      font-size: var(--font-sm);
    }

    /* –ë–ª–æ–∫ –º–∞—Å—Ç–µ—Ä–∞: –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ + —Å–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞. */
    .master-status {
      font-size: var(--font-md);
      color: var(--text-muted);
      margin-top: var(--space-xs);
    }

    .master-hidden {
      display: none;
    }

    .panel--pack {
      padding: var(--space-xl) var(--space-3xl);
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
      width: 100%;
      min-width: var(--size-pack-min);
      flex: 1.4;
      min-height: 0;
    }

    .pack-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-md);
      align-items: center;
      justify-content: space-between;
    }

    .pack-main {
      font-size: var(--font-3xl);
      font-weight: 700;
    }

    .pack-hint {
      margin-top: var(--space-xs);
      font-size: var(--font-lg);
      color: var(--text-main);
    }

    .pack-state-chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-2xs) var(--space-md);
      border-radius: var(--radius-pill);
      border: var(--border-muted-strong);
      font-size: var(--font-sm);
      color: var(--text-muted);
    }

    .pack-meta {
      font-size: var(--font-md);
      color: var(--text-muted);
    }

    .pack-current-step {
      padding: var(--space-md) var(--space-lg);
      border-radius: var(--radius-md);
      border: var(--border-default);
      background: var(--surface-deep);
      display: flex;
      flex-direction: column;
      gap: var(--space-2xs);
    }

    .pack-current-step-title {
      font-size: var(--font-sm);
      color: var(--text-muted);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .pack-current-step-value {
      font-size: var(--font-xl);
      font-weight: 600;
    }

    .pack-available {
      font-size: var(--font-xs);
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: var(--space-2xs);
    }

    .pack-manual-note {
      border-radius: var(--radius-md);
      border: var(--border-muted);
      background: var(--surface-panel-note);
      padding: var(--space-sm) var(--space-md);
      font-size: var(--font-xs);
      color: var(--text-muted);
    }

    .manual-controls {
      display: none;
      flex-wrap: wrap;
      gap: var(--space-md);
    }

    .manual-controls.open {
      display: flex;
    }

    /* –í–ê–ñ–ù–û: —É–ø–∞–∫–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ –≤–∞–∂–Ω–µ–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
       –ü–æ—ç—Ç–æ–º—É —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –±–ª–æ–∫ –º–æ–∂–µ—Ç —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ,
       —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–ª –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Ç–µ–∫—É—â–∏–π —à–∞–≥. */
    .panel--pack {
      flex: 1 1 auto;
      min-height: 0;
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω–æ: –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –≤–∞–∂–Ω–µ–µ —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ,
       –ø–æ—ç—Ç–æ–º—É –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–æ—Å—Ç –ø–æ –≤—ã—Å–æ—Ç–µ –∏ –Ω–µ –¥–∞—ë–º –±–ª–æ–∫—É "—Ä–∞—Å–ø–æ–ª–∑–∞—Ç—å—Å—è". */
    .panel--steps {
      flex: 0 0 auto;
      min-height: calc(var(--space-6xl) + var(--space-2xs));
      max-height: calc(var(--space-6xl) + var(--space-4xl));
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏:
       –∑–∞–¥–∞—ë–º —É–ø—Ä–∞–≤–ª—è–µ–º—É—é flex-–æ—Å—å –∏ –≤—ã—Å–æ—Ç—É,
       —á—Ç–æ–±—ã —Ç–æ–ª—å–∫–æ "–£–ø–∞–∫–æ–≤–∫–∞" —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–∞—Å—å, –∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º–∏. */
    .right-column {
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
      min-height: 0;
      height: 100%;
    }

    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –±–ª–æ–∫ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è:
       –æ–Ω –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç, –Ω–æ –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–∞–±–∏—Ä–∞—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ. */
    .panel--shift-plan {
      flex: 0 0 auto;
    }

    /* –ë–ª–æ–∫ "–¢–µ–∫—É—â–∞—è –∫–æ–º–∞–Ω–¥–∞":
       –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–≥–æ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω–∫—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Å —É–ø–∞–∫–æ–≤–∫–æ–π. */
    .panel--instruction {
      flex: 0 0 auto;
    }

    .pack-steps-preview {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
      font-size: var(--font-md);
    }

    .pack-step-line {
      display: flex;
      justify-content: space-between;
      gap: var(--space-lg);
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-md);
      border: var(--border-default);
      background: var(--surface-deep);
    }

    .pack-step-line.current {
      border-color: var(--border-info-strong);
      background: var(--surface-info-soft);
      color: var(--info-text);
    }

    /* –ë–ª–æ–∫ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è: –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–≤–æ–¥–∞ –∏ —Å–ø–∏—Å–æ–∫ SKU. */
    .shift-plan-rename {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: var(--space-sm);
      align-items: center;
      margin-top: var(--space-xs);
    }

    .shift-plan-controls {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: var(--space-sm);
      align-items: center;
      margin-top: var(--space-xs);
    }

    .shift-plan-input {
      width: 100%;
      border-radius: var(--radius-sm);
      border: var(--border-default);
      background: var(--surface-deep);
      color: var(--text-main);
      padding: var(--space-xs) var(--space-sm);
      font-size: var(--font-sm);
    }

    .shift-plan-qty {
      max-width: calc(var(--space-6xl) * 2);
    }

    .shift-plan-catalog {
      margin-top: var(--space-sm);
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .shift-plan-catalog-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(var(--size-catalog-min), 1fr));
      gap: var(--space-xs);
      max-height: calc(var(--space-6xl) * 2);
      overflow: auto;
    }

    .shift-plan-catalog-list .pill-btn {
      justify-content: center;
    }

    .shift-plan-catalog-list .pill-btn:hover {
      border-color: var(--info-soft);
      color: var(--info-text);
    }

    .shift-plan-list {
      margin-top: var(--space-sm);
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
      max-height: calc(var(--space-6xl) * 3);
      overflow: auto;
    }

    .shift-plan-catalog-list {
      display: grid;
      grid-template-columns: 1fr auto auto auto auto auto;
      gap: var(--space-xs);
      align-items: center;
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
      border: var(--border-default);
      background: var(--surface-deep);
      font-size: var(--font-sm);
    }

    .shift-plan-row.selected {
      border-color: var(--info-soft);
      background: var(--surface-info-soft);
      color: var(--info-text);
    }

    

    /* –ë–ª–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫: –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –≤–µ—Ä—Å—Ç–∫—É. */
    .panel--settings {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .settings-row {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--font-md);
      color: var(--text-main);
    }

    .settings-hint {
      font-size: var(--font-xs);
      color: var(--text-muted);
    }

    .settings-row input[type="checkbox"] {
      width: var(--space-2xl);
      height: var(--space-2xl);
    }

    

    .shift-plan-modal-input {
      background: transparent;
      border: none;
      color: var(--info-text);
      font-size: var(--font-lg);
    }

    .shift-plan-modal-textarea {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--info-text);
      font-size: var(--font-md);
      resize: vertical;
    }

    .shift-plan-modal-hint {
      font-size: var(--font-sm);
      color: var(--text-muted);
    }

    .shift-plan-upload-box {
      flex-direction: column;
      align-items: stretch;
    }

    .pack-toast {
      margin-top: var(--space-sm);
      padding: var(--space-sm) var(--space-lg);
      border-radius: var(--radius-md);
      border: var(--border-danger-soft);
      background: var(--danger-bg);
      color: var(--danger-text);
      font-size: var(--font-md);
      display: none;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (–≤ —Å—Ç–∏–ª–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞) */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: var(--surface-deep-strong);
      backdrop-filter: blur(var(--blur-md));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: var(--space-5xl);
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      width: min(var(--modal-max-width), 96vw);
      border-radius: var(--radius-panel);
      border: var(--border-default);
      background: linear-gradient(145deg, var(--surface-panel-modal-start), var(--surface-panel-modal-end));
      box-shadow: var(--shadow-modal);
      padding: var(--space-3xl) var(--space-4xl);
      position: relative;
      overflow: hidden;
    }


    .modal::before {
      content: "";
      position: absolute;
      inset: -40%;
      opacity: 0.10;
      background:
        radial-gradient(circle at 0 0, var(--accent), transparent 55%),
        radial-gradient(circle at 100% 0, var(--info), transparent 55%);
      pointer-events: none;
    }

    .modal-content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }

    .modal-title {
      font-size: var(--font-sm);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .modal-main {
      font-size: var(--font-3xl);
      font-weight: 700;
      line-height: 1.15;
    }

    .modal-sub {
      font-size: var(--font-lg);
      color: var(--text-muted);
    }

    .modal-scan {
      margin-top: var(--space-2xs);
      border-radius: var(--radius-lg);
      border: var(--border-default);
      background: var(--surface-deep);
      padding: var(--space-lg) var(--space-xl);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-lg);
      font-variant-numeric: tabular-nums;
    }

    .modal-scan code {
      color: var(--info-text);
      font-size: var(--font-lg);
      background: var(--surface-info-accent);
      border: var(--border-info-soft);
      padding: var(--space-3xs) var(--space-sm);
      border-radius: var(--radius-sm);
    }

    .modal-actions {
      display: flex;
      gap: var(--space-md);
      flex-wrap: wrap;
      justify-content: flex-end;
      margin-top: var(--space-xs);
    }
 
  </style>
</head>
<body>
<div class="app">
  <div class="logo-bar">
    <!--<img src="/static/logo.png" class="logo-img" alt="–ù–æ–≤—ã–µ –º–µ–±–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏" /> -->
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏: –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç —Ü–µ–ª—ã–µ —ç–∫—Ä–∞–Ω—ã, –Ω–µ —Ç—Ä–æ–≥–∞—è –ª–æ–≥–∏–∫—É –¥–∞–Ω–Ω—ã—Ö. -->
  <div class="tabbar" id="mainTabbar">
    <div class="pill-btn tab tab--active" role="button" tabindex="0" data-screen="screenOperator">
      <span class="dot"></span>
      <span>–û–ø–µ—Ä–∞—Ç–æ—Ä</span>
    </div>
    <div class="pill-btn tab" role="button" tabindex="0" data-screen="screenQueue">
      <span class="dot"></span>
      <span>–û—á–µ—Ä–µ–¥—å</span>
    </div>
    <div class="pill-btn tab" role="button" tabindex="0" data-screen="screenManagement">
      <span class="dot"></span>
      <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
    </div>
    <div class="pill-btn tab" role="button" tabindex="0" data-screen="screenStats">
      <span class="dot"></span>
      <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
    </div>
  </div>

  <div class="container">
    <!-- –≠–∫—Ä–∞–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. -->
    <div class="screen" id="screenOperator" data-active="true">
      <div class="container">
        <!-- –¶–µ–Ω—Ç—Ä -->
        <div class="middle">
          <div class="panel panel--camera">
            <div class="panel-header">
              <div class="panel-title">–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª (–≤–∏–¥ —Å–≤–µ—Ä—Ö—É)</div>
            </div>
            <div class="panel-body">
              <div class="camera-frame">
                <img id="cameraImage" class="camera-image" src="" alt="–ü–æ—Ç–æ–∫ —Å –∫–∞–º–µ—Ä—ã" />
                <div id="cameraOverlay" class="camera-overlay"></div>
              </div>
              <div class="camera-caption">
                <span id="cameraHint">
                  –ó–æ–Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è: ~3.5‚Äì4.0√ó1.5 –º. –°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–≤–µ—Ç–∫–µ –¥–µ—Ç–∞–ª–µ–π –Ω–∞ —Å—Ç–æ–ª–µ.
                </span>
                <span id="workerStateLabel">–°–æ—Å—Ç–æ—è–Ω–∏–µ: ‚Äî</span>
              </div>
            </div>
          </div>

          <div class="right-column">
            <div class="panel panel--instruction">
              <div class="panel-header">
                <div class="panel-title">–¢–µ–∫—É—â–∞—è –∫–æ–º–∞–Ω–¥–∞</div>
              </div>
              <div class="panel-body">
                <div class="instruction-main">
                  <span class="big-icon">üõ†Ô∏è</span>
                  <span id="instructionMain">–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —É–ø–∞–∫–æ–≤–∫–∏‚Ä¶</span>
                </div>
                <div class="instruction-sub" id="instructionSub">
                  –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.
                </div>
                <div class="instruction-extra" id="instructionExtra">
                  –ì–æ–ª–æ—Å–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥—É–±–ª–∏—Ä—É—é—Ç —Ç–µ–∫—Å—Ç. –†–∞–±–æ—Ç–∞–π—Ç–µ –ø–æ –≥–æ–ª–æ—Å—É, –Ω–∞ —ç–∫—Ä–∞–Ω –ø–æ–≥–ª—è–¥—ã–≤–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
                </div>
              </div>
            </div>

            <div class="panel panel--pack">
              <div class="panel-header">
                <div class="panel-title">–£–ø–∞–∫–æ–≤–∫–∞</div>
              </div>
              <div class="panel-body">
                <div class="pack-row">
                  <div class="pack-main" id="packStateLabel">–°–æ—Å—Ç–æ—è–Ω–∏–µ: ‚Äî</div>
                  <div class="pack-state-chip">
                    <span class="dot"></span>
                    <span id="packPhaseLabel">–§–∞–∑–∞: ‚Äî</span>
                  </div>
                </div>
                <div class="pack-hint" id="packHint">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫—Ä–æ–≤–∞—Ç–∏ (SKU) –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.</div>

                <div class="pack-current-step">
                  <div class="pack-current-step-title">–¢–µ–∫—É—â–∏–π —à–∞–≥</div>
                  <div class="pack-current-step-value" id="packCurrentStep">‚Äî</div>
                </div>

                <div class="pack-available" id="packFlags">
                  <div>–î–æ—Å—Ç—É–ø–Ω–æ:</div>
                  <div>‚Ä¢ ‚Äî</div>
                </div>

                <div class="pack-manual-note">
                  <strong>–†—É—á–Ω–æ–π —Ä–µ–∂–∏–º:</strong> –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞.
                </div>

                <div class="pill-row pill-row--start">
                  <div id="btnManualToggle" class="pill-btn pill-btn--ghost" role="button" tabindex="0">
                    <span class="dot"></span>
                    <span>–†—É—á–Ω–æ–π —Ä–µ–∂–∏–º (—Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä)</span>
                  </div>
                </div>

                <div class="pill-row manual-controls" id="manualControls">
                  <div id="btnPackStart" class="pill-btn pill-btn--ghost" role="button" tabindex="0">
                    <span class="dot"></span>
                    <span>–°—Ç–∞—Ä—Ç SKU (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)</span>
                  </div>
                  <div id="btnPackStepComplete" class="pill-btn pill-btn--ghost" role="button" tabindex="0">
                    <span class="dot"></span>
                    <span>–®–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)</span>
                  </div>
                  <div id="btnPackPhaseNext" class="pill-btn pill-btn--ghost" role="button" tabindex="0">
                    <span class="dot"></span>
                    <span>–°–ª–µ–¥—É—é—â–∞—è —Ñ–∞–∑–∞ (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)</span>
                  </div>
                  <div id="btnPackCloseBox" class="pill-btn pill-btn--ghost" role="button" tabindex="0">
                    <span class="dot"></span>
                    <span>–ó–∞–∫—Ä—ã—Ç—å –∫–æ—Ä–æ–±–∫—É (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)</span>
                  </div>
                  <div id="btnPackPrintLabel" class="pill-btn pill-btn--ghost" role="button" tabindex="0">
                    <span class="dot"></span>
                    <span>–ü–µ—á–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏ (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)</span>
                  </div>
                  <div id="btnPackTableEmpty" class="pill-btn pill-btn--ghost" role="button" tabindex="0">
                    <span class="dot"></span>
                    <span>–°—Ç–æ–ª –ø—É—Å—Ç–æ–π (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)</span>
                  </div>
                </div>

                <div>
                  <div class="panel-title panel-title--compact">–ë–ª–∏–∂–∞–π—à–∏–µ —à–∞–≥–∏</div>
                  <div class="pack-steps-preview" id="packPlanPreview">
                    <div class="pack-step-line">
                      <span>–ü–ª–∞–Ω –≤—ã–∫–ª–∞–¥–∫–∏ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>
                      <span>‚Äî</span>
                    </div>
                  </div>
                  <div class="pack-toast" id="packToast"></div>
                </div>
              </div>
            </div>

            <div class="panel panel--steps">
              <div class="panel-header">
                <div class="panel-title">–ü—Ä–æ–≥—Ä–µ—Å—Å –∫–æ–º–ø–ª–µ–∫—Ç–∞</div>
              </div>
              <div class="panel-body">
                <div class="steps-summary-row">
                  <div id="stepsSummary">–®–∞–≥ 0 –∏–∑ 0</div>
                  <div class="text-muted-sm" id="stepsCounters">
                    0 –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ, 0 –æ—à–∏–±–æ–∫
                  </div>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="steps-list" id="stepsList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –æ—á–µ—Ä–µ–¥–∏: —Ä–∞–±–æ—Ç–∞ —Å–æ —Å–º–µ–Ω–Ω—ã–º –∑–∞–¥–∞–Ω–∏–µ–º –∏ SKU. -->
    <div class="screen" id="screenQueue" data-active="false">
      <div class="container">
        <div class="panel panel--shift-plan" id="shiftPlanCard">
          <div class="panel-header">
            <div class="panel-title">–°–º–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</div>
          </div>
          <div class="panel-body">
            <div class="pack-meta" id="shiftPlanName">–ü–ª–∞–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
            <div class="pack-meta" id="shiftPlanCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ SKU: ‚Äî</div>
            <div class="shift-plan-rename">
              <input id="shiftPlanRenameInput" class="shift-plan-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –¥–ª—è —Å–º–µ–Ω—ã" />
              <div id="btnShiftPlanRename" class="pill-btn" role="button" tabindex="0">
                <span class="dot"></span>
                <span>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</span>
              </div>
            </div>
            <div class="shift-plan-controls">
              <input id="shiftPlanSkuInput" class="shift-plan-input" list="shiftPlanSkuCatalog"
                     placeholder="SKU –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é" />
              <input id="shiftPlanQtyInput" class="shift-plan-input shift-plan-qty" type="number" min="1"
                     value="1" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" />
              <div id="btnShiftPlanAdd" class="pill-btn" role="button" tabindex="0">
                <span class="dot"></span>
                <span>–î–æ–±–∞–≤–∏—Ç—å</span>
              </div>
            </div>
            <div class="shift-plan-catalog">
              <input id="shiftPlanCatalogSearch" class="shift-plan-input"
                     placeholder="–ü–æ–∏—Å–∫ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ SKU" />
              <div class="shift-plan-catalog-list" id="shiftPlanCatalogList"></div>
            </div>
            <div class="pill-row pill-row--start">
              <div id="btnShiftPlanRemoveSelected" class="pill-btn" role="button" tabindex="0">
                <span class="dot"></span>
                <span>–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</span>
              </div>
              <div id="btnShiftPlanMoveUp" class="pill-btn" role="button" tabindex="0">
                <span class="dot"></span>
                <span>–í–≤–µ—Ä—Ö</span>
              </div>
              <div id="btnShiftPlanMoveDown" class="pill-btn" role="button" tabindex="0">
                <span class="dot"></span>
                <span>–í–Ω–∏–∑</span>
              </div>
              <div id="btnShiftPlanUpload" class="pill-btn" role="button" tabindex="0">
                <span class="dot"></span>
                <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫</span>
              </div>
              <div id="btnShiftPlanSelect" class="pill-btn" role="button" tabindex="0">
                <span class="dot"></span>
                <span>–í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞</span>
              </div>
            </div>
            <div class="pack-meta">–¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –Ω–∞ —Å–º–µ–Ω—É</div>
            <div class="shift-plan-list" id="shiftPlanList"></div>
            <datalist id="shiftPlanSkuCatalog"></datalist>
          </div>
        </div>
      </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: —Å–º–µ–Ω—ã, –º–∞—Å—Ç–µ—Ä –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. -->
    <div class="screen" id="screenManagement" data-active="false">
      <div class="container">
        <!-- –í–µ—Ä—Ö -->
        <div class="top-bar">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</div>
      </div>
      <div class="panel-body">
        <div class="panel-main">
          <span id="workerName">‚Äî</span>
          <span class="badge" id="shiftLabel">
            <span class="dot"></span>
            <span id="shiftInfo">–°–º–µ–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
          </span>
        </div>
        <div class="panel-sub" id="workerStats">
          –°–µ–≥–æ–¥–Ω—è: 0 –∫—Ä–æ–≤–∞—Ç–µ–π, –ø—Ä–æ—Å—Ç–æ–µ–≤ 0 –º–∏–Ω
        </div>
        <div class="panel-sub" id="workerScanHint"></div> <!-- –ù–û–í–ê–Ø –°–¢–†–û–ö–ê -->
        <!-- –°—Ç–∞—Ç—É—Å –º–∞—Å—Ç–µ—Ä–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –∫—Ç–æ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Ä—É—á–Ω—ã–º –¥–µ–π—Å—Ç–≤–∏—è–º. -->
        <div class="master-status" id="masterStatus">–ú–∞—Å—Ç–µ—Ä: ‚Äî</div>

        <div class="pill-row">
          <div id="btnAddWorker" class="pill-btn" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</span>
          </div>
          <div id="btnEndShift" class="pill-btn" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É</span>
          </div>
          <div id="btnMasterLogin" class="pill-btn" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–í–æ–π—Ç–∏ –∫–∞–∫ –º–∞—Å—Ç–µ—Ä</span>
          </div>
          <div id="btnMasterLogout" class="pill-btn master-hidden" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–í—ã–π—Ç–∏ (–º–∞—Å—Ç–µ—Ä)</span>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
  <div class="panel-header">
    <div class="panel-title">–¢–µ–∫—É—â–∞—è –∫—Ä–æ–≤–∞—Ç—å</div>
  </div>
  <div class="panel-body">

    <!-- –ë–æ–ª—å—à–∞—è —Å—Ç—Ä–æ–∫–∞: SKU -->
    <div class="panel-main bed-mainline">
      <span id="bedSkuBig">SKU ‚Äî</span>
    </div>

    <!-- –ü–æ—è—Å–Ω–µ–Ω–∏–µ + –¥–µ—Ç–∞–ª–∏ -->
    <div class="panel-sub" id="bedDetails">
      –ú–æ–¥–µ–ª—å ‚Äî | –†–∞–∑–º–µ—Ä ‚Äî | –¶–≤–µ—Ç ‚Äî
    </div>
  </div>
</div>


    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">–í—Ä–µ–º—è —É–ø–∞–∫–æ–≤–∫–∏</div>
      </div>
      <div class="panel-body">
        <div class="panel-main panel-main--compact">
          <span class="timer" id="sessionTimer">00:00</span>
          <span id="statusPill" class="status-pill status-warn">
            <span class="dot"></span>
            <span id="statusText">–û–∂–∏–¥–∞–Ω–∏–µ</span>
          </span>
        </div>
        <div class="timers">
          <div class="timer-chip">
            <span class="timer-chip-label">–†–∞–±–æ—Ç–∞</span>
            <span class="timer-chip-value" id="workTimer">00:00</span>
          </div>
          <div class="timer-chip">
            <span class="timer-chip-label">–ü—Ä–æ—Å—Ç–æ–π</span>
            <span class="timer-chip-value" id="idleTimer">00:00</span>
          </div>
        </div>
      </div>
    </div>
  </div>

        <div class="panel panel--settings" id="settingsCard">
          <div class="panel-header">
            <div class="panel-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ / –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          </div>
          <div class="panel-body">
            <div class="tabbar">
              <div class="pill-btn tab tab--active" role="button" tabindex="0">
                <span class="dot"></span>
                <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
              </div>
              <div class="pill-btn tab" role="button" tabindex="0">
                <span class="dot"></span>
                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
              </div>
            </div>
            <div class="settings-row">
              <input id="settingCanReorder" type="checkbox" />
              <label for="settingCanReorder">–û–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –ø–æ—Ä—è–¥–æ–∫ –æ—á–µ—Ä–µ–¥–∏</label>
            </div>
            <div class="settings-row">
              <input id="settingCanEditQty" type="checkbox" />
              <label for="settingCanEditQty">–û–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ SKU</label>
            </div>
            <div class="settings-row">
              <label for="settingMasterTimeout" class="settings-label">–¢–∞–π–º–∞—É—Ç –º–∞—Å—Ç–µ—Ä–∞ (–º–∏–Ω)</label>
              <input id="settingMasterTimeout" class="settings-input" type="number" min="1" max="240" value="15" />
            </div>
            <div class="pill-row pill-row--start">
              <div id="btnSettingsSave" class="pill-btn" role="button" tabindex="0">
                <span class="dot"></span>
                <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
              </div>
              <div id="btnMasterLogoutSettings" class="pill-btn master-hidden" role="button" tabindex="0">
                <span class="dot"></span>
                <span>–í—ã–π—Ç–∏ (–º–∞—Å—Ç–µ—Ä)</span>
              </div>
            </div>
            <div class="settings-hint" id="settingsHint">
              –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –º–∞—Å—Ç–µ—Ä—É. –ü–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ –º–∞—Å—Ç–µ—Ä.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: —Å–æ–±—ã—Ç–∏—è –∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏. -->
    <div class="screen" id="screenStats" data-active="false">
      <div class="container">
        <div class="bottom">
          <div class="panel panel--events">
            <div class="panel-header">
              <div class="panel-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</div>
            </div>
            <div class="panel-body">
              <div class="events-list" id="eventsList"></div>
            </div>
          </div>
          <div class="panel panel--stats">
            <div class="panel-header">
              <div class="panel-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É–ø–∞–∫–æ–≤–∫–µ —ç—Ç–æ–π –∫—Ä–æ–≤–∞—Ç–∏</div>
            </div>
            <div class="panel-body">
              <div class="stats-row">
                <span class="stats-label">–ü–æ—Å–ª–µ–¥–Ω—è—è —É–ø–∞–∫–æ–≤–∫–∞</span>
                <span class="stats-value" id="lastPack">‚Äî</span>
              </div>
              <div class="stats-row">
                <span class="stats-label">–õ—É—á—à–µ–µ –≤—Ä–µ–º—è</span>
                <span class="stats-value" id="bestPack">‚Äî</span>
              </div>
              <div class="stats-row">
                <span class="stats-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</span>
                <span class="stats-value" id="avgPack">‚Äî</span>
              </div>
              <div class="stats-note">
                –í—Ä–µ–º—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º —Å–µ—Å—Å–∏—è–º —É–ø–∞–∫–æ–≤–∫–∏ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏ (–ø–æ SKU).
              </div>
            </div>
          </div>
          <div class="steps-list" id="stepsList"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="statusStrip" class="status-strip"></div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Å–º–µ–Ω/–†–¶ -->
<div id="shiftModalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
    <div>
      <div class="modal-title" id="shiftModalTitle">–°–º–µ–Ω–∞</div>
      <div class="modal-sub" id="shiftModalSub">–ü—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.</div>
    </div>

    <div class="modal-scan">
      <div>
        –°–∫–∞–Ω: <code id="shiftModalScan">‚Äî</code>
      </div>
      <div id="shiftModalHint" class="modal-hint">–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶</div>
    </div>

    <div class="modal-actions" id="shiftModalActions"></div>

    <div class="modal-actions modal-actions--footer">
      <div id="shiftModalCancel" class="pill-btn pill-btn--ghost" role="button" tabindex="0">
        <span class="dot"></span>
        <span>–û–¢–ú–ï–ù–ê</span>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Å—Ç–∞—Ä—Ç–∞ —É–ø–∞–∫–æ–≤–∫–∏ –ø–æ SKU -->
<div id="packModalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div>
        <div class="modal-title">–°—Ç–∞—Ä—Ç —É–ø–∞–∫–æ–≤–∫–∏</div>
        <div class="modal-sub">–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ SKU –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —É–ø–∞–∫–æ–≤–∫–∏.</div>
      </div>
      <div class="modal-scan">
        <div class="modal-input-wrap">
          SKU: <input id="packModalSku" class="modal-input" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, SKU-1">
        </div>
        <div id="packModalHint" class="modal-hint">–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞‚Ä¶</div>
      </div>
      <div class="modal-actions" id="packModalActions"></div>
      <div class="modal-actions modal-actions--footer">
        <div id="packModalCancel" class="pill-btn pill-btn--ghost" role="button" tabindex="0">
          <span class="dot"></span>
          <span>–û–¢–ú–ï–ù–ê</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è -->
<div id="shiftPlanUploadBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div>
        <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è</div>
        <div class="modal-sub">–í—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ SKU –ø–æ—Å—Ç—Ä–æ—á–Ω–æ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.</div>
      </div>
      <div class="modal-scan shift-plan-upload-box">
        <input id="shiftPlanNameInput" class="shift-plan-modal-input" type="text"
               placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–º–µ–Ω–∞ –ê)">
        <textarea id="shiftPlanTextarea" class="shift-plan-modal-textarea" rows="6"
                  placeholder="SKU –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ"></textarea>
        <div id="shiftPlanUploadHint" class="shift-plan-modal-hint">–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞‚Ä¶</div>
      </div>
      <div class="modal-actions" id="shiftPlanUploadActions"></div>
      <div class="modal-actions modal-actions--footer">
        <div id="shiftPlanUploadCancel" class="pill-btn pill-btn--ghost" role="button" tabindex="0">
          <span class="dot"></span>
          <span>–û–¢–ú–ï–ù–ê</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è -->
<div id="shiftPlanSelectBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div>
        <div class="modal-title">–í—ã–±–æ—Ä —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è</div>
        <div class="modal-sub">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ —Ä–∞–Ω–µ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ SKU.</div>
      </div>
      <div class="modal-actions" id="shiftPlanSelectActions"></div>
      <div class="modal-actions modal-actions--footer">
        <div id="shiftPlanSelectCancel" class="pill-btn pill-btn--ghost" role="button" tabindex="0">
          <span class="dot"></span>
          <span>–û–¢–ú–ï–ù–ê</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –≤—Ö–æ–¥–∞ –º–∞—Å—Ç–µ—Ä–∞ -->
<div id="masterLoginBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div>
        <div class="modal-title">–í—Ö–æ–¥ –º–∞—Å—Ç–µ—Ä–∞</div>
        <div class="modal-sub">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –º–∞—Å—Ç–µ—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–∞ M########.</div>
      </div>
      <div class="modal-scan">
        <div class="modal-input-wrap">
          QR: <input id="masterLoginInput" class="modal-input" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, M13540876">
        </div>
        <div id="masterLoginHint" class="modal-hint">–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶</div>
      </div>
      <div class="modal-actions" id="masterLoginActions"></div>
      <div class="modal-actions modal-actions--footer">
        <div id="masterLoginCancel" class="pill-btn pill-btn--ghost" role="button" tabindex="0">
          <span class="dot"></span>
          <span>–û–¢–ú–ï–ù–ê</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const API_STATE_URL = "/api/kiosk/state";
  const API_PACK_UI_STATE_URL = "/api/kiosk/pack/ui-state";
  const API_PACK_STEPS_STATE_URL = "/api/kiosk/pack/steps/state";
  const SHIFT_PLAN_STORAGE_KEY = "kz_shift_plans";
  const SHIFT_PLAN_ACTIVE_KEY = "kz_shift_plan_active";

  function warnAboutMergeMarkers() {
    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ–º HTML –Ω–∞ –æ—Å—Ç–∞—Ç–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤.
     *
     * –ß—Ç–æ –¥–µ–ª–∞–µ–º:
     * - –∏—â–µ–º –ø–æ–¥—Å—Ç—Ä–æ–∫–∏ <<<<<<<, =======, >>>>>>> –≤ —Ç–µ–∫—Å—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
     * –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:
     * - —Ç–∞–∫–∏–µ –º–∞—Ä–∫–µ—Ä—ã –ª–æ–º–∞—é—Ç –≤–µ—Ä—Å—Ç–∫—É –∏ –≤–≤–æ–¥—è—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ;
     * - –º—ã –ª–∏—à—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º –≤ –∫–æ–Ω—Å–æ–ª–∏, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É UI.
     */
    const text = document.body ? (document.body.innerText || "") : "";
    if (text.includes("<<<<<<<") || text.includes("=======") || text.includes(">>>>>>>")) {
      console.warn("–í–Ω–∏–º–∞–Ω–∏–µ: –≤ DOM –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã merge. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ HTML.");
    }
  }

  let lastState = null;
  let timerStart = null;
  let workBase = 0;
  let idleBase = 0;
  let packUiState = null;
  let packStepsState = null;
  let shiftPlanSelected = null;
  let shiftPlanList = [];
  let shiftPlanSelectedSku = null;
  let manualModeEnabled = false;
  let shiftPlanCatalogFilter = "";

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∞–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –∏–∑ backend.
  // –ó–¥–µ—Å—å –¥–µ—Ä–∂–∏–º –∏—Ö –∫–∞–∫ –µ–¥–∏–Ω—ã–π –æ–±—ä–µ–∫—Ç, —á—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥–ª–∏ –æ–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ –Ω–∏—Ö.
  const operatorSettings = {
    operator_can_reorder: true,
    operator_can_edit_qty: true,
  };

  // –£—á–µ–±–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ SKU: –ø–æ–∫–∞ —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫,
  // –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ API –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è UI-–ª–æ–≥–∏–∫–∏.
  const SHIFT_PLAN_SKU_CATALOG = [
    "SKU-1",
    "SKU-2",
    "SKU-3",
    "SKU-DEFAULT",
  ];
  let btnPackStart = null;
  let btnPackStepComplete = null;
  let btnPackPhaseNext = null;
  let btnPackCloseBox = null;
  let btnPackPrintLabel = null;
  let btnPackTableEmpty = null;

  function pad(n) { return n.toString().padStart(2, "0"); }

  function formatDuration(seconds) {
    const s = Math.max(0, Math.floor(seconds));
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return pad(m) + ":" + pad(sec);
  }

  function setStatus(status) {
    const pill = document.getElementById("statusPill");
    const text = document.getElementById("statusText");
    const strip = document.getElementById("statusStrip");

    pill.classList.remove("status-ok", "status-warn", "status-error");
    strip.classList.remove("warn", "error");

    if (status === "running") {
      pill.classList.add("status-ok");
      text.textContent = "–ò–¥—ë—Ç —É–ø–∞–∫–æ–≤–∫–∞";
    } else if (status === "idle") {
      pill.classList.add("status-warn");
      strip.classList.add("warn");
      text.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ";
    } else if (status === "error") {
      pill.classList.add("status-error");
      strip.classList.add("error");
      text.textContent = "–û—à–∏–±–∫–∞";
    } else if (status === "done") {
      pill.classList.add("status-ok");
      text.textContent = "–ì–æ—Ç–æ–≤–æ";
    } else {
      pill.classList.add("status-warn");
      text.textContent = status || "–û–∂–∏–¥–∞–Ω–∏–µ";
    }
  }

  function renderOverlays(state) {
    const overlayEl = document.getElementById("cameraOverlay");
    overlayEl.innerHTML = "";
    const slots = state.overlay_slots || [];
    const rect = overlayEl.getBoundingClientRect();
    const W = rect.width || 1;
    const H = rect.height || 1;

    slots.forEach((slot) => {
      const div = document.createElement("div");
      div.className = "slot";

      const status = slot.status || "pending";
      div.classList.add(status);

      const x = (slot.x || 0) * W;
      const y = (slot.y || 0) * H;
      const w = (slot.w || 0.2) * W;
      const h = (slot.h || 0.15) * H;

      div.style.left = x + "px";
      div.style.top = y + "px";
      div.style.width = w + "px";
      div.style.height = h + "px";

      const title = document.createElement("div");
      title.className = "slot-title";
      title.textContent = slot.title || "";

      const statusEl = document.createElement("div");
      statusEl.className = "slot-status";
      statusEl.textContent =
        status === "done" ? "–ì–æ—Ç–æ–≤–æ" :
        status === "current" ? "–°–µ–π—á–∞—Å" :
        "–ü–æ –ø–ª–∞–Ω—É";

      div.appendChild(title);
      div.appendChild(statusEl);
      overlayEl.appendChild(div);
    });
  }

  function renderState(state) {
    lastState = state;

    // –ö–æ–º–∞–Ω–¥–∞ (–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–º–µ–Ω—ã)
    const active = state.active_workers || [];
    const byWorker = {};
    active.forEach((r) => {
      const wid = r.worker_id || "";
      const wc = (r.work_center || "").toUpperCase();
      if (!wid) return;
      byWorker[wid] = byWorker[wid] || new Set();
      if (wc) byWorker[wid].add(wc);
    });

    const workers = Object.keys(byWorker);
    if (workers.length === 0) {
      document.getElementById("workerName").textContent = "‚Äî";
    } else if (workers.length === 1) {
      const wid = workers[0];
      const num = wid.replace(/^W/i, "");
      const centers = Array.from(byWorker[wid]).join(", ");
      document.getElementById("workerName").textContent = `–°–æ—Ç—Ä—É–¥–Ω–∏–∫ ‚Ññ${num}`;
      if (workerScanHintEl) {
        workerScanHintEl.textContent = `–ê–∫—Ç–∏–≤–Ω—ã–π –†–¶: ${centers}`;
      }
    } else {
      const nums = workers.map(w => w.replace(/^W/i, "")).join(", ");
      document.getElementById("workerName").textContent = `–ö–æ–º–∞–Ω–¥–∞: ${nums}`;
    }

    // –†–µ–∂–∏–º –º–∞—Å—Ç–µ—Ä–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ID –∏ —É–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–æ–π –≤—ã—Ö–æ–¥–∞.
    // –≠—Ç–æ —á–∏—Å—Ç–æ UI-–ª–æ–≥–∏–∫–∞: —Ç–æ–ª—å–∫–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ, —á—Ç–æ –ø—Ä–∏—à–ª–æ –∏–∑ backend.
    const masterStatusEl = document.getElementById("masterStatus");
    const btnMasterLogout = document.getElementById("btnMasterLogout");
    const masterId = state.master_id || null;
    if (masterStatusEl) {
      masterStatusEl.textContent = masterId ? `–ú–∞—Å—Ç–µ—Ä: ${masterId}` : "–ú–∞—Å—Ç–µ—Ä: ‚Äî";
    }
    if (btnMasterLogout) {
      btnMasterLogout.classList.toggle("master-hidden", !masterId);
    }
    if (window.syncMasterState) {
      window.syncMasterState(masterId);
    }

    // –ö–Ω–æ–ø–∫–∏ —Å–º–µ–Ω—ã (–±–µ–ª–∞—è/–∑–µ–ª—ë–Ω–∞—è)
    setActionPillActive(btnAddWorker, !!state.shift_active);
    setActionPillActive(btnEndShift, !!state.shift_active);

    // –í –Ω–∞—á–∞–ª–µ —Å–º–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    if (!state.shift_active && !initialShiftModalShown) {
      initialShiftModalShown = true;
      openShiftModal("add");
    }

    document.getElementById("shiftInfo").textContent =
      state.shift_active ? "–°–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞" : (state.shift_label || "–°–º–µ–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞");
    document.getElementById("workerStats").textContent =
      state.worker_stats || "–°–µ–≥–æ–¥–Ω—è: 0 –∫—Ä–æ–≤–∞—Ç–µ–π, –ø—Ä–æ—Å—Ç–æ–µ–≤ 0 –º–∏–Ω";

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ö—Ä–æ–≤–∞—Ç—å: –∫—Ä—É–ø–Ω–æ SKU + —Å–Ω–∏–∑—É –ø–æ—è—Å–Ω–µ–Ω–∏–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// –ö–∞—Ä—Ç–∞ "–∫–æ–¥ –º–æ–¥–µ–ª–∏" -> "–Ω–∞–∑–≤–∞–Ω–∏–µ"
const BED_NAME_BY_PREFIX = {
  "001": "–°–æ–Ω–Ω–∞",
  "003": "–°–µ–Ω–Ω–∞",
};

// –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 —Ü–∏—Ñ—Ä—ã –∏–∑ SKU (–Ω–∞–ø—Ä–∏–º–µ—Ä "MM.–ö—Ä–æ–≤–∞—Ç—å.003-16-VelutaLux.07" -> "003")
function getModelPrefixFromSku(sku) {
  if (!sku) return "";
  const m = String(sku).match(/\b(\d{3})\b/); // –∏—â–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ —Å—Ç–æ—è—â–∏–µ 3 —Ü–∏—Ñ—Ä—ã
  return m ? m[1] : "";
}

// –ü–æ–ª—É—á–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è –∫—Ä–æ–≤–∞—Ç–∏ –ø–æ SKU
function getBedHumanName(sku) {
  const prefix = getModelPrefixFromSku(sku);
  return BED_NAME_BY_PREFIX[prefix] || "‚Äî";
}

const skuValue = state.bed_sku || "‚Äî";
const bedHumanName = getBedHumanName(skuValue);

// 1) –ö—Ä—É–ø–Ω–æ SKU
const skuBigEl = document.getElementById("bedSkuBig");
if (skuBigEl) {
  skuBigEl.textContent = "SKU " + skuValue;
}

// 2) –í–Ω–∏–∑—É: –ú–æ–¥–µ–ª—å + –¥–µ—Ç–∞–ª–∏ (—Ä–∞–∑–º–µ—Ä/—Ü–≤–µ—Ç/–≤–∏–¥ ‚Äî –∫–∞–∫ –æ—Ç–¥–∞—ë—Ç –±—ç–∫)
const detailsValue = state.bed_details || "–†–∞–∑–º–µ—Ä ‚Äî | –¶–≤–µ—Ç ‚Äî | –í–∏–¥ ‚Äî";
document.getElementById("bedDetails").textContent =
  "–ú–æ–¥–µ–ª—å " + bedHumanName + " | " + detailsValue;


    const status = state.status || "idle";
    setStatus(status);

    if (state.camera_stream_url) {
      const img = document.getElementById("cameraImage");
      const url = state.camera_stream_url;
      img.src = url.includes("?") ? url + "&t=" + Date.now() : url + "?t=" + Date.now();
    }
    const ws = state.worker_state || "idle";
    document.getElementById("workerStateLabel").textContent =
      "–°–æ—Å—Ç–æ—è–Ω–∏–µ: " + (ws === "working" ? "—Ä–∞–±–æ—Ç–∞" : ws === "idle" ? "–ø—Ä–æ—Å—Ç–æ–π" : ws);

    if (state.started_at_epoch) {
      timerStart = state.started_at_epoch * 1000;
    } else {
      timerStart = null;
      document.getElementById("sessionTimer").textContent = "00:00";
    }

    workBase = state.work_seconds || 0;
    idleBase = state.idle_seconds || 0;
    document.getElementById("workTimer").textContent =
      formatDuration(workBase);
    document.getElementById("idleTimer").textContent =
      formatDuration(idleBase);

    document.getElementById("instructionMain").textContent =
      state.instruction_main || "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —É–ø–∞–∫–æ–≤–∫–∏‚Ä¶";
    document.getElementById("instructionSub").textContent =
      state.instruction_sub ||
      "–ü—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫—Ä–æ–≤–∞—Ç–∏ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.";
    document.getElementById("instructionExtra").textContent =
      state.instruction_extra ||
      "–ì–æ–ª–æ—Å–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç —Ç–µ–∫—Å—Ç. –†–∞–±–æ—Ç–∞–π—Ç–µ –ø–æ –≥–æ–ª–æ—Å—É.";

    const currentStep = state.current_step_index || 0;
    const totalSteps = state.total_steps || 0;
    document.getElementById("stepsSummary").textContent =
      "–®–∞–≥ " + currentStep + " –∏–∑ " + totalSteps;
    document.getElementById("stepsCounters").textContent =
      (state.completed_steps || 0) +
      " –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ, " +
      (state.error_steps || 0) +
      " –æ—à–∏–±–æ–∫";

    const percent =
      totalSteps > 0 ? Math.round((currentStep / totalSteps) * 100) : 0;
    document.getElementById("progressFill").style.width = percent + "%";

    const stepsListEl = document.getElementById("stepsList");
    stepsListEl.innerHTML = "";
    if (state.steps && Array.isArray(state.steps)) {
      state.steps.forEach((step, idx) => {
        const row = document.createElement("div");
        row.className = "step-row";
        if (idx + 1 < currentStep) row.classList.add("done");
        if (idx + 1 === currentStep) row.classList.add("current");

        const indexEl = document.createElement("div");
        indexEl.className = "step-index";
        indexEl.textContent = idx + 1;

        const textWrap = document.createElement("div");
        const title = document.createElement("div");
        title.className = "step-title";
        title.textContent = step.title || "–®–∞–≥ " + (idx + 1);

        const meta = document.createElement("div");
        meta.className = "step-meta";
        meta.textContent = step.meta || "";

        textWrap.appendChild(title);
        textWrap.appendChild(meta);
        row.appendChild(indexEl);
        row.appendChild(textWrap);
        stepsListEl.appendChild(row);
      });
    }

    const eventsEl = document.getElementById("eventsList");
    eventsEl.innerHTML = "";
    if (state.events && Array.isArray(state.events)) {
      state.events.slice(-6).forEach((ev) => {
        const row = document.createElement("div");
        row.className = "event-row";

        const time = document.createElement("div");
        time.className = "event-time";
        time.textContent = ev.time || "";

        const txt = document.createElement("div");
        txt.className = "event-text";
        txt.textContent = ev.text || "";

        row.appendChild(time);
        row.appendChild(txt);
        eventsEl.appendChild(row);
      });
    }

    function fmtSec(v) {
      if (!v && v !== 0) return "‚Äî";
      return formatDuration(v);
    }
    document.getElementById("lastPack").textContent =
      fmtSec(state.last_pack_seconds);
    document.getElementById("bestPack").textContent =
      fmtSec(state.best_pack_seconds);
    document.getElementById("avgPack").textContent =
      fmtSec(state.avg_pack_seconds);

    renderOverlays(state);
  }

  function tickTimers() {
    if (!lastState) return;
    if (timerStart) {
      const diffSec = (Date.now() - timerStart) / 1000;
      document.getElementById("sessionTimer").textContent =
        formatDuration(diffSec);
    }
  }

  async function fetchState() {
    try {
      const resp = await fetch(API_STATE_URL, { cache: "no-store" });
      if (!resp.ok) return;
      const data = await resp.json();
      data.client_timestamp = Date.now() / 1000;
      renderState(data);
    } catch (e) {
      console.warn("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∏–æ—Å–∫–∞:", e);
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –£–ø–∞–∫–æ–≤–∫–∞: –æ—Ç–¥–µ–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ú—ã –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ —Ä–∞–∑–¥–µ–ª—è–µ–º –∑–∞–ø—Ä–æ—Å—ã:
  // 1) ui-state –¥–∞—ë—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ can_* —Ñ–ª–∞–≥–∏ (UI –Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ —Å–∞–º).
  // 2) steps/state –¥–∞—ë—Ç —Ñ–∞–∑—É –∏ —Ç–µ–∫—É—â–∏–π —à–∞–≥.
  // 3) plan –¥–∞—ë—Ç —Å–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.
  // –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–¥ –ø–æ–Ω—è—Ç–Ω—ã–º –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º: UI –ª–∏—à—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–æ, —á—Ç–æ —Ä–µ—à–∏–ª backend.
  async function fetchPackUiState() {
    try {
      const resp = await fetch(API_PACK_UI_STATE_URL, { cache: "no-store" });
      if (!resp.ok) {
        packUiState = null;
        renderPackUiState();
        return;
      }
      packUiState = await resp.json();
      renderPackUiState();
    } catch (e) {
      console.warn("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–ø–∞–∫–æ–≤–∫–∏:", e);
    }
  }

  async function fetchPackStepsState() {
    try {
      const resp = await fetch(API_PACK_STEPS_STATE_URL, { cache: "no-store" });
      if (!resp.ok) {
        packStepsState = null;
        renderPackStepsState();
        renderPackPlanPreview();
        return;
      }
      packStepsState = await resp.json();
      renderPackStepsState();
    } catch (e) {
      console.warn("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —à–∞–≥–æ–≤:", e);
    }
  }

  function loadShiftPlansFromStorage() {
    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞–Ω—ã –∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω –∏–∑ localStorage.
     *
     * –ó–∞—á–µ–º:
     * - –æ–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω —Ç–µ—Ä—è—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã;
     * - backend –ø–æ–∫–∞ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞;
     * - –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ UI –∏ –ª–µ–≥–∫–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –Ω–∞ API –ø–æ–∑–∂–µ.
     */
    try {
      const plansRaw = localStorage.getItem(SHIFT_PLAN_STORAGE_KEY) || "[]";
      const activeRaw = localStorage.getItem(SHIFT_PLAN_ACTIVE_KEY) || "0";
      const rawPlans = JSON.parse(plansRaw) || [];
      shiftPlanList = rawPlans.map((plan) => {
        const items = (plan.items || []).map((item) => {
          if (typeof item === "string") {
            return { sku: item, qty: 1 };
          }
          return { sku: item.sku, qty: item.qty || 1 };
        });
        return { id: plan.id, name: plan.name || "–°–º–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ", items };
      });
      const activeId = parseInt(activeRaw, 10);
      shiftPlanSelected = shiftPlanList.find((p) => p.id === activeId) || null;
    } catch (e) {
      shiftPlanList = [];
      shiftPlanSelected = null;
    }
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  function saveShiftPlansToStorage() {
    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞–Ω—ã –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ.
     *
     * –≠—Ç–æ –±–∞–∑–æ–≤–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ UI –Ω–µ "–∑–∞–±—ã–≤–∞–µ—Ç" —Å–ø–∏—Å–æ–∫ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏,
     * –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ—Ç—å –∏–ª–∏ backend –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.
     */
    localStorage.setItem(SHIFT_PLAN_STORAGE_KEY, JSON.stringify(shiftPlanList || []));
    localStorage.setItem(SHIFT_PLAN_ACTIVE_KEY, String(shiftPlanSelected ? shiftPlanSelected.id : 0));
  }

  function renderPackUiState() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä—É —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–ø–∞–∫–æ–≤–∫–∏ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º can_* —Ñ–ª–∞–≥–∏ –≤ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫.
    // –í–∞–∂–Ω–æ: –ø—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –≤ UI, –º—ã —Ç–æ–ª—å–∫–æ –¥–æ–≤–µ—Ä—è–µ–º backend.
    const label = document.getElementById("packStateLabel");
    const phaseLabel = document.getElementById("packPhaseLabel");
    const flagsLabel = document.getElementById("packFlags");
    const hintLabel = document.getElementById("packHint");
    if (!label || !phaseLabel) return;

    const active = packUiState && packUiState.active_session;
    const state = packUiState && packUiState.pack_state;
    const phase = active && active.phase ? active.phase : null;
    const stateMap = {
      started: "–í –†–ê–ë–û–¢–ï",
      box_closed: "–ö–û–†–û–ë–ö–ê –ó–ê–ö–†–´–¢–ê",
      label_printed: "–≠–¢–ò–ö–ï–¢–ö–ê –ù–ê–ü–ï–ß–ê–¢–ê–ù–ê",
      table_empty: "–°–¢–û–õ –ü–£–°–¢–û–ô",
    };
    const phaseMap = {
      LAYOUT: "–≤—ã–∫–ª–∞–¥–∫–∞",
      PACKING: "—É–ø–∞–∫–æ–≤–∫–∞",
    };
    label.textContent = "–°–æ—Å—Ç–æ—è–Ω–∏–µ: " + (stateMap[state] || "‚Äî");
    phaseLabel.textContent = "–§–∞–∑–∞: " + (phaseMap[phase] || "‚Äî");

    if (hintLabel) {
      hintLabel.textContent = active
        ? "–°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º. –ö–Ω–æ–ø–∫–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è."
        : "–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫—Ä–æ–≤–∞—Ç–∏ (SKU) –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.";
    }

    const canStart = packUiState && packUiState.can_start_sku;
    const canClose = packUiState && packUiState.can_close_box;
    const canPrint = packUiState && packUiState.can_print_label;
    const canTableEmpty = packUiState && packUiState.can_mark_table_empty;

    if (flagsLabel) {
      const available = [];
      if (canStart) available.push("–°—Ç–∞—Ä—Ç SKU");
      if (canClose) available.push("–ó–∞–∫—Ä—ã—Ç—å –∫–æ—Ä–æ–±–∫—É");
      if (canPrint) available.push("–ü–µ—á–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏");
      if (canTableEmpty) available.push("–°—Ç–æ–ª –ø—É—Å—Ç–æ–π");

      const lines = available.length ? available : ["‚Äî"];
      flagsLabel.innerHTML = `
        <div>–î–æ—Å—Ç—É–ø–Ω–æ:</div>
        ${lines.map(item => `<div>‚Ä¢ ${item}</div>`).join("")}
      `;
    }

    setActionPillDisabled(btnPackStart, !canStart);
    setActionPillDisabled(btnPackCloseBox, !canClose);
    setActionPillDisabled(btnPackPrintLabel, !canPrint);
    setActionPillDisabled(btnPackTableEmpty, !canTableEmpty);

    const hasSession = !!active;
    setActionPillDisabled(btnPackStepComplete, !hasSession);
    setActionPillDisabled(btnPackPhaseNext, !hasSession);
  }

  function renderPackStepsState() {
    // –°–≤–æ–¥–∫–∞ —à–∞–≥–∞ –∏ —Ç–µ–∫—É—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –±–µ—Ä—É—Ç—Å—è –∏–∑ backend, —á—Ç–æ–±—ã UI –Ω–µ –æ—à–∏–±—Å—è —Å –ª–æ–≥–∏–∫–æ–π.
    const currentStep = document.getElementById("packCurrentStep");
    if (!currentStep) return;

    if (!packStepsState || !packStepsState.phase) {
      currentStep.textContent = "‚Äî";
      return;
    }

    const step = packStepsState.current_step;
    if (!step) {
      currentStep.textContent = "‚Äî";
      return;
    }
    currentStep.textContent = step.slot + " ‚Äî " + step.part_code;
  }

  function renderPackPlanPreview() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 1‚Äì2 –±–ª–∏–∂–∞–π—à–∏—Ö —à–∞–≥–∞, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–µ–ª "—á—Ç–æ –¥–∞–ª—å—à–µ",
    // –Ω–æ –Ω–µ —É—Ç–æ–ø–∞–ª –≤ –¥–ª–∏–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ –∏ –Ω–µ —Ç–µ—Ä—è–ª —Ñ–æ–∫—É—Å –Ω–∞ —Ç–µ–∫—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.
    // –ü–ª–∞–Ω –Ω–µ –º–µ–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ, –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ–º –µ–≥–æ –∏–∑ backend –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥.
    const list = document.getElementById("packPlanPreview");
    if (!list) return;
    list.innerHTML = "";

    if (!shiftPlanSelected || !shiftPlanSelected.items || !shiftPlanSelected.items.length) {
      const empty = document.createElement("div");
      empty.className = "pack-step-line";
      empty.innerHTML = "<span>–ü–ª–∞–Ω –≤—ã–∫–ª–∞–¥–∫–∏ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span><span>‚Äî</span>";
      list.appendChild(empty);
      return;
    }

    const preview = shiftPlanSelected.items.slice(0, 3);
    preview.forEach((item, idx) => {
      const row = document.createElement("div");
      row.className = "pack-step-line";
      if (idx === 0) row.classList.add("current");
      row.innerHTML = `<span>${item.sku}</span><span>√ó${item.qty}</span>`;
      list.appendChild(row);
    });
  }

  function renderShiftPlanPanel() {
    /**
     * –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è.
     * –ó–¥–µ—Å—å –º—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ –ø–ª–∞–Ω, –∏ —Å–∫–æ–ª—å–∫–æ SKU –≤ –Ω—ë–º.
     */
    const nameEl = document.getElementById("shiftPlanName");
    const countEl = document.getElementById("shiftPlanCount");
    const renameInput = document.getElementById("shiftPlanRenameInput");
    if (!nameEl || !countEl) return;

    if (!shiftPlanSelected) {
      nameEl.textContent = "–ü–ª–∞–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω";
      countEl.textContent = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ SKU: ‚Äî";
      if (renameInput) {
        renameInput.value = "";
        renameInput.placeholder = "–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –¥–ª—è —Å–º–µ–Ω—ã";
      }
      renderShiftPlanList([]);
      updateShiftPlanControlsAvailability();
      return;
    }

    const totalCount = shiftPlanSelected.items.reduce((sum, item) => sum + item.qty, 0);
    nameEl.textContent = `–í—ã–±—Ä–∞–Ω –ø–ª–∞–Ω: ${shiftPlanSelected.name}`;
    countEl.textContent = `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ SKU: ${totalCount}`;
    if (renameInput) {
      renameInput.value = shiftPlanSelected.name;
    }
    renderShiftPlanList(shiftPlanSelected.items);
    updateShiftPlanControlsAvailability();
  }

  function renderShiftPlanList(items) {
    /**
     * –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ SKU –Ω–∞ —Å–º–µ–Ω—É.
     * –ó–¥–µ—Å—å –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ.
     */
    const listEl = document.getElementById("shiftPlanList");
    if (!listEl) return;
    listEl.innerHTML = "";

    if (!items || !items.length) {
      const empty = document.createElement("div");
      empty.className = "pack-meta";
      empty.textContent = "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –ú–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é.";
      listEl.appendChild(empty);
      return;
    }

    items.forEach((item) => {
      const row = document.createElement("div");
      row.className = "shift-plan-row";
      if (shiftPlanSelectedSku === item.sku) {
        row.classList.add("selected");
      }

      const skuEl = document.createElement("div");
      skuEl.textContent = item.sku;
      skuEl.addEventListener("click", () => {
        shiftPlanSelectedSku = item.sku;
        renderShiftPlanList(items);
      });

      const qtyEl = document.createElement("div");
      qtyEl.textContent = `√ó${item.qty}`;

      const minusBtn = document.createElement("div");
      minusBtn.className = "pill-btn pill-btn--ghost pill-btn--mini";
      minusBtn.textContent = "‚àí";
      if (!operatorSettings.operator_can_edit_qty) {
        minusBtn.classList.add("pill-btn--disabled");
      }
      minusBtn.addEventListener("click", () => {
        if (!operatorSettings.operator_can_edit_qty) {
          showPackToast("–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–∫–ª—é—á–µ–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –º–∞—Å—Ç–µ—Ä–∞.");
          return;
        }
        updateShiftPlanQty(item.sku, -1);
      });

      const plusBtn = document.createElement("div");
      plusBtn.className = "pill-btn pill-btn--ghost pill-btn--mini";
      plusBtn.textContent = "+";
      if (!operatorSettings.operator_can_edit_qty) {
        plusBtn.classList.add("pill-btn--disabled");
      }
      plusBtn.addEventListener("click", () => {
        if (!operatorSettings.operator_can_edit_qty) {
          showPackToast("–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–∫–ª—é—á–µ–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –º–∞—Å—Ç–µ—Ä–∞.");
          return;
        }
        updateShiftPlanQty(item.sku, 1);
      });

      const deleteBtn = document.createElement("div");
      deleteBtn.className = "pill-btn pill-btn--danger pill-btn--mini";
      deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
      deleteBtn.addEventListener("click", () => removeSkuFromShiftPlan(item.sku));

      const runBtn = document.createElement("div");
      runBtn.className = "pill-btn pill-btn--primary pill-btn--mini";
      runBtn.textContent = "–ó–∞–ø—É—Å—Ç–∏—Ç—å";
      if (!manualModeEnabled) {
        runBtn.classList.add("pill-btn--disabled");
      } else {
        runBtn.addEventListener("click", () => startSkuFromPlan(item.sku));
      }

      row.appendChild(skuEl);
      row.appendChild(qtyEl);
      row.appendChild(minusBtn);
      row.appendChild(plusBtn);
      row.appendChild(deleteBtn);
      row.appendChild(runBtn);
      listEl.appendChild(row);
    });

    updateShiftPlanControlsAvailability();
  }

  function applyOperatorSettings(settings) {
    /**
     * –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∞–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–∑ backend.
     *
     * –ü–æ—á–µ–º—É –¥–µ–ª–∞–µ–º —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π:
     * - kiosk.js –ø–æ–ª—É—á–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –∏—Ö —Å—é–¥–∞;
     * - UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ –∏ –±–µ–∑ –¥—É–±–ª–µ–π –ª–æ–≥–∏–∫–∏.
     */
    if (typeof settings?.operator_can_reorder === "boolean") {
      operatorSettings.operator_can_reorder = settings.operator_can_reorder;
    }
    if (typeof settings?.operator_can_edit_qty === "boolean") {
      operatorSettings.operator_can_edit_qty = settings.operator_can_edit_qty;
    }
    if (shiftPlanSelected) {
      renderShiftPlanList(shiftPlanSelected.items);
    }
    updateShiftPlanControlsAvailability();
  }

  function updateShiftPlanControlsAvailability() {
    /**
     * –£–ø—Ä–∞–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –∫–Ω–æ–ø–æ–∫ –æ—á–µ—Ä–µ–¥–∏.
     *
     * –ü—Ä–∏–Ω—Ü–∏–ø:
     * - –ø–æ—Ä—è–¥–æ–∫ (–≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑) –∑–∞–≤–∏—Å–∏—Ç –æ—Ç operator_can_reorder;
     * - –ø–ª—é—Å/–º–∏–Ω—É—Å –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ renderShiftPlanList.
     */
    const hasSelection = !!shiftPlanSelectedSku;
    const reorderAllowed = operatorSettings.operator_can_reorder && hasSelection;
    if (btnShiftPlanMoveUp) {
      setActionPillDisabled(btnShiftPlanMoveUp, !reorderAllowed);
    }
    if (btnShiftPlanMoveDown) {
      setActionPillDisabled(btnShiftPlanMoveDown, !reorderAllowed);
    }
  }

  // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≤–Ω–µ—à–Ω–µ–º—É —Å–∫—Ä–∏–ø—Ç—É kiosk.js.
  // –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –º—ã —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI.
  window.applyOperatorSettings = applyOperatorSettings;

  function renderShiftPlanCatalog() {
    /**
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–∂–∏–≤–æ–π" –∫–∞—Ç–∞–ª–æ–≥ SKU —Å —Ñ–∏–ª—å—Ç—Ä–æ–º.
     *
     * –ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É:
     * - –±—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –ø–æ –∫–ª–∏–∫—É;
     * - –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫, –∞ –Ω–µ —Å–∫—Ä—ã—Ç—ã–π –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫;
     * - –ø–æ–∏—Å–∫ –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –≤—Ä–µ–º–µ–Ω–∏.
     */
    const listEl = document.getElementById("shiftPlanCatalogList");
    if (!listEl) return;
    listEl.innerHTML = "";

    const filter = (shiftPlanCatalogFilter || "").toLowerCase();
    const visibleItems = SHIFT_PLAN_SKU_CATALOG.filter((sku) => {
      return !filter || sku.toLowerCase().includes(filter);
    });

    if (!visibleItems.length) {
      const empty = document.createElement("div");
      empty.className = "pack-meta";
      empty.textContent = "–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
      listEl.appendChild(empty);
      return;
    }

    visibleItems.forEach((sku) => {
      const item = document.createElement("div");
      item.className = "pill-btn pill-btn--ghost pill-btn--mini";
      item.textContent = sku;
      item.addEventListener("click", () => {
        if (shiftPlanSkuInput) {
          shiftPlanSkuInput.value = sku;
          if (shiftPlanQtyInput) {
            shiftPlanQtyInput.focus();
          }
        }
      });
      listEl.appendChild(item);
    });
  }

  function updateShiftPlanQty(sku, delta) {
    /**
     * –ú–µ–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ SKU –≤ —Å–ø–∏—Å–∫–µ.
     * –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω—É–ª–µ–≤—ã–º ‚Äî —É–¥–∞–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é, —á—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –±—ã–ª —á–∏—Å—Ç—ã–º.
     */
    if (!shiftPlanSelected) return;
    const item = shiftPlanSelected.items.find((it) => it.sku === sku);
    if (!item) return;
    item.qty = Math.max(0, item.qty + delta);
    if (item.qty === 0) {
      shiftPlanSelected.items = shiftPlanSelected.items.filter((it) => it.sku !== sku);
      if (shiftPlanSelectedSku === sku) {
        shiftPlanSelectedSku = null;
      }
    }
    saveShiftPlansToStorage();
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  function removeSkuFromShiftPlan(sku) {
    /**
     * –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ–º SKU –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∞.
     *
     * –ü–æ—á–µ–º—É –æ—Ç–¥–µ–ª—å–Ω–æ:
     * - –æ–ø–µ—Ä–∞—Ç–æ—Ä –æ–∂–∏–¥–∞–µ—Ç —è–≤–Ω—É—é –∫–Ω–æ–ø–∫—É "–£–¥–∞–ª–∏—Ç—å";
     * - —Ç–∞–∫ –ø—Ä–æ—â–µ –æ–±—ä—è—Å–Ω–∏—Ç—å, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é,
     *   –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∫–æ–ª–æ–Ω–∫–µ "√ó".
     */
    if (!shiftPlanSelected) return;
    shiftPlanSelected.items = shiftPlanSelected.items.filter((item) => item.sku !== sku);
    if (shiftPlanSelectedSku === sku) {
      shiftPlanSelectedSku = null;
    }
    saveShiftPlansToStorage();
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  function renameShiftPlan() {
    /**
     * –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω.
     *
     * –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:
     * - –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –≤–∞–∂–Ω–æ –≤–∏–¥–µ—Ç—å –ø–æ–Ω—è—Ç–Ω–æ–µ –∏–º—è ("–°–º–µ–Ω–∞ –ê", "–ù–æ—á—å");
     * - —Ç–∞–∫ –ø—Ä–æ—â–µ –≤—ã–±–∏—Ä–∞—Ç—å –ø–ª–∞–Ω –∏–∑ —Å–ø–∏—Å–∫–∞, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö —Å–º–µ–Ω–∞—Ö.
     */
    if (!shiftPlanSelected) {
      showPackToast("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω, –∑–∞—Ç–µ–º –∑–∞–¥–∞–π—Ç–µ –µ–º—É –∏–º—è.");
      return;
    }
    const nextName = (shiftPlanRenameInput.value || "").trim();
    if (!nextName) {
      showPackToast("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.");
      return;
    }
    shiftPlanSelected.name = nextName;
    saveShiftPlansToStorage();
    renderShiftPlanPanel();
  }

  function addSkuToShiftPlan() {
    /**
     * –î–æ–±–∞–≤–ª—è–µ–º SKU –≤ –∞–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω.
     * –ï—Å–ª–∏ –ø–ª–∞–Ω –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–≥ —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ä–∞–∑—É.
     */
    const sku = (shiftPlanSkuInput.value || "").trim();
    const qty = Math.max(1, parseInt(shiftPlanQtyInput.value || "1", 10));
    if (!sku) {
      showPackToast("–í—ã–±–µ—Ä–∏—Ç–µ SKU –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.");
      return;
    }

    if (!shiftPlanSelected) {
      const newPlan = {
        id: Date.now(),
        name: "–°–º–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ",
        items: [],
      };
      shiftPlanList.unshift(newPlan);
      shiftPlanSelected = newPlan;
    }

    const existing = shiftPlanSelected.items.find((item) => item.sku === sku);
    if (existing) {
      existing.qty += qty;
    } else {
      shiftPlanSelected.items.push({ sku, qty });
    }

    shiftPlanSkuInput.value = "";
    shiftPlanQtyInput.value = "1";
    saveShiftPlansToStorage();
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  function removeSelectedSkuFromShiftPlan() {
    /**
     * –£–¥–∞–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –∏–∑ –ø–ª–∞–Ω–∞.
     * –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–≥ –±—ã—Å—Ç—Ä–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –±–µ–∑ –º–æ–¥–∞–ª–∫–∏.
     */
    if (!shiftPlanSelected || !shiftPlanSelectedSku) {
      showPackToast("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –≤ —Å–ø–∏—Å–∫–µ, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å.");
      return;
    }
    shiftPlanSelected.items = shiftPlanSelected.items.filter((item) => item.sku !== shiftPlanSelectedSku);
    shiftPlanSelectedSku = null;
    saveShiftPlansToStorage();
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  function moveSelectedSku(direction) {
    /**
     * –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π SKU –≤–≤–µ—Ä—Ö –∏–ª–∏ –≤–Ω–∏–∑ –≤ –æ—á–µ—Ä–µ–¥–∏.
     *
     * –ü–æ—á–µ–º—É —ç—Ç–æ –Ω—É–∂–Ω–æ:
     * - –æ–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã;
     * - –¥–≤–∏–∂–µ–Ω–∏–µ —Å—Ç—Ä–æ–≥–æ –Ω–∞ –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫.
     */
    if (!operatorSettings.operator_can_reorder) {
      showPackToast("–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –º–∞—Å—Ç–µ—Ä–∞.");
      return;
    }
    if (!shiftPlanSelected || !shiftPlanSelectedSku) {
      showPackToast("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –≤ —Å–ø–∏—Å–∫–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫.");
      return;
    }
    const items = shiftPlanSelected.items;
    const index = items.findIndex((item) => item.sku === shiftPlanSelectedSku);
    if (index < 0) return;
    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= items.length) {
      showPackToast("–î–∞–ª—å—à–µ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –Ω–µ–ª—å–∑—è.");
      return;
    }
    const [moved] = items.splice(index, 1);
    items.splice(newIndex, 0, moved);
    saveShiftPlansToStorage();
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  function initShiftPlanCatalog() {
    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ SKU –ª–æ–∫–∞–ª—å–Ω—ã–º –∫–∞—Ç–∞–ª–æ–≥–æ–º.
     * –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ä–∞: –ø–æ–∑–∂–µ –∫–∞—Ç–∞–ª–æ–≥ –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ API –±–µ–∑ —Å–º–µ–Ω—ã UI.
     */
    const dataList = document.getElementById("shiftPlanSkuCatalog");
    if (!dataList) return;
    dataList.innerHTML = "";
    SHIFT_PLAN_SKU_CATALOG.forEach((sku) => {
      const option = document.createElement("option");
      option.value = sku;
      dataList.appendChild(option);
    });
    renderShiftPlanCatalog();
  }

  async function startSkuFromPlan(sku) {
    /**
     * –ó–∞–ø—É—Å–∫ SKU –∏–∑ —Å–ø–∏—Å–∫–∞ ‚Äî —Ç–æ–ª—å–∫–æ –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞.
     * –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —á—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –æ—Ç—Ä–∞–∂–∞–ª –ø—Ä–æ–≥—Ä–µ—Å—Å.
     */
    if (!manualModeEnabled) return;
    const ok = await handlePackAction("/api/kiosk/pack/start", { sku });
    if (ok) {
      updateShiftPlanQty(sku, -1);
      showPackToast(`SKU ${sku} –∑–∞–ø—É—â–µ–Ω. –û—á–µ—Ä–µ–¥—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞.`);
    }
  }

  function renderShiftPlanSelectActions() {
    /**
     * –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ –≤ –≤–∏–¥–µ –∫–Ω–æ–ø–æ–∫.
     * –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å –ø–ª–∞–Ω –±—ã—Å—Ç—Ä–æ, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ä–º –≤–≤–æ–¥–∞.
     */
    shiftPlanSelectActions.innerHTML = "";

    if (!shiftPlanList.length) {
      shiftPlanSelectActions.appendChild(mkModalBtn("–ü–ª–∞–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", "primary", () => {}));
      return;
    }

    shiftPlanList.forEach((plan) => {
      const totalCount = plan.items.reduce((sum, item) => sum + item.qty, 0);
      shiftPlanSelectActions.appendChild(
        mkModalBtn(`${plan.name} (${totalCount} SKU)`, "success", async () => {
          selectShiftPlan(plan.id);
          closeShiftPlanSelectModal();
        })
      );
    });
  }

  function parseShiftPlanText(text) {
    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ SKU –≤ –º–∞—Å—Å–∏–≤ –ø–æ–∑–∏—Ü–∏–π —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º.
     * –ï—Å–ª–∏ SKU –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, —Å—É–º–º–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–µ–ª –∏—Ç–æ–≥.
     */
    const lines = text.split("\n").map((line) => line.trim()).filter(Boolean);
    const map = new Map();
    lines.forEach((sku) => {
      const count = map.get(sku) || 0;
      map.set(sku, count + 1);
    });
    return Array.from(map.entries()).map(([sku, qty]) => ({ sku, qty }));
  }

  function uploadShiftPlan(text, name) {
    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–º–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –≤ backend.
     * –ó–¥–µ—Å—å —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã –æ–Ω –Ω–µ —Ç–µ—Ä—è–ª—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
     */
    const items = parseShiftPlanText(text);
    if (!items.length) {
      showPackToast("–°–ø–∏—Å–æ–∫ SKU –ø—É—Å—Ç. –ü–ª–∞–Ω –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.");
      return;
    }

    const planName = (name || "–°–º–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ").trim();
    if (shiftPlanSelected) {
      shiftPlanSelected.name = planName;
      shiftPlanSelected.items = items;
      shiftPlanSelectedSku = null;
    } else {
      const newPlan = {
        id: Date.now(),
        name: planName,
        items,
      };
      shiftPlanList.unshift(newPlan);
      shiftPlanSelected = newPlan;
      shiftPlanSelectedSku = null;
    }

    saveShiftPlansToStorage();
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  function selectShiftPlan(planId) {
    /**
     * –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞ –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ UI.
     * –£–ø–∞–∫–æ–≤–æ—á–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è QR –∏ FSM.
     */
    shiftPlanSelected = shiftPlanList.find((plan) => plan.id === planId) || null;
    shiftPlanSelectedSku = null;
    saveShiftPlansToStorage();
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  async function handlePackAction(url, body) {
    /**
     * –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–∑–æ–≤ —É–ø–∞–∫–æ–≤–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.
     *
     * –ü–æ—á–µ–º—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true/false:
     * - —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç UI –ø–æ–Ω—è—Ç—å, –±—ã–ª–æ –ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ —É—Å–ø–µ—à–Ω—ã–º;
     * - –≤ —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö "–ó–∞–ø—É—Å—Ç–∏—Ç—å SKU" –º–æ–∂–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å,
     *   –Ω–µ —É–¥–∞–ª—è—è —Å—Ç—Ä–æ–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ backend.
     */
    try {
      const resp = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: body ? JSON.stringify(body) : null,
      });
      if (!resp.ok) {
        const detail = await resp.json().catch(() => ({}));
        showPackToast(detail.detail || "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ.");
        return false;
      }
      await refreshPackData();
      return true;
    } catch (e) {
      showPackToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.");
      return false;
    }
  }

  async function refreshPackData() {
    // –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º UI: —Å–æ—Å—Ç–æ—è–Ω–∏—è, —à–∞–≥–∏ –∏ –ø–ª–∞–Ω.
    await fetchPackUiState();
    await fetchPackStepsState();
    loadShiftPlansFromStorage();
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –°–∫–∞–Ω–µ—Ä, —Å–º–µ–Ω—ã –∏ —Ä–∞–±–æ—á–∏–µ —Ü–µ–Ω—Ç—Ä—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  let scanBuffer = "";

  // UI —ç–ª–µ–º–µ–Ω—Ç—ã
  const workerScanHintEl = document.getElementById("workerScanHint");
  const btnAddWorker = document.getElementById("btnAddWorker");
  const btnEndShift = document.getElementById("btnEndShift");

  // –ú–æ–¥–∞–ª–∫–∞
  const modalBackdrop = document.getElementById("shiftModalBackdrop");
  const modalTitleEl = document.getElementById("shiftModalTitle");
  const modalSubEl = document.getElementById("shiftModalSub");
  const modalCancelEl = document.getElementById("shiftModalCancel");
  const modalScanEl = document.getElementById("shiftModalScan");
  const modalHintEl = document.getElementById("shiftModalHint");
  const modalActionsEl = document.getElementById("shiftModalActions");

  // –ú–æ–¥–∞–ª–∫–∞ —É–ø–∞–∫–æ–≤–∫–∏: –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤–≤–æ–¥ SKU, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–µ–ª —è–≤–Ω—ã–π —Å—Ç–∞—Ä—Ç.
  const packModalBackdrop = document.getElementById("packModalBackdrop");
  const packModalSku = document.getElementById("packModalSku");
  const packModalHint = document.getElementById("packModalHint");
  const packModalCancel = document.getElementById("packModalCancel");
  const packModalActions = document.getElementById("packModalActions");

  // –ú–æ–¥–∞–ª–∫–∏ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏ –≤—ã–±–æ—Ä –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö.
  const shiftPlanUploadBackdrop = document.getElementById("shiftPlanUploadBackdrop");
  const shiftPlanNameInput = document.getElementById("shiftPlanNameInput");
  const shiftPlanTextarea = document.getElementById("shiftPlanTextarea");
  const shiftPlanUploadHint = document.getElementById("shiftPlanUploadHint");
  const shiftPlanUploadActions = document.getElementById("shiftPlanUploadActions");
  const shiftPlanUploadCancel = document.getElementById("shiftPlanUploadCancel");

  const shiftPlanSelectBackdrop = document.getElementById("shiftPlanSelectBackdrop");
  const shiftPlanSelectActions = document.getElementById("shiftPlanSelectActions");
  const shiftPlanSelectCancel = document.getElementById("shiftPlanSelectCancel");

  let modalOpen = false;
  let modalMode = "add"; // "add" | "end"
  let modalWorkerId = null;
  let initialShiftModalShown = false;

  let packModalOpen = false;
  let shiftPlanUploadOpen = false;
  let shiftPlanSelectOpen = false;

  // —Ñ–æ—Ä–º–∞—Ç QR –∫—Ä–æ–≤–∞—Ç–∏:

  // —Ñ–æ—Ä–º–∞—Ç QR –∫—Ä–æ–≤–∞—Ç–∏:
  //   MM.BED.003-16-VelutaLux.07
  //   –∏–ª–∏ MM.–ö—Ä–æ–≤–∞—Ç—å.003-16-VelutaLux.07
  function normalizeSkuFromQr(raw) {
    let sku = (raw || "").trim();
    if (!sku) return "";

    // BED -> –ö—Ä–æ–≤–∞—Ç—å
    sku = sku.replace("BED", "–ö—Ä–æ–≤–∞—Ç—å");

    // –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç —Å –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è–º–∏: MM_BED_003-16-VelutaLux_07
    if (sku.startsWith("MM_")) {
      const parts = sku.split("_"); // ["MM","BED","003-16-VelutaLux","07"] –∏–ª–∏ ["MM","003-16-VelutaLux","07"]
      if (parts.length >= 4 && parts[1] === "BED") {
        const body = parts[2];
        const color = parts[3];
        sku = "MM.–ö—Ä–æ–≤–∞—Ç—å." + body + "." + color;
      } else if (parts.length >= 3 && parts[1] !== "–ö—Ä–æ–≤–∞—Ç—å") {
        const body = parts[1];
        const color = parts[2];
        sku = "MM.–ö—Ä–æ–≤–∞—Ç—å." + body + "." + color;
      }
    }

    return sku;
  }

  function setActionPillActive(el, active) {
    if (!el) return;
    el.classList.toggle("pill-btn--active", !!active);
  }

  function setActionPillDisabled(el, disabled) {
    if (!el) return;
    el.classList.toggle("pill-btn--disabled", !!disabled);
    el.setAttribute("aria-disabled", disabled ? "true" : "false");
  }

  function showPackToast(message) {
    const toast = document.getElementById("packToast");
    if (!toast) return;
    toast.textContent = message;
    toast.style.display = "block";
    setTimeout(() => {
      toast.style.display = "none";
    }, 4000);
  }

  // –î–µ–ª–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–º –≤–Ω–µ—à–Ω–µ–º—É —Å–∫—Ä–∏–ø—Ç—É,
  // —á—Ç–æ–±—ã kiosk.js –º–æ–≥ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –µ–¥–∏–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.
  window.showPackToast = showPackToast;

  function openShiftModal(mode) {
    modalMode = mode || "add";
    modalWorkerId = null;
    modalOpen = true;
    modalBackdrop.classList.add("open");
    modalBackdrop.setAttribute("aria-hidden", "false");

    modalScanEl.textContent = "‚Äî";
    modalHintEl.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶";
    modalActionsEl.innerHTML = "";

    if (modalMode === "add") {
      modalTitleEl.textContent = "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞";
      modalSubEl.textContent = "–ü—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—á–∏–π —Ü–µ–Ω—Ç—Ä.";
    } else {
      modalTitleEl.textContent = "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É";
      modalSubEl.textContent = "–ü—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ —á—Ç–æ –∑–∞–∫—Ä—ã—Ç—å.";
    }
  }

  function closeShiftModal() {
    modalOpen = false;
    modalBackdrop.classList.remove("open");
    modalBackdrop.setAttribute("aria-hidden", "true");
    modalWorkerId = null;
  }

  function openPackModal() {
    /**
     * –ú–æ–¥–∞–ª–∫–∞ —Å—Ç–∞—Ä—Ç–∞ —É–ø–∞–∫–æ–≤–∫–∏.
     *
     * –ó–∞—á–µ–º:
     * - –æ–ø–µ—Ä–∞—Ç–æ—Ä —è–≤–Ω–æ –≤–≤–æ–¥–∏—Ç SKU –∏ –≤–∏–¥–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ;
     * - –º—ã –Ω–µ –ø—ã—Ç–∞–µ–º—Å—è "—É–≥–∞–¥—ã–≤–∞—Ç—å" SKU –≤ UI, —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –≤ backend.
     */
    packModalOpen = true;
    packModalBackdrop.classList.add("open");
    packModalBackdrop.setAttribute("aria-hidden", "false");
    packModalHint.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞‚Ä¶";
    packModalSku.value = "";
    packModalActions.innerHTML = "";

    const btnStart = mkModalBtn("–ó–∞–ø—É—Å—Ç–∏—Ç—å —É–ø–∞–∫–æ–≤–∫—É", "success", async () => {
      const sku = (packModalSku.value || "").trim();
      if (!sku) {
        packModalHint.textContent = "–í–≤–µ–¥–∏—Ç–µ SKU –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º.";
        return;
      }
      await handlePackAction("/api/kiosk/pack/start", { sku });
      closePackModal();
    });
    packModalActions.appendChild(btnStart);
    packModalSku.focus();
  }

  function closePackModal() {
    packModalOpen = false;
    packModalBackdrop.classList.remove("open");
    packModalBackdrop.setAttribute("aria-hidden", "true");
  }

  function openShiftPlanUploadModal() {
    /**
     * –ú–æ–¥–∞–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è.
     *
     * –°–ø–∏—Å–æ–∫ SKU –∑–∞–¥–∞—ë—Ç—Å—è –ø–æ—Å—Ç—Ä–æ—á–Ω–æ, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–≥ –≤—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ
     * –∏–∑ Excel/—Ç–∞–±–ª–∏—Ü—ã –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
     */
    shiftPlanUploadOpen = true;
    shiftPlanUploadBackdrop.classList.add("open");
    shiftPlanUploadBackdrop.setAttribute("aria-hidden", "false");
    if (shiftPlanSelected) {
      shiftPlanNameInput.value = shiftPlanSelected.name;
      shiftPlanTextarea.value = shiftPlanSelected.items
        .flatMap((item) => Array(item.qty).fill(item.sku))
        .join("\n");
    } else {
      shiftPlanNameInput.value = "";
      shiftPlanTextarea.value = "";
    }
    shiftPlanUploadHint.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞‚Ä¶";
    shiftPlanUploadActions.innerHTML = "";

    const btnUpload = mkModalBtn("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫", "success", async () => {
      const text = (shiftPlanTextarea.value || "").trim();
      if (!text) {
        shiftPlanUploadHint.textContent = "–°–ø–∏—Å–æ–∫ SKU –ø—É—Å—Ç. –í—Å—Ç–∞–≤—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Å—Ç—Ä–æ—á–Ω–æ.";
        return;
      }
      const name = (shiftPlanNameInput.value || "").trim();
      uploadShiftPlan(text, name);
      closeShiftPlanUploadModal();
    });
    shiftPlanUploadActions.appendChild(btnUpload);
    shiftPlanTextarea.focus();
  }

  function closeShiftPlanUploadModal() {
    shiftPlanUploadOpen = false;
    shiftPlanUploadBackdrop.classList.remove("open");
    shiftPlanUploadBackdrop.setAttribute("aria-hidden", "true");
  }

  function openShiftPlanSelectModal() {
    /**
     * –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞.
     *
     * –ú—ã –≤—ã–≤–æ–¥–∏–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–ª–∞–Ω—ã –∫–∞–∫ –Ω–∞–±–æ—Ä –∫–Ω–æ–ø–æ–∫,
     * —á—Ç–æ–±—ã –≤—ã–±–æ—Ä –∑–∞–Ω–∏–º–∞–ª 1‚Äì2 –∫–ª–∏–∫–∞ –∏ –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª –≤–≤–æ–¥–∞.
     */
    shiftPlanSelectOpen = true;
    shiftPlanSelectBackdrop.classList.add("open");
    shiftPlanSelectBackdrop.setAttribute("aria-hidden", "false");
    renderShiftPlanSelectActions();
  }

  function closeShiftPlanSelectModal() {
    shiftPlanSelectOpen = false;
    shiftPlanSelectBackdrop.classList.remove("open");
    shiftPlanSelectBackdrop.setAttribute("aria-hidden", "true");
  }

function mkModalBtn(text, kind, onClick) {
  /**
   * –ú—ã —Ö–æ—Ç–∏–º –ï–î–ò–ù–´–ô —Å—Ç–∏–ª—å –ø–æ –≤—Å–µ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É.
   * –ü–æ—ç—Ç–æ–º—É –∫–Ω–æ–ø–∫–∏ –≤ –º–æ–¥–∞–ª–∫–µ –¥–µ–ª–∞–µ–º –∫–∞–∫ "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞":
   * - —Ñ–æ—Ä–º–∞ "–ø–∏–ª—é–ª—è"
   * - —Å–ª–µ–≤–∞ —Ç–æ—á–∫–∞-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
   */

  const b = document.createElement("div");

  // –ë–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å ‚Äî pill-btn (–∫–∞–∫ –≤ –≤–µ—Ä—Ö–Ω–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ)
  b.className = "pill-btn";

  // –î–æ–±–∞–≤–∏–º "—Ç–∏–ø" –∫–Ω–æ–ø–∫–∏ (–æ—Å–Ω–æ–≤–Ω–∞—è/–æ–ø–∞—Å–Ω–∞—è).
  // kind –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ "success" / "danger" / "primary".
  if (kind === "danger") b.classList.add("pill-btn--danger");
  if (kind === "primary" || kind === "success") b.classList.add("pill-btn--primary");

  // –í–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏ –¥–µ–ª–∞–µ–º —Ç–æ—á–∫—É + —Ç–µ–∫—Å—Ç (–∫–∞–∫ –≤–µ–∑–¥–µ)
  b.innerHTML = `<span class="dot"></span><span>${text}</span>`;

  // –ß—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ "–Ω–∞—Å—Ç–æ—è—â–µ–π" –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
  b.setAttribute("role", "button");
  b.setAttribute("tabindex", "0");

  // –ö–ª–∏–∫
  b.addEventListener("click", onClick);

  return b;
}


  async function apiShiftAdd(workerId, workCenter) {
    await fetch("/api/kiosk/shift/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ worker_id: workerId, work_center: workCenter }),
    });
  }

  async function apiShiftEnd(workerId, centersOrNull) {
    await fetch("/api/kiosk/shift/end", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ worker_id: workerId, work_centers: centersOrNull || null }),
    });
  }

  function getWorkerCentersFromState(workerId) {
    const list = (lastState && lastState.active_workers) ? lastState.active_workers : [];
    const w = String(workerId || "").trim();
    return list.filter(x => (x.worker_id || "") === w).map(x => (x.work_center || "").toUpperCase());
  }

  function renderModalActions() {
    modalActionsEl.innerHTML = "";
    if (!modalWorkerId) {
      modalActionsEl.appendChild(mkModalBtn("–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", "primary", () => {}));
      return;
    }

    if (modalMode === "add") {
      modalActionsEl.appendChild(mkModalBtn("–£–ü–ê–ö–û–í–ö–ê", "success", async () => {
        await apiShiftAdd(modalWorkerId, "–£–ü–ê–ö–û–í–ö–ê");
        modalHintEl.textContent = `–ì–æ—Ç–æ–≤–æ: ${modalWorkerId} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –£–ü–ê–ö–û–í–ö–ê. –ú–æ–∂–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–π –†–¶.`;
        modalWorkerId = null;
        modalScanEl.textContent = "‚Äî";
        renderModalActions();
        fetchState();
      }));
      modalActionsEl.appendChild(mkModalBtn("–£–ö–û–ú–ü–õ–ï–ö–¢–û–í–ö–ê", "success", async () => {
        await apiShiftAdd(modalWorkerId, "–£–ö–û–ú–ü–õ–ï–ö–¢–û–í–ö–ê");
        modalHintEl.textContent = `–ì–æ—Ç–æ–≤–æ: ${modalWorkerId} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –£–ö–û–ú–ü–õ–ï–ö–¢–û–í–ö–ê. –ú–æ–∂–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–π –†–¶.`;
        modalWorkerId = null;
        modalScanEl.textContent = "‚Äî";
        renderModalActions();
        fetchState();
      }));
      return;
    }

    // end
    const centers = getWorkerCentersFromState(modalWorkerId);
    if (!centers.length) {
      modalHintEl.textContent = `–£ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ${modalWorkerId} –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã.`;
      modalWorkerId = null;
      modalScanEl.textContent = "‚Äî";
      return;
    }

    if (centers.length > 1) {
      modalActionsEl.appendChild(mkModalBtn("–ó–∞–∫—Ä—ã—Ç—å –û–ë–ê –†–¶", "danger", async () => {
        await apiShiftEnd(modalWorkerId, null);
        modalHintEl.textContent = `–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞: ${modalWorkerId} (–æ–±–∞ –†–¶).`;
        modalWorkerId = null;
        modalScanEl.textContent = "‚Äî";
        renderModalActions();
        fetchState();
      }));
    }
    centers.forEach((c) => {
      modalActionsEl.appendChild(mkModalBtn(`–ó–∞–∫—Ä—ã—Ç—å ${c}`, "danger", async () => {
        await apiShiftEnd(modalWorkerId, [c]);
        modalHintEl.textContent = `–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞: ${modalWorkerId} (${c}).`;
        modalWorkerId = null;
        modalScanEl.textContent = "‚Äî";
        renderModalActions();
        fetchState();
      }));
    });
  }

  if (btnAddWorker) {
    btnAddWorker.addEventListener("click", () => openShiftModal("add"));
  }
  if (btnEndShift) {
    btnEndShift.addEventListener("click", () => openShiftModal("end"));
  }
  if (modalCancelEl) {
    modalCancelEl.addEventListener("click", () => closeShiftModal());
  }
  if (packModalCancel) {
    packModalCancel.addEventListener("click", () => closePackModal());
  }
  if (shiftPlanUploadCancel) {
    shiftPlanUploadCancel.addEventListener("click", () => closeShiftPlanUploadModal());
  }
  if (shiftPlanSelectCancel) {
    shiftPlanSelectCancel.addEventListener("click", () => closeShiftPlanSelectModal());
  }

  btnPackStart = document.getElementById("btnPackStart");
  btnPackStepComplete = document.getElementById("btnPackStepComplete");
  btnPackPhaseNext = document.getElementById("btnPackPhaseNext");
  btnPackCloseBox = document.getElementById("btnPackCloseBox");
  btnPackPrintLabel = document.getElementById("btnPackPrintLabel");
  btnPackTableEmpty = document.getElementById("btnPackTableEmpty");
  const btnManualToggle = document.getElementById("btnManualToggle");
  const manualControls = document.getElementById("manualControls");
  const btnShiftPlanUpload = document.getElementById("btnShiftPlanUpload");
  const btnShiftPlanSelect = document.getElementById("btnShiftPlanSelect");
  const btnShiftPlanAdd = document.getElementById("btnShiftPlanAdd");
  const btnShiftPlanRemoveSelected = document.getElementById("btnShiftPlanRemoveSelected");
  const btnShiftPlanMoveUp = document.getElementById("btnShiftPlanMoveUp");
  const btnShiftPlanMoveDown = document.getElementById("btnShiftPlanMoveDown");
  const shiftPlanSkuInput = document.getElementById("shiftPlanSkuInput");
  const shiftPlanQtyInput = document.getElementById("shiftPlanQtyInput");
  const shiftPlanRenameInput = document.getElementById("shiftPlanRenameInput");
  const btnShiftPlanRename = document.getElementById("btnShiftPlanRename");
  const shiftPlanCatalogSearch = document.getElementById("shiftPlanCatalogSearch");

  if (btnPackStart) {
    btnPackStart.addEventListener("click", () => {
      if (btnPackStart.classList.contains("pill-btn--disabled")) return;
      openPackModal();
    });
  }
  if (btnPackStepComplete) {
    btnPackStepComplete.addEventListener("click", () => {
      if (btnPackStepComplete.classList.contains("pill-btn--disabled")) return;
      handlePackAction("/api/kiosk/pack/step/complete");
    });
  }
  if (btnPackPhaseNext) {
    btnPackPhaseNext.addEventListener("click", () => {
      if (btnPackPhaseNext.classList.contains("pill-btn--disabled")) return;
      handlePackAction("/api/kiosk/pack/phase/next");
    });
  }
  if (btnPackCloseBox) {
    btnPackCloseBox.addEventListener("click", () => {
      if (btnPackCloseBox.classList.contains("pill-btn--disabled")) return;
      handlePackAction("/api/kiosk/pack/close-box");
    });
  }
  if (btnPackPrintLabel) {
    btnPackPrintLabel.addEventListener("click", () => {
      if (btnPackPrintLabel.classList.contains("pill-btn--disabled")) return;
      handlePackAction("/api/kiosk/pack/print-label");
    });
  }
  if (btnPackTableEmpty) {
    btnPackTableEmpty.addEventListener("click", () => {
      if (btnPackTableEmpty.classList.contains("pill-btn--disabled")) return;
      handlePackAction("/api/kiosk/pack/table-empty");
    });
  }

  if (btnManualToggle && manualControls) {
    btnManualToggle.addEventListener("click", () => {
      /**
       * –ö–Ω–æ–ø–∫–∏ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é,
       * —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –Ω–∞ —Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.
       * –°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç –±–ª–æ–∫ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
       */
      manualControls.classList.toggle("open");
      manualModeEnabled = manualControls.classList.contains("open");
      if (shiftPlanSelected) {
        renderShiftPlanList(shiftPlanSelected.items);
      }
    });
  }

  if (btnShiftPlanUpload) {
    btnShiftPlanUpload.addEventListener("click", () => openShiftPlanUploadModal());
  }
  if (btnShiftPlanSelect) {
    btnShiftPlanSelect.addEventListener("click", () => openShiftPlanSelectModal());
  }
  if (btnShiftPlanAdd) {
    btnShiftPlanAdd.addEventListener("click", () => addSkuToShiftPlan());
  }
  if (btnShiftPlanRemoveSelected) {
    btnShiftPlanRemoveSelected.addEventListener("click", () => removeSelectedSkuFromShiftPlan());
  }
  if (btnShiftPlanMoveUp) {
    btnShiftPlanMoveUp.addEventListener("click", () => moveSelectedSku(-1));
  }
  if (btnShiftPlanMoveDown) {
    btnShiftPlanMoveDown.addEventListener("click", () => moveSelectedSku(1));
  }
  if (btnShiftPlanRename) {
    btnShiftPlanRename.addEventListener("click", () => renameShiftPlan());
  }
  if (shiftPlanCatalogSearch) {
    shiftPlanCatalogSearch.addEventListener("input", () => {
      /**
       * –§–∏–ª—å—Ç—Ä –∫–∞—Ç–∞–ª–æ–≥–∞ –∂–∏–≤–æ–π: –æ–ø–µ—Ä–∞—Ç–æ—Ä —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç —Å—É–∂–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫.
       * –≠—Ç–æ —ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –¥–ª–∏–Ω–Ω—ã—Ö —Å–º–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏—è—Ö.
       */
      shiftPlanCatalogFilter = shiftPlanCatalogSearch.value || "";
      renderShiftPlanCatalog();
    });
  }

  /**
   * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI.
   *
   * –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ –∑–¥–µ—Å—å:
   * - DOM —É–∂–µ –≥–æ—Ç–æ–≤ (—Å–∫—Ä–∏–ø—Ç –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã);
   * - —ç–ª–µ–º–µ–Ω—Ç—ã —É–∂–µ –Ω–∞–π–¥–µ–Ω—ã –∏ –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å;
   * - —Å–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∞–µ–º –∑–∞—â–∏—Ç–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, –∑–∞—Ç–µ–º –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ.
   */
  warnAboutMergeMarkers();
  setInterval(fetchState, 1500);
  setInterval(refreshPackData, 2000);
  setInterval(tickTimers, 1000);
  fetchState();
  refreshPackData();
  initShiftPlanCatalog();
  loadShiftPlansFromStorage();

  // helper –¥–ª—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏ –≤–Ω–∏–∑—É
  const scanDebug = document.createElement("div");
  scanDebug.className = "scan-debug";
  document.body.appendChild(scanDebug);

  async function startPackSession(workerId, sku) {
    const payload = {
      worker_id: workerId,
      // —á—Ç–æ–±—ã –±—ç–∫ –Ω–µ –ø–∞–¥–∞–ª –Ω–∞ None –∏ –º–æ–≥ –ø–æ–∫–∞–∑–∞—Ç—å –∏–º—è —Å—Ä–∞–∑—É
      worker_name: workerId,
      shift_label: "–°–º–µ–Ω–∞ –ê",
      // —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: –∫—Ç–æ-—Ç–æ –∂–¥—ë—Ç sku, –∫—Ç–æ-—Ç–æ product_code
      sku: sku,
      product_code: sku,
    };

    console.log("START SESSION:", payload);

    try {
      await fetch("/api/kiosk/session/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ /api/kiosk/session/start:", err);
    }
  }


    // –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏, –Ω–∞–±—Ä–∞–Ω–Ω–æ–π –≤ —Ä—É—Å—Å–∫–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ, –∫ –ª–∞—Ç–∏–Ω—Å–∫–æ–π (QWERTY ‚Üí –ô–¶–£–ö–ï–ù)
  function normalizeLayout(str) {
    const map = {
      '–π':'q','—Ü':'w','—É':'e','–∫':'r','–µ':'t','–Ω':'y','–≥':'u','—à':'i','—â':'o','–∑':'p','—Ö':'[','—ä':']',
      '—Ñ':'a','—ã':'s','–≤':'d','–∞':'f','–ø':'g','—Ä':'h','–æ':'j','–ª':'k','–¥':'l','–∂':';','—ç':'\'',
      '—è':'z','—á':'x','—Å':'c','–º':'v','–∏':'b','—Ç':'n','—å':'m','—é':'.','–±':',',
      '–ô':'Q','–¶':'W','–£':'E','–ö':'R','–ï':'T','–ù':'Y','–ì':'U','–®':'I','–©':'O','–ó':'P','–•':'{','–™':'}',
      '–§':'A','–´':'S','–í':'D','–ê':'F','–ü':'G','–†':'H','–û':'J','–õ':'K','–î':'L','–ñ':':','–≠':'"',
      '–Ø':'Z','–ß':'X','–°':'C','–ú':'V','–ò':'B','–¢':'N','–¨':'M','–Æ':'.','–ë':',',
    };
    return str.split("").map(ch => map[ch] || ch).join("");
  }

  function getDefaultPackingWorkerId() {
    const list = (lastState && lastState.active_workers) ? lastState.active_workers : [];
    const packers = list.filter(x => (x.work_center || "").toUpperCase() === "–£–ü–ê–ö–û–í–ö–ê");
    if (!packers.length) return null;
    // –±–µ—Ä—ë–º —Å–∞–º–æ–≥–æ —Ä–∞–Ω–Ω–µ–≥–æ (–ø–µ—Ä–≤—ã–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ) ‚Äî —É—Å—Ç–æ–π—á–∏–≤–æ
    return packers[0].worker_id || null;
  }

  async function handleScan(codeRaw) {
    // 1) –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É —Å–∫–∞–Ω–µ—Ä–∞ (—á–∞—Å—Ç–∞—è –ø—Ä–æ–±–ª–µ–º–∞, –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –≤ RU –∏ –≤–º–µ—Å—Ç–æ —Ç–æ—á–∫–∏/–ª–∞—Ç–∏–Ω–∏—Ü—ã –ø—Ä–∏–ª–µ—Ç–∞—é—Ç —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã)
    const normalized = normalizeLayout(codeRaw || "");
    const code = (normalized || "").trim();
    if (!code) return;

    scanDebug.textContent = "SCAN: " + code;
    console.log("SCAN RAW:", JSON.stringify(codeRaw));
    console.log("SCAN NORM:", JSON.stringify(code));

    // 2) –°–∫–∞–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    const mWorker = code.match(/^W?(\d{1,10})$/i);
    if (mWorker) {
      const num = mWorker[1];
      const wid = "W" + num;

      // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫–∞–Ω –≤–Ω—É—Ç—Ä–∏ –Ω–µ—ë
      if (modalOpen) {
        modalWorkerId = wid;
        modalScanEl.textContent = wid;
        modalHintEl.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ.";
        renderModalActions();
        return;
      }

      // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∏ –Ω–µ—Ç ‚Äî —É–¥–æ–±–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" —Å—Ä–∞–∑—É –ø–æ —Å–∫–∞–Ω—É
      openShiftModal("add");
      modalWorkerId = wid;
      modalScanEl.textContent = wid;
      modalHintEl.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—á–∏–π —Ü–µ–Ω—Ç—Ä –Ω–∏–∂–µ.";
      renderModalActions();
      return;
    }

    // 3) –°–∫–∞–Ω –∫—Ä–æ–≤–∞—Ç–∏ (SKU)
    const sku = normalizeSkuFromQr(code);
    if (!sku) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–æ–¥:", code);
      return;
    }

    // –Ω–µ–ª—å–∑—è –Ω–∞—á–∏–Ω–∞—Ç—å –±–µ–∑ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–º–µ–Ω—ã (—Ö–æ—Ç—è –±—ã 1 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–∞ –£–ü–ê–ö–û–í–ö–ê)
    const workerId = getDefaultPackingWorkerId();
    if (!workerId) {
      if (workerScanHintEl) {
        workerScanHintEl.textContent = "–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ –†–¶ –£–ü–ê–ö–û–í–ö–ê (–∫–Ω–æ–ø–∫–∞ '–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞').";
      }
      // –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
      if (!modalOpen) openShiftModal("add");
      return;
    }

    await startPackSession(workerId, sku);
  }

  // –°–∫–∞–Ω–µ—Ä –∫–∞–∫ HID-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞: –∫–æ–ø–∏–º –≤—Å—ë –¥–æ Enter
  document.addEventListener("keydown", (e) => {
    const tag = (e.target && e.target.tagName) || "";
    if (tag === "INPUT" || tag === "TEXTAREA") return;

    if (e.key === "Enter") {
      const code = scanBuffer;
      scanBuffer = "";
      if (code) {
        handleScan(code);
      }
      e.preventDefault();
      return;
    }

    if (e.key.length === 1) {
      scanBuffer += e.key;
    }
  });

  // –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ ESC
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalOpen) {
      closeShiftModal();
    }
    if (e.key === "Escape" && packModalOpen) {
      closePackModal();
    }
    if (e.key === "Escape" && shiftPlanUploadOpen) {
      closeShiftPlanUploadModal();
    }
    if (e.key === "Escape" && shiftPlanSelectOpen) {
      closeShiftPlanSelectModal();
    }
  });
</script>
<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–µ–∂–∏–º–∞ –º–∞—Å—Ç–µ—Ä–∞: –æ—Ç–¥–µ–ª—è–µ–º –ª–æ–≥–∏–∫—É, —á—Ç–æ–±—ã HTML –±—ã–ª —á–∏—â–µ. -->
<script src="/static/kiosk.js"></script>
</body>
</html>
