<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∏–æ—Å–∫ —É–ø–∞–∫–æ–≤–∫–∏ –∫—Ä–æ–≤–∞—Ç–µ–π</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --card-bg: #0f172a;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --error: #ef4444;
      --warn: #facc15;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 40%, #020617 100%);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 16px 20px;
      gap: 16px;
    }

    /* –õ–û–ì–û–¢–ò–ü */

    .logo-bar {
      display: flex;
      align-items: center;
      padding: 4px 4px 0 4px;
      margin-bottom: 4px;
    }

    .logo-img {
      height: 44px;
      opacity: 0.95;
      filter: drop-shadow(0 10px 18px rgba(0, 0, 0, 0.55));
    }

    .top-bar {
      display: grid;
      grid-template-columns: 1.3fr 1.3fr 1.4fr;
      gap: 16px;
      align-items: stretch;
    }

    .card {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
      border-radius: var(--radius);
      border: 1px solid var(--border-soft);
      padding: 14px 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      opacity: 0.08;
      background:
        radial-gradient(circle at 0 0, #22c55e, transparent 55%),
        radial-gradient(circle at 100% 0, #38bdf8, transparent 55%);
      pointer-events: none;
    }

    .card-content {
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .card-main {
      font-size: 22px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* –¢–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ "–¢–µ–∫—É—â–∞—è –∫—Ä–æ–≤–∞—Ç—å": –¥–µ–ª–∞–µ–º SKU –æ–¥–Ω–æ–π –±–æ–ª—å—à–æ–π —Å—Ç—Ä–æ–∫–æ–π */
.bed-mainline {
  display: block;          /* –Ω–µ –ª–æ–º–∞–µ–º —Å–µ—Ç–∫—É, –ø—Ä–æ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ */
  font-size: 26px;         /* –∫—Ä—É–ø–Ω–µ–µ, —á–µ–º –æ–±—ã—á–Ω—ã–π card-main (22px) */
  font-weight: 700;
  line-height: 1.15;
}


    .card-sub {
      font-size: 15px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .badge {
      font-size: 13px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 6px var(--accent);
    }

    .status-pill {
      font-size: 14px;
      border-radius: 999px;
      padding: 4px 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .status-ok {
      background: rgba(16, 185, 129, 0.15);
      color: #6ee7b7;
      border: 1px solid rgba(16, 185, 129, 0.6);
    }

    .status-warn {
      background: rgba(250, 204, 21, 0.14);
      color: #facc15;
      border: 1px solid rgba(250, 204, 21, 0.7);
    }

    .status-error {
      background: rgba(239, 68, 68, 0.18);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.8);
    }

    .timer {
      font-variant-numeric: tabular-nums;
      font-size: 26px;
      font-weight: 600;
    }

    .timers {
      display: flex;
      gap: 16px;
      margin-top: 6px;
      font-size: 13px;
    }

    .timer-chip {
      flex: 1;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-variant-numeric: tabular-nums;
    }

    .timer-chip-label {
      color: var(--text-muted);
    }

    .timer-chip-value {
      font-weight: 500;
    }

    .middle {
      display: grid;
      grid-template-columns: 3.2fr 1fr;
      gap: 16px;
      flex: 1;
      min-height: 0;
    }

    .camera-card {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .camera-frame {
      position: relative;
      flex: 1;
      border-radius: 16px;
      overflow: hidden;
      background: #020617;
      border: 1px solid var(--border-soft);
    }

    .camera-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: brightness(0.95);
    }

    .camera-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .slot {
      position: absolute;
      border-radius: 12px;
      border: 2px dashed rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 4px;
      font-size: 12px;
      color: var(--text-muted);
      transition: all 0.2s ease-out;
    }

    .slot-title {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .slot-status {
      font-size: 11px;
    }

    .slot.pending {
      opacity: 0.35;
      border-style: dashed;
    }

    .slot.current {
      opacity: 1;
      border-style: solid;
      border-color: #38bdf8;
      background: rgba(8, 47, 73, 0.85);
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.8);
      color: #e0f2fe;
    }

    .slot.done {
      opacity: 0.9;
      border-style: solid;
      border-color: #22c55e;
      background: rgba(22, 101, 52, 0.85);
      color: #bbf7d0;
    }

    .slot.done .slot-status::before {
      content: "‚úî ";
    }

    .camera-caption {
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .camera-caption span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .instruction-card {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 18px 22px;
    }

    .instruction-main {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .instruction-sub {
      font-size: 19px;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    .instruction-extra {
      font-size: 15px;
      color: var(--text-muted);
    }

    .big-icon {
      font-size: 34px;
      margin-right: 10px;
    }

    .steps-card {
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid var(--border-soft);
    }

    .progress-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      width: 0%;
      transition: width 0.25s ease-out;
    }

    .steps-list {
      margin-top: 6px;
      max-height: 100%;
      overflow: hidden;
    }

    .step-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px 0;
      font-size: 15px;
    }

    .step-index {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      background: #020617;
      border: 1px solid var(--border-soft);
      color: var(--text-muted);
    }

    .step-row.done .step-index {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: #bbf7d0;
    }

    .step-row.current .step-index {
      background: #0ea5e9;
      border-color: #38bdf8;
      color: #e0f2fe;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.6);
    }

    .step-title {
      font-weight: 500;
    }

    .step-meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    .bottom {
      display: grid;
      grid-template-columns: 2.2fr 1.6fr;
      gap: 16px;
      align-items: stretch;
    }

    .events-card {
      padding: 10px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 140px;
    }

    .events-list {
      font-size: 13px;
      flex: 1;
      overflow: hidden;
    }

    .event-row {
      display: flex;
      gap: 8px;
      padding: 2px 0;
      color: var(--text-muted);
    }

    .event-time {
      font-variant-numeric: tabular-nums;
      width: 60px;
      color: #6b7280;
    }

    .event-text {
      flex: 1;
    }

    .stats-card {
      padding: 10px 16px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 140px;
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
    }

    .stats-label {
      color: var(--text-muted);
    }

    .stats-value {
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }

    .status-strip {
      position: fixed;
      inset-inline: 0;
      bottom: 0;
      height: 4px;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      opacity: 0.9;
      transition: background 0.2s ease-out;
    }

    .status-strip.warn {
      background: linear-gradient(90deg, #facc15, #f97316);
    }

    .status-strip.error {
      background: linear-gradient(90deg, #ef4444, #b91c1c);
    }

    /* –ö–Ω–æ–ø–∫–∏ –≤ –≤–µ—Ä—Ö–Ω–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ (–∫–∞–∫ "–û–∂–∏–¥–∞–Ω–∏–µ") */
    .action-row {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .action-pill {
      cursor: pointer;
      user-select: none;
      border-radius: 999px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.55);
      color: var(--text-main);
      transition: transform 0.06s ease, box-shadow 0.18s ease, border-color 0.18s ease, background 0.18s ease;
    }

    .action-pill:active {
      transform: translateY(1px);
    }

    .action-pill .dot {
      background: #e5e7eb;
      box-shadow: none;
    }

    .action-pill.active {
      background: rgba(16, 185, 129, 0.15);
      border-color: rgba(16, 185, 129, 0.75);
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.18);
    }

    .action-pill.active .dot {
      background: var(--accent);
      box-shadow: 0 0 6px var(--accent);
    }

    .action-pill.disabled {
      opacity: 0.45;
      cursor: not-allowed;
      filter: grayscale(0.2);
      box-shadow: none;
    }

    .action-pill.disabled .dot {
      background: rgba(148, 163, 184, 0.6);
      box-shadow: none;
    }

    .action-pill.manual-pill {
      opacity: 0.78;
      border-color: rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.35);
    }

    .pack-card {
      padding: 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 52%;
      min-width: 280px;
      align-self: flex-start;
    }

    .pack-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .pack-main {
      font-size: 24px;
      font-weight: 700;
    }

    .pack-hint {
      margin-top: 6px;
      font-size: 16px;
      color: var(--text-main);
    }

    .pack-state-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 13px;
      color: var(--text-muted);
    }

    .pack-meta {
      font-size: 14px;
      color: var(--text-muted);
    }

    .pack-current-step {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: rgba(2, 6, 23, 0.55);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .pack-current-step-title {
      font-size: 13px;
      color: var(--text-muted);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .pack-current-step-value {
      font-size: 18px;
      font-weight: 600;
    }

    .pack-available {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .pack-manual-note {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.4);
      padding: 8px 10px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .manual-controls {
      display: none;
      flex-wrap: wrap;
      gap: 10px;
    }

    .manual-controls.open {
      display: flex;
    }

    /* –í–ê–ñ–ù–û: —É–ø–∞–∫–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ –≤–∞–∂–Ω–µ–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
       –ü–æ—ç—Ç–æ–º—É —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –±–ª–æ–∫ –º–æ–∂–µ—Ç —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ,
       —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–ª –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Ç–µ–∫—É—â–∏–π —à–∞–≥. */
    .pack-card {
      flex: 1 1 auto;
      min-height: 0;
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω–æ: –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –≤–∞–∂–Ω–µ–µ —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ,
       –ø–æ—ç—Ç–æ–º—É –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–æ—Å—Ç –ø–æ –≤—ã—Å–æ—Ç–µ –∏ –Ω–µ –¥–∞—ë–º –±–ª–æ–∫—É "—Ä–∞—Å–ø–æ–ª–∑–∞—Ç—å—Å—è". */
    .steps-card {
      flex: 0 0 auto;
      min-height: 110px;
      max-height: 160px;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏:
       –∑–∞–¥–∞—ë–º —É–ø—Ä–∞–≤–ª—è–µ–º—É—é flex-–æ—Å—å –∏ –≤—ã—Å–æ—Ç—É,
       —á—Ç–æ–±—ã —Ç–æ–ª—å–∫–æ "–£–ø–∞–∫–æ–≤–∫–∞" —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–∞—Å—å, –∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º–∏. */
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
      height: 100%;
    }

    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –±–ª–æ–∫ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è:
       –æ–Ω –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç, –Ω–æ –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–∞–±–∏—Ä–∞—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ. */
    .shift-plan-card {
      flex: 0 0 auto;
    }

    /* –ë–ª–æ–∫ "–¢–µ–∫—É—â–∞—è –∫–æ–º–∞–Ω–¥–∞":
       –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–≥–æ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω–∫—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Å —É–ø–∞–∫–æ–≤–∫–æ–π. */
    .instruction-card {
      flex: 0 0 auto;
    }

    .pack-steps-preview {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 14px;
    }

    .pack-step-line {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: rgba(2, 6, 23, 0.55);
    }

    .pack-step-line.current {
      border-color: rgba(56, 189, 248, 0.8);
      background: rgba(8, 47, 73, 0.55);
      color: #e0f2fe;
    }

    /* –ë–ª–æ–∫ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è: –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–≤–æ–¥–∞ –∏ —Å–ø–∏—Å–æ–∫ SKU. */
    .shift-plan-controls {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }

    .shift-plan-input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(2, 6, 23, 0.55);
      color: var(--text-main);
      padding: 6px 8px;
      font-size: 13px;
    }

    .shift-plan-qty {
      max-width: 90px;
    }

    .shift-plan-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 160px;
      overflow: hidden;
    }

    .shift-plan-row {
      display: grid;
      grid-template-columns: 1fr auto auto auto auto;
      gap: 6px;
      align-items: center;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(2, 6, 23, 0.55);
      font-size: 13px;
    }

    .shift-plan-row.selected {
      border-color: rgba(56, 189, 248, 0.7);
      background: rgba(8, 47, 73, 0.55);
      color: #e0f2fe;
    }

    .shift-plan-mini-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.55);
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
    }

    .shift-plan-mini-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .shift-plan-modal-input {
      background: transparent;
      border: none;
      color: #e0f2fe;
      font-size: 15px;
    }

    .shift-plan-modal-textarea {
      width: 100%;
      background: transparent;
      border: none;
      color: #e0f2fe;
      font-size: 14px;
      resize: vertical;
    }

    .shift-plan-modal-hint {
      font-size: 13px;
      color: var(--text-muted);
    }

    .shift-plan-upload-box {
      flex-direction: column;
      align-items: stretch;
    }

    .pack-toast {
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(239, 68, 68, 0.6);
      background: rgba(127, 29, 29, 0.4);
      color: #fecaca;
      font-size: 14px;
      display: none;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (–≤ —Å—Ç–∏–ª–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞) */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.72);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: 22px;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      width: min(1200px, 96vw);
      border-radius: var(--radius);
      border: 1px solid var(--border-soft);
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.92));
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.6);
      padding: 18px 20px;
      position: relative;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   –ú–û–î–ê–õ–ö–ê: –Ω–∏–∑ (footer) –∏ "–û–¢–ú–ï–ù–ê" —Å–ø—Ä–∞–≤–∞ –≤–Ω–∏–∑—É
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.modal-footer {
  display: flex;
  justify-content: flex-end;   /* –ø—Ä–∏–∂–∏–º–∞–µ–º –≤–ø—Ä–∞–≤–æ */
  margin-top: 10px;
}

/* "–û–¢–ú–ï–ù–ê" ‚Äî —Ç–æ–∂–µ –ø–∏–ª—é–ª—è –∫–∞–∫ –≤–µ–∑–¥–µ */
.modal-cancel-pill {
  cursor: pointer;
}


    .modal::before {
      content: "";
      position: absolute;
      inset: -40%;
      opacity: 0.10;
      background:
        radial-gradient(circle at 0 0, #22c55e, transparent 55%),
        radial-gradient(circle at 100% 0, #38bdf8, transparent 55%);
      pointer-events: none;
    }

    .modal-content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modal-title {
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .modal-main {
      font-size: 26px;
      font-weight: 700;
      line-height: 1.15;
    }

    .modal-sub {
      font-size: 16px;
      color: var(--text-muted);
    }

    .modal-scan {
      margin-top: 4px;
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      background: rgba(2, 6, 23, 0.55);
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      font-variant-numeric: tabular-nums;
    }

    .modal-scan code {
      color: #e0f2fe;
      font-size: 15px;
      background: rgba(14, 165, 233, 0.14);
      border: 1px solid rgba(56, 189, 248, 0.35);
      padding: 3px 8px;
      border-radius: 10px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-start;
      margin-top: 6px;
    }

    .modal-btn {
      cursor: pointer;
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.55);
      color: var(--text-main);
      font-weight: 600;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .modal-btn.primary {
      border-color: rgba(56, 189, 248, 0.8);
      background: rgba(8, 47, 73, 0.65);
      box-shadow: 0 0 16px rgba(56, 189, 248, 0.18);
    }

    .modal-btn.success {
      border-color: rgba(16, 185, 129, 0.75);
      background: rgba(22, 101, 52, 0.55);
      box-shadow: 0 0 16px rgba(16, 185, 129, 0.14);
    }

    .modal-btn.danger {
      border-color: rgba(239, 68, 68, 0.75);
      background: rgba(127, 29, 29, 0.35);
      box-shadow: 0 0 16px rgba(239, 68, 68, 0.14);
    }

   /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   –í–∞—Ä–∏–∞–Ω—Ç—ã action-pill –¥–ª—è –º–æ–¥–∞–ª–∫–∏:
   - modal-success: –∑–µ–ª—ë–Ω–∞—è
   - modal-danger: –∫—Ä–∞—Å–Ω–∞—è
   - modal-primary: —Å–∏–Ω—è—è
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

.action-pill.modal-success {
  background: rgba(16, 185, 129, 0.15);
  border-color: rgba(16, 185, 129, 0.75);
  box-shadow: 0 0 12px rgba(16, 185, 129, 0.18);
}

.action-pill.modal-success .dot {
  background: var(--accent);
  box-shadow: 0 0 6px var(--accent);
}

.action-pill.modal-danger {
  background: rgba(239, 68, 68, 0.16);
  border-color: rgba(239, 68, 68, 0.75);
  box-shadow: 0 0 12px rgba(239, 68, 68, 0.18);
}

.action-pill.modal-danger .dot {
  background: var(--error);
  box-shadow: 0 0 6px var(--error);
}

.action-pill.modal-primary {
  background: rgba(56, 189, 248, 0.14);
  border-color: rgba(56, 189, 248, 0.75);
  box-shadow: 0 0 12px rgba(56, 189, 248, 0.18);
}

.action-pill.modal-primary .dot {
  background: #38bdf8;
  box-shadow: 0 0 6px rgba(56, 189, 248, 0.9);
}
 
  </style>
</head>
<body>
<div class="app">
  <div class="logo-bar">
    <!--<img src="/static/logo.png" class="logo-img" alt="–ù–æ–≤—ã–µ –º–µ–±–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏" /> -->
  </div>

  <!-- –í–µ—Ä—Ö -->
  <div class="top-bar">
    <div class="card">
      <div class="card-content">
        <div class="card-title">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</div>
        <div class="card-main">
          <span id="workerName">‚Äî</span>
          <span class="badge" id="shiftLabel">
            <span class="dot"></span>
            <span id="shiftInfo">–°–º–µ–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
          </span>
        </div>
        <div class="card-sub" id="workerStats">
          –°–µ–≥–æ–¥–Ω—è: 0 –∫—Ä–æ–≤–∞—Ç–µ–π, –ø—Ä–æ—Å—Ç–æ–µ–≤ 0 –º–∏–Ω
        </div>
        <div class="card-sub" id="workerScanHint"></div> <!-- –ù–û–í–ê–Ø –°–¢–†–û–ö–ê -->

        <div class="action-row">
          <div id="btnAddWorker" class="action-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</span>
          </div>
          <div id="btnEndShift" class="action-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É</span>
          </div>
        </div>
      </div>
    </div>

<div class="card">
  <div class="card-content">
    <div class="card-title">–¢–µ–∫—É—â–∞—è –∫—Ä–æ–≤–∞—Ç—å</div>

    <!-- –ë–æ–ª—å—à–∞—è —Å—Ç—Ä–æ–∫–∞: SKU -->
    <div class="card-main bed-mainline">
      <span id="bedSkuBig">SKU ‚Äî</span>
    </div>

    <!-- –ü–æ—è—Å–Ω–µ–Ω–∏–µ + –¥–µ—Ç–∞–ª–∏ -->
    <div class="card-sub" id="bedDetails">
      –ú–æ–¥–µ–ª—å ‚Äî | –†–∞–∑–º–µ—Ä ‚Äî | –¶–≤–µ—Ç ‚Äî
    </div>
  </div>
</div>


    <div class="card">
      <div class="card-content">
        <div class="card-title">–í—Ä–µ–º—è —É–ø–∞–∫–æ–≤–∫–∏</div>
        <div class="card-main" style="margin-bottom:4px;">
          <span class="timer" id="sessionTimer">00:00</span>
          <span id="statusPill" class="status-pill status-warn">
            <span class="dot"></span>
            <span id="statusText">–û–∂–∏–¥–∞–Ω–∏–µ</span>
          </span>
        </div>
        <div class="timers">
          <div class="timer-chip">
            <span class="timer-chip-label">–†–∞–±–æ—Ç–∞</span>
            <span class="timer-chip-value" id="workTimer">00:00</span>
          </div>
          <div class="timer-chip">
            <span class="timer-chip-label">–ü—Ä–æ—Å—Ç–æ–π</span>
            <span class="timer-chip-value" id="idleTimer">00:00</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –¶–µ–Ω—Ç—Ä -->
  <div class="middle">
    <div class="card camera-card">
      <div class="card-title">–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª (–≤–∏–¥ —Å–≤–µ—Ä—Ö—É)</div>
      <div class="camera-frame">
        <img id="cameraImage" class="camera-image" src="" alt="–ü–æ—Ç–æ–∫ —Å –∫–∞–º–µ—Ä—ã" />
        <div id="cameraOverlay" class="camera-overlay"></div>
      </div>
      <div class="camera-caption">
        <span id="cameraHint">
          –ó–æ–Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è: ~3.5‚Äì4.0√ó1.5 –º. –°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–≤–µ—Ç–∫–µ –¥–µ—Ç–∞–ª–µ–π –Ω–∞ —Å—Ç–æ–ª–µ.
        </span>
        <span id="workerStateLabel">–°–æ—Å—Ç–æ—è–Ω–∏–µ: ‚Äî</span>
      </div>
    </div>

    <div class="right-column">
      <div class="card instruction-card">
        <div>
          <div class="card-title">–¢–µ–∫—É—â–∞—è –∫–æ–º–∞–Ω–¥–∞</div>
          <div class="instruction-main">
            <span class="big-icon">üõ†Ô∏è</span>
            <span id="instructionMain">–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —É–ø–∞–∫–æ–≤–∫–∏‚Ä¶</span>
          </div>
          <div class="instruction-sub" id="instructionSub">
            –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.
          </div>
        </div>
        <div class="instruction-extra" id="instructionExtra">
          –ì–æ–ª–æ—Å–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥—É–±–ª–∏—Ä—É—é—Ç —Ç–µ–∫—Å—Ç. –†–∞–±–æ—Ç–∞–π—Ç–µ –ø–æ –≥–æ–ª–æ—Å—É, –Ω–∞ —ç–∫—Ä–∞–Ω –ø–æ–≥–ª—è–¥—ã–≤–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
        </div>
      </div>

      <div class="card pack-card">
        <div class="card-title">–£–ø–∞–∫–æ–≤–∫–∞</div>
        <div class="pack-row">
          <div class="pack-main" id="packStateLabel">–°–æ—Å—Ç–æ—è–Ω–∏–µ: ‚Äî</div>
          <div class="pack-state-chip">
            <span class="dot"></span>
            <span id="packPhaseLabel">–§–∞–∑–∞: ‚Äî</span>
          </div>
        </div>
        <div class="pack-hint" id="packHint">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫—Ä–æ–≤–∞—Ç–∏ (SKU) –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.</div>

        <div class="pack-current-step">
          <div class="pack-current-step-title">–¢–µ–∫—É—â–∏–π —à–∞–≥</div>
          <div class="pack-current-step-value" id="packCurrentStep">‚Äî</div>
        </div>

        <div class="pack-available" id="packFlags">
          <div>–î–æ—Å—Ç—É–ø–Ω–æ:</div>
          <div>‚Ä¢ ‚Äî</div>
        </div>

        <div class="pack-manual-note">
          <strong>–†—É—á–Ω–æ–π —Ä–µ–∂–∏–º:</strong> –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞.
        </div>

        <div class="action-row" style="justify-content:flex-start;">
          <div id="btnManualToggle" class="action-pill manual-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–†—É—á–Ω–æ–π —Ä–µ–∂–∏–º (—Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä)</span>
          </div>
        </div>

        <div class="action-row manual-controls" id="manualControls">
          <div id="btnPackStart" class="action-pill manual-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–°—Ç–∞—Ä—Ç SKU (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)</span>
          </div>
          <div id="btnPackStepComplete" class="action-pill manual-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–®–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)</span>
          </div>
          <div id="btnPackPhaseNext" class="action-pill manual-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–°–ª–µ–¥—É—é—â–∞—è —Ñ–∞–∑–∞ (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)</span>
          </div>
          <div id="btnPackCloseBox" class="action-pill manual-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–ó–∞–∫—Ä—ã—Ç—å –∫–æ—Ä–æ–±–∫—É (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)</span>
          </div>
          <div id="btnPackPrintLabel" class="action-pill manual-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–ü–µ—á–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏ (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)</span>
          </div>
          <div id="btnPackTableEmpty" class="action-pill manual-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–°—Ç–æ–ª –ø—É—Å—Ç–æ–π (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)</span>
          </div>
        </div>

        <div>
          <div class="card-title" style="margin-bottom:6px;">–ë–ª–∏–∂–∞–π—à–∏–µ —à–∞–≥–∏</div>
          <div class="pack-steps-preview" id="packPlanPreview">
            <div class="pack-step-line">
              <span>–ü–ª–∞–Ω –≤—ã–∫–ª–∞–¥–∫–∏ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>
              <span>‚Äî</span>
            </div>
          </div>
          <div class="pack-toast" id="packToast"></div>
        </div>
      </div>

      <div class="card shift-plan-card" id="shiftPlanCard">
        <div class="card-title">–°–º–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</div>
        <div class="pack-meta" id="shiftPlanName">–ü–ª–∞–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
        <div class="pack-meta" id="shiftPlanCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ SKU: ‚Äî</div>
        <div class="shift-plan-controls">
          <input id="shiftPlanSkuInput" class="shift-plan-input" list="shiftPlanSkuCatalog"
                 placeholder="SKU –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞" />
          <input id="shiftPlanQtyInput" class="shift-plan-input shift-plan-qty" type="number" min="1" value="1" />
          <div id="btnShiftPlanAdd" class="action-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–î–æ–±–∞–≤–∏—Ç—å</span>
          </div>
        </div>
        <div class="action-row" style="justify-content:flex-start;">
          <div id="btnShiftPlanRemoveSelected" class="action-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</span>
          </div>
          <div id="btnShiftPlanUpload" class="action-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫</span>
          </div>
          <div id="btnShiftPlanSelect" class="action-pill" role="button" tabindex="0">
            <span class="dot"></span>
            <span>–í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞</span>
          </div>
        </div>
        <div class="pack-meta">–¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –Ω–∞ —Å–º–µ–Ω—É</div>
        <div class="shift-plan-list" id="shiftPlanList"></div>
        <datalist id="shiftPlanSkuCatalog"></datalist>
      </div>

      <div class="card steps-card">
        <div>
          <div class="card-title">–ü—Ä–æ–≥—Ä–µ—Å—Å –∫–æ–º–ø–ª–µ–∫—Ç–∞</div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <div id="stepsSummary">–®–∞–≥ 0 –∏–∑ 0</div>
            <div style="font-size:13px; color:var(--text-muted);" id="stepsCounters">
              0 –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ, 0 –æ—à–∏–±–æ–∫
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>
        <div class="steps-list" id="stepsList"></div>
      </div>
    </div>
  </div>

  <!-- –ù–∏–∑ -->
  <div class="bottom">
    <div class="card events-card">
      <div class="card-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</div>
      <div class="events-list" id="eventsList"></div>
    </div>
    <div class="card stats-card">
      <div class="card-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É–ø–∞–∫–æ–≤–∫–µ —ç—Ç–æ–π –∫—Ä–æ–≤–∞—Ç–∏</div>
      <div class="stats-row">
        <span class="stats-label">–ü–æ—Å–ª–µ–¥–Ω—è—è —É–ø–∞–∫–æ–≤–∫–∞</span>
        <span class="stats-value" id="lastPack">‚Äî</span>
      </div>
      <div class="stats-row">
        <span class="stats-label">–õ—É—á—à–µ–µ –≤—Ä–µ–º—è</span>
        <span class="stats-value" id="bestPack">‚Äî</span>
      </div>
      <div class="stats-row">
        <span class="stats-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</span>
        <span class="stats-value" id="avgPack">‚Äî</span>
      </div>
      <div style="margin-top:8px; font-size:12px; color:var(--text-muted);">
        –í—Ä–µ–º—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º —Å–µ—Å—Å–∏—è–º —É–ø–∞–∫–æ–≤–∫–∏ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏ (–ø–æ SKU).
      </div>
    </div>
  </div>

  <div id="statusStrip" class="status-strip"></div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Å–º–µ–Ω/–†–¶ -->
<div id="shiftModalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
<div>
  <div class="modal-title" id="shiftModalTitle">–°–º–µ–Ω–∞</div>
  <div class="modal-sub" id="shiftModalSub">–ü—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.</div>
</div>

<!-- –ù–ò–ó –º–æ–¥–∞–ª–∫–∏: –∫–Ω–æ–ø–∫–∞ –û–¢–ú–ï–ù–ê —Å–ø—Ä–∞–≤–∞ –≤–Ω–∏–∑—É -->
<div class="modal-footer">
  <!-- –í–ê–ñ–ù–û: –¥–µ–ª–∞–µ–º —Å—Ç–∏–ª—å –∫–∞–∫ "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" (action-pill) -->
  <div id="shiftModalCancel" class="action-pill modal-cancel-pill" role="button" tabindex="0">
    <span class="dot"></span>
    <span>–û–¢–ú–ï–ù–ê</span>
  </div>
</div>


    <div class="modal-scan">
      <div>
        –°–∫–∞–Ω: <code id="shiftModalScan">‚Äî</code>
      </div>
      <div id="shiftModalHint" style="font-size:13px; color: var(--text-muted);">–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶</div>
    </div>

    <div class="modal-actions" id="shiftModalActions"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Å—Ç–∞—Ä—Ç–∞ —É–ø–∞–∫–æ–≤–∫–∏ –ø–æ SKU -->
<div id="packModalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div>
        <div class="modal-title">–°—Ç–∞—Ä—Ç —É–ø–∞–∫–æ–≤–∫–∏</div>
        <div class="modal-sub">–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ SKU –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —É–ø–∞–∫–æ–≤–∫–∏.</div>
      </div>
      <div class="modal-scan">
        <div style="flex:1;">
          SKU: <input id="packModalSku" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, SKU-1"
                      style="width:100%; background:transparent; border:none; color:#e0f2fe; font-size:15px;">
        </div>
        <div id="packModalHint" style="font-size:13px; color: var(--text-muted);">–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞‚Ä¶</div>
      </div>
      <div class="modal-actions" id="packModalActions"></div>
      <div class="modal-footer">
        <div id="packModalCancel" class="action-pill modal-cancel-pill" role="button" tabindex="0">
          <span class="dot"></span>
          <span>–û–¢–ú–ï–ù–ê</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è -->
<div id="shiftPlanUploadBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div>
        <div class="modal-title">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è</div>
        <div class="modal-sub">–í—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ SKU –ø–æ—Å—Ç—Ä–æ—á–Ω–æ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª.</div>
      </div>
      <div class="modal-scan shift-plan-upload-box">
        <input id="shiftPlanNameInput" class="shift-plan-modal-input" type="text"
               placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–º–µ–Ω–∞ –ê)">
        <textarea id="shiftPlanTextarea" class="shift-plan-modal-textarea" rows="6"
                  placeholder="SKU –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ"></textarea>
        <div id="shiftPlanUploadHint" class="shift-plan-modal-hint">–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞‚Ä¶</div>
      </div>
      <div class="modal-actions" id="shiftPlanUploadActions"></div>
      <div class="modal-footer">
        <div id="shiftPlanUploadCancel" class="action-pill modal-cancel-pill" role="button" tabindex="0">
          <span class="dot"></span>
          <span>–û–¢–ú–ï–ù–ê</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è -->
<div id="shiftPlanSelectBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div>
        <div class="modal-title">–í—ã–±–æ—Ä —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è</div>
        <div class="modal-sub">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ —Ä–∞–Ω–µ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ SKU.</div>
      </div>
      <div class="modal-actions" id="shiftPlanSelectActions"></div>
      <div class="modal-footer">
        <div id="shiftPlanSelectCancel" class="action-pill modal-cancel-pill" role="button" tabindex="0">
          <span class="dot"></span>
          <span>–û–¢–ú–ï–ù–ê</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const API_STATE_URL = "/api/kiosk/state";
  const API_PACK_UI_STATE_URL = "/api/kiosk/pack/ui-state";
  const API_PACK_STEPS_STATE_URL = "/api/kiosk/pack/steps/state";
  const SHIFT_PLAN_STORAGE_KEY = "kz_shift_plans";
  const SHIFT_PLAN_ACTIVE_KEY = "kz_shift_plan_active";

  let lastState = null;
  let timerStart = null;
  let workBase = 0;
  let idleBase = 0;
  let packUiState = null;
  let packStepsState = null;
  let shiftPlanSelected = null;
  let shiftPlanList = [];
  let shiftPlanSelectedSku = null;
  let manualModeEnabled = false;

  // –£—á–µ–±–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ SKU: –ø–æ–∫–∞ —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫,
  // –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ API –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è UI-–ª–æ–≥–∏–∫–∏.
  const SHIFT_PLAN_SKU_CATALOG = [
    "SKU-1",
    "SKU-2",
    "SKU-3",
    "SKU-DEFAULT",
  ];
  let btnPackStart = null;
  let btnPackStepComplete = null;
  let btnPackPhaseNext = null;
  let btnPackCloseBox = null;
  let btnPackPrintLabel = null;
  let btnPackTableEmpty = null;

  function pad(n) { return n.toString().padStart(2, "0"); }

  function formatDuration(seconds) {
    const s = Math.max(0, Math.floor(seconds));
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return pad(m) + ":" + pad(sec);
  }

  function setStatus(status) {
    const pill = document.getElementById("statusPill");
    const text = document.getElementById("statusText");
    const strip = document.getElementById("statusStrip");

    pill.classList.remove("status-ok", "status-warn", "status-error");
    strip.classList.remove("warn", "error");

    if (status === "running") {
      pill.classList.add("status-ok");
      text.textContent = "–ò–¥—ë—Ç —É–ø–∞–∫–æ–≤–∫–∞";
    } else if (status === "idle") {
      pill.classList.add("status-warn");
      strip.classList.add("warn");
      text.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ";
    } else if (status === "error") {
      pill.classList.add("status-error");
      strip.classList.add("error");
      text.textContent = "–û—à–∏–±–∫–∞";
    } else if (status === "done") {
      pill.classList.add("status-ok");
      text.textContent = "–ì–æ—Ç–æ–≤–æ";
    } else {
      pill.classList.add("status-warn");
      text.textContent = status || "–û–∂–∏–¥–∞–Ω–∏–µ";
    }
  }

  function renderOverlays(state) {
    const overlayEl = document.getElementById("cameraOverlay");
    overlayEl.innerHTML = "";
    const slots = state.overlay_slots || [];
    const rect = overlayEl.getBoundingClientRect();
    const W = rect.width || 1;
    const H = rect.height || 1;

    slots.forEach((slot) => {
      const div = document.createElement("div");
      div.className = "slot";

      const status = slot.status || "pending";
      div.classList.add(status);

      const x = (slot.x || 0) * W;
      const y = (slot.y || 0) * H;
      const w = (slot.w || 0.2) * W;
      const h = (slot.h || 0.15) * H;

      div.style.left = x + "px";
      div.style.top = y + "px";
      div.style.width = w + "px";
      div.style.height = h + "px";

      const title = document.createElement("div");
      title.className = "slot-title";
      title.textContent = slot.title || "";

      const statusEl = document.createElement("div");
      statusEl.className = "slot-status";
      statusEl.textContent =
        status === "done" ? "–ì–æ—Ç–æ–≤–æ" :
        status === "current" ? "–°–µ–π—á–∞—Å" :
        "–ü–æ –ø–ª–∞–Ω—É";

      div.appendChild(title);
      div.appendChild(statusEl);
      overlayEl.appendChild(div);
    });
  }

  function renderState(state) {
    lastState = state;

    // –ö–æ–º–∞–Ω–¥–∞ (–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–º–µ–Ω—ã)
    const active = state.active_workers || [];
    const byWorker = {};
    active.forEach((r) => {
      const wid = r.worker_id || "";
      const wc = (r.work_center || "").toUpperCase();
      if (!wid) return;
      byWorker[wid] = byWorker[wid] || new Set();
      if (wc) byWorker[wid].add(wc);
    });

    const workers = Object.keys(byWorker);
    if (workers.length === 0) {
      document.getElementById("workerName").textContent = "‚Äî";
    } else if (workers.length === 1) {
      const wid = workers[0];
      const num = wid.replace(/^W/i, "");
      const centers = Array.from(byWorker[wid]).join(", ");
      document.getElementById("workerName").textContent = `–°–æ—Ç—Ä—É–¥–Ω–∏–∫ ‚Ññ${num}`;
      if (workerScanHintEl) {
        workerScanHintEl.textContent = `–ê–∫—Ç–∏–≤–Ω—ã–π –†–¶: ${centers}`;
      }
    } else {
      const nums = workers.map(w => w.replace(/^W/i, "")).join(", ");
      document.getElementById("workerName").textContent = `–ö–æ–º–∞–Ω–¥–∞: ${nums}`;
    }

    // –ö–Ω–æ–ø–∫–∏ —Å–º–µ–Ω—ã (–±–µ–ª–∞—è/–∑–µ–ª—ë–Ω–∞—è)
    setActionPillActive(btnAddWorker, !!state.shift_active);
    setActionPillActive(btnEndShift, !!state.shift_active);

    // –í –Ω–∞—á–∞–ª–µ —Å–º–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    if (!state.shift_active && !initialShiftModalShown) {
      initialShiftModalShown = true;
      openShiftModal("add");
    }

    document.getElementById("shiftInfo").textContent =
      state.shift_active ? "–°–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞" : (state.shift_label || "–°–º–µ–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞");
    document.getElementById("workerStats").textContent =
      state.worker_stats || "–°–µ–≥–æ–¥–Ω—è: 0 –∫—Ä–æ–≤–∞—Ç–µ–π, –ø—Ä–æ—Å—Ç–æ–µ–≤ 0 –º–∏–Ω";

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ö—Ä–æ–≤–∞—Ç—å: –∫—Ä—É–ø–Ω–æ SKU + —Å–Ω–∏–∑—É –ø–æ—è—Å–Ω–µ–Ω–∏–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// –ö–∞—Ä—Ç–∞ "–∫–æ–¥ –º–æ–¥–µ–ª–∏" -> "–Ω–∞–∑–≤–∞–Ω–∏–µ"
const BED_NAME_BY_PREFIX = {
  "001": "–°–æ–Ω–Ω–∞",
  "003": "–°–µ–Ω–Ω–∞",
};

// –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 —Ü–∏—Ñ—Ä—ã –∏–∑ SKU (–Ω–∞–ø—Ä–∏–º–µ—Ä "MM.–ö—Ä–æ–≤–∞—Ç—å.003-16-VelutaLux.07" -> "003")
function getModelPrefixFromSku(sku) {
  if (!sku) return "";
  const m = String(sku).match(/\b(\d{3})\b/); // –∏—â–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ —Å—Ç–æ—è—â–∏–µ 3 —Ü–∏—Ñ—Ä—ã
  return m ? m[1] : "";
}

// –ü–æ–ª—É—á–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è –∫—Ä–æ–≤–∞—Ç–∏ –ø–æ SKU
function getBedHumanName(sku) {
  const prefix = getModelPrefixFromSku(sku);
  return BED_NAME_BY_PREFIX[prefix] || "‚Äî";
}

const skuValue = state.bed_sku || "‚Äî";
const bedHumanName = getBedHumanName(skuValue);

// 1) –ö—Ä—É–ø–Ω–æ SKU
const skuBigEl = document.getElementById("bedSkuBig");
if (skuBigEl) {
  skuBigEl.textContent = "SKU " + skuValue;
}

// 2) –í–Ω–∏–∑—É: –ú–æ–¥–µ–ª—å + –¥–µ—Ç–∞–ª–∏ (—Ä–∞–∑–º–µ—Ä/—Ü–≤–µ—Ç/–≤–∏–¥ ‚Äî –∫–∞–∫ –æ—Ç–¥–∞—ë—Ç –±—ç–∫)
const detailsValue = state.bed_details || "–†–∞–∑–º–µ—Ä ‚Äî | –¶–≤–µ—Ç ‚Äî | –í–∏–¥ ‚Äî";
document.getElementById("bedDetails").textContent =
  "–ú–æ–¥–µ–ª—å " + bedHumanName + " | " + detailsValue;


    const status = state.status || "idle";
    setStatus(status);

    if (state.camera_stream_url) {
      const img = document.getElementById("cameraImage");
      const url = state.camera_stream_url;
      img.src = url.includes("?") ? url + "&t=" + Date.now() : url + "?t=" + Date.now();
    }
    const ws = state.worker_state || "idle";
    document.getElementById("workerStateLabel").textContent =
      "–°–æ—Å—Ç–æ—è–Ω–∏–µ: " + (ws === "working" ? "—Ä–∞–±–æ—Ç–∞" : ws === "idle" ? "–ø—Ä–æ—Å—Ç–æ–π" : ws);

    if (state.started_at_epoch) {
      timerStart = state.started_at_epoch * 1000;
    } else {
      timerStart = null;
      document.getElementById("sessionTimer").textContent = "00:00";
    }

    workBase = state.work_seconds || 0;
    idleBase = state.idle_seconds || 0;
    document.getElementById("workTimer").textContent =
      formatDuration(workBase);
    document.getElementById("idleTimer").textContent =
      formatDuration(idleBase);

    document.getElementById("instructionMain").textContent =
      state.instruction_main || "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —É–ø–∞–∫–æ–≤–∫–∏‚Ä¶";
    document.getElementById("instructionSub").textContent =
      state.instruction_sub ||
      "–ü—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫—Ä–æ–≤–∞—Ç–∏ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.";
    document.getElementById("instructionExtra").textContent =
      state.instruction_extra ||
      "–ì–æ–ª–æ—Å–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç —Ç–µ–∫—Å—Ç. –†–∞–±–æ—Ç–∞–π—Ç–µ –ø–æ –≥–æ–ª–æ—Å—É.";

    const currentStep = state.current_step_index || 0;
    const totalSteps = state.total_steps || 0;
    document.getElementById("stepsSummary").textContent =
      "–®–∞–≥ " + currentStep + " –∏–∑ " + totalSteps;
    document.getElementById("stepsCounters").textContent =
      (state.completed_steps || 0) +
      " –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ, " +
      (state.error_steps || 0) +
      " –æ—à–∏–±–æ–∫";

    const percent =
      totalSteps > 0 ? Math.round((currentStep / totalSteps) * 100) : 0;
    document.getElementById("progressFill").style.width = percent + "%";

    const stepsListEl = document.getElementById("stepsList");
    stepsListEl.innerHTML = "";
    if (state.steps && Array.isArray(state.steps)) {
      state.steps.forEach((step, idx) => {
        const row = document.createElement("div");
        row.className = "step-row";
        if (idx + 1 < currentStep) row.classList.add("done");
        if (idx + 1 === currentStep) row.classList.add("current");

        const indexEl = document.createElement("div");
        indexEl.className = "step-index";
        indexEl.textContent = idx + 1;

        const textWrap = document.createElement("div");
        const title = document.createElement("div");
        title.className = "step-title";
        title.textContent = step.title || "–®–∞–≥ " + (idx + 1);

        const meta = document.createElement("div");
        meta.className = "step-meta";
        meta.textContent = step.meta || "";

        textWrap.appendChild(title);
        textWrap.appendChild(meta);
        row.appendChild(indexEl);
        row.appendChild(textWrap);
        stepsListEl.appendChild(row);
      });
    }

    const eventsEl = document.getElementById("eventsList");
    eventsEl.innerHTML = "";
    if (state.events && Array.isArray(state.events)) {
      state.events.slice(-6).forEach((ev) => {
        const row = document.createElement("div");
        row.className = "event-row";

        const time = document.createElement("div");
        time.className = "event-time";
        time.textContent = ev.time || "";

        const txt = document.createElement("div");
        txt.className = "event-text";
        txt.textContent = ev.text || "";

        row.appendChild(time);
        row.appendChild(txt);
        eventsEl.appendChild(row);
      });
    }

    function fmtSec(v) {
      if (!v && v !== 0) return "‚Äî";
      return formatDuration(v);
    }
    document.getElementById("lastPack").textContent =
      fmtSec(state.last_pack_seconds);
    document.getElementById("bestPack").textContent =
      fmtSec(state.best_pack_seconds);
    document.getElementById("avgPack").textContent =
      fmtSec(state.avg_pack_seconds);

    renderOverlays(state);
  }

  function tickTimers() {
    if (!lastState) return;
    if (timerStart) {
      const diffSec = (Date.now() - timerStart) / 1000;
      document.getElementById("sessionTimer").textContent =
        formatDuration(diffSec);
    }
  }

  async function fetchState() {
    try {
      const resp = await fetch(API_STATE_URL, { cache: "no-store" });
      if (!resp.ok) return;
      const data = await resp.json();
      data.client_timestamp = Date.now() / 1000;
      renderState(data);
    } catch (e) {
      console.warn("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∏–æ—Å–∫–∞:", e);
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –£–ø–∞–∫–æ–≤–∫–∞: –æ—Ç–¥–µ–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ú—ã –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ —Ä–∞–∑–¥–µ–ª—è–µ–º –∑–∞–ø—Ä–æ—Å—ã:
  // 1) ui-state –¥–∞—ë—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ can_* —Ñ–ª–∞–≥–∏ (UI –Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ —Å–∞–º).
  // 2) steps/state –¥–∞—ë—Ç —Ñ–∞–∑—É –∏ —Ç–µ–∫—É—â–∏–π —à–∞–≥.
  // 3) plan –¥–∞—ë—Ç —Å–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.
  // –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–¥ –ø–æ–Ω—è—Ç–Ω—ã–º –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º: UI –ª–∏—à—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–æ, —á—Ç–æ —Ä–µ—à–∏–ª backend.
  async function fetchPackUiState() {
    try {
      const resp = await fetch(API_PACK_UI_STATE_URL, { cache: "no-store" });
      if (!resp.ok) {
        packUiState = null;
        renderPackUiState();
        return;
      }
      packUiState = await resp.json();
      renderPackUiState();
    } catch (e) {
      console.warn("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–ø–∞–∫–æ–≤–∫–∏:", e);
    }
  }

  async function fetchPackStepsState() {
    try {
      const resp = await fetch(API_PACK_STEPS_STATE_URL, { cache: "no-store" });
      if (!resp.ok) {
        packStepsState = null;
        renderPackStepsState();
        renderPackPlanPreview();
        return;
      }
      packStepsState = await resp.json();
      renderPackStepsState();
    } catch (e) {
      console.warn("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —à–∞–≥–æ–≤:", e);
    }
  }

  function loadShiftPlansFromStorage() {
    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞–Ω—ã –∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω –∏–∑ localStorage.
     *
     * –ó–∞—á–µ–º:
     * - –æ–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω —Ç–µ—Ä—è—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã;
     * - backend –ø–æ–∫–∞ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞;
     * - –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ UI –∏ –ª–µ–≥–∫–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –Ω–∞ API –ø–æ–∑–∂–µ.
     */
    try {
      const plansRaw = localStorage.getItem(SHIFT_PLAN_STORAGE_KEY) || "[]";
      const activeRaw = localStorage.getItem(SHIFT_PLAN_ACTIVE_KEY) || "0";
      const rawPlans = JSON.parse(plansRaw) || [];
      shiftPlanList = rawPlans.map((plan) => {
        const items = (plan.items || []).map((item) => {
          if (typeof item === "string") {
            return { sku: item, qty: 1 };
          }
          return { sku: item.sku, qty: item.qty || 1 };
        });
        return { id: plan.id, name: plan.name || "–°–º–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ", items };
      });
      const activeId = parseInt(activeRaw, 10);
      shiftPlanSelected = shiftPlanList.find((p) => p.id === activeId) || null;
    } catch (e) {
      shiftPlanList = [];
      shiftPlanSelected = null;
    }
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  function saveShiftPlansToStorage() {
    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞–Ω—ã –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ.
     *
     * –≠—Ç–æ –±–∞–∑–æ–≤–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ UI –Ω–µ "–∑–∞–±—ã–≤–∞–µ—Ç" —Å–ø–∏—Å–æ–∫ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏,
     * –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ—Ç—å –∏–ª–∏ backend –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.
     */
    localStorage.setItem(SHIFT_PLAN_STORAGE_KEY, JSON.stringify(shiftPlanList || []));
    localStorage.setItem(SHIFT_PLAN_ACTIVE_KEY, String(shiftPlanSelected ? shiftPlanSelected.id : 0));
  }

  function renderPackUiState() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä—É —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–ø–∞–∫–æ–≤–∫–∏ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º can_* —Ñ–ª–∞–≥–∏ –≤ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫.
    // –í–∞–∂–Ω–æ: –ø—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –≤ UI, –º—ã —Ç–æ–ª—å–∫–æ –¥–æ–≤–µ—Ä—è–µ–º backend.
    const label = document.getElementById("packStateLabel");
    const phaseLabel = document.getElementById("packPhaseLabel");
    const flagsLabel = document.getElementById("packFlags");
    const hintLabel = document.getElementById("packHint");
    if (!label || !phaseLabel) return;

    const active = packUiState && packUiState.active_session;
    const state = packUiState && packUiState.pack_state;
    const phase = active && active.phase ? active.phase : null;
    const stateMap = {
      started: "–í –†–ê–ë–û–¢–ï",
      box_closed: "–ö–û–†–û–ë–ö–ê –ó–ê–ö–†–´–¢–ê",
      label_printed: "–≠–¢–ò–ö–ï–¢–ö–ê –ù–ê–ü–ï–ß–ê–¢–ê–ù–ê",
      table_empty: "–°–¢–û–õ –ü–£–°–¢–û–ô",
    };
    const phaseMap = {
      LAYOUT: "–≤—ã–∫–ª–∞–¥–∫–∞",
      PACKING: "—É–ø–∞–∫–æ–≤–∫–∞",
    };
    label.textContent = "–°–æ—Å—Ç–æ—è–Ω–∏–µ: " + (stateMap[state] || "‚Äî");
    phaseLabel.textContent = "–§–∞–∑–∞: " + (phaseMap[phase] || "‚Äî");

    if (hintLabel) {
      hintLabel.textContent = active
        ? "–°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º. –ö–Ω–æ–ø–∫–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è."
        : "–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫—Ä–æ–≤–∞—Ç–∏ (SKU) –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.";
    }

    const canStart = packUiState && packUiState.can_start_sku;
    const canClose = packUiState && packUiState.can_close_box;
    const canPrint = packUiState && packUiState.can_print_label;
    const canTableEmpty = packUiState && packUiState.can_mark_table_empty;

    if (flagsLabel) {
      const available = [];
      if (canStart) available.push("–°—Ç–∞—Ä—Ç SKU");
      if (canClose) available.push("–ó–∞–∫—Ä—ã—Ç—å –∫–æ—Ä–æ–±–∫—É");
      if (canPrint) available.push("–ü–µ—á–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏");
      if (canTableEmpty) available.push("–°—Ç–æ–ª –ø—É—Å—Ç–æ–π");

      const lines = available.length ? available : ["‚Äî"];
      flagsLabel.innerHTML = `
        <div>–î–æ—Å—Ç—É–ø–Ω–æ:</div>
        ${lines.map(item => `<div>‚Ä¢ ${item}</div>`).join("")}
      `;
    }

    setActionPillDisabled(btnPackStart, !canStart);
    setActionPillDisabled(btnPackCloseBox, !canClose);
    setActionPillDisabled(btnPackPrintLabel, !canPrint);
    setActionPillDisabled(btnPackTableEmpty, !canTableEmpty);

    const hasSession = !!active;
    setActionPillDisabled(btnPackStepComplete, !hasSession);
    setActionPillDisabled(btnPackPhaseNext, !hasSession);
  }

  function renderPackStepsState() {
    // –°–≤–æ–¥–∫–∞ —à–∞–≥–∞ –∏ —Ç–µ–∫—É—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –±–µ—Ä—É—Ç—Å—è –∏–∑ backend, —á—Ç–æ–±—ã UI –Ω–µ –æ—à–∏–±—Å—è —Å –ª–æ–≥–∏–∫–æ–π.
    const currentStep = document.getElementById("packCurrentStep");
    if (!currentStep) return;

    if (!packStepsState || !packStepsState.phase) {
      currentStep.textContent = "‚Äî";
      return;
    }

    const step = packStepsState.current_step;
    if (!step) {
      currentStep.textContent = "‚Äî";
      return;
    }
    currentStep.textContent = step.slot + " ‚Äî " + step.part_code;
  }

  function renderPackPlanPreview() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 1‚Äì2 –±–ª–∏–∂–∞–π—à–∏—Ö —à–∞–≥–∞, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–µ–ª "—á—Ç–æ –¥–∞–ª—å—à–µ",
    // –Ω–æ –Ω–µ —É—Ç–æ–ø–∞–ª –≤ –¥–ª–∏–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ –∏ –Ω–µ —Ç–µ—Ä—è–ª —Ñ–æ–∫—É—Å –Ω–∞ —Ç–µ–∫—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.
    // –ü–ª–∞–Ω –Ω–µ –º–µ–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ, –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ–º –µ–≥–æ –∏–∑ backend –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥.
    const list = document.getElementById("packPlanPreview");
    if (!list) return;
    list.innerHTML = "";

    if (!shiftPlanSelected || !shiftPlanSelected.items || !shiftPlanSelected.items.length) {
      const empty = document.createElement("div");
      empty.className = "pack-step-line";
      empty.innerHTML = "<span>–ü–ª–∞–Ω –≤—ã–∫–ª–∞–¥–∫–∏ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span><span>‚Äî</span>";
      list.appendChild(empty);
      return;
    }

    const preview = shiftPlanSelected.items.slice(0, 3);
    preview.forEach((item, idx) => {
      const row = document.createElement("div");
      row.className = "pack-step-line";
      if (idx === 0) row.classList.add("current");
      row.innerHTML = `<span>${item.sku}</span><span>√ó${item.qty}</span>`;
      list.appendChild(row);
    });
  }

  function renderShiftPlanPanel() {
    /**
     * –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è.
     * –ó–¥–µ—Å—å –º—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ –ø–ª–∞–Ω, –∏ —Å–∫–æ–ª—å–∫–æ SKU –≤ –Ω—ë–º.
     */
    const nameEl = document.getElementById("shiftPlanName");
    const countEl = document.getElementById("shiftPlanCount");
    if (!nameEl || !countEl) return;

    if (!shiftPlanSelected) {
      nameEl.textContent = "–ü–ª–∞–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω";
      countEl.textContent = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ SKU: ‚Äî";
      renderShiftPlanList([]);
      return;
    }

    const totalCount = shiftPlanSelected.items.reduce((sum, item) => sum + item.qty, 0);
    nameEl.textContent = `–í—ã–±—Ä–∞–Ω –ø–ª–∞–Ω: ${shiftPlanSelected.name}`;
    countEl.textContent = `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ SKU: ${totalCount}`;
    renderShiftPlanList(shiftPlanSelected.items);
  }

  function renderShiftPlanList(items) {
    /**
     * –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ SKU –Ω–∞ —Å–º–µ–Ω—É.
     * –ó–¥–µ—Å—å –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ.
     */
    const listEl = document.getElementById("shiftPlanList");
    if (!listEl) return;
    listEl.innerHTML = "";

    if (!items || !items.length) {
      const empty = document.createElement("div");
      empty.className = "pack-meta";
      empty.textContent = "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –ú–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é.";
      listEl.appendChild(empty);
      return;
    }

    items.forEach((item) => {
      const row = document.createElement("div");
      row.className = "shift-plan-row";
      if (shiftPlanSelectedSku === item.sku) {
        row.classList.add("selected");
      }

      const skuEl = document.createElement("div");
      skuEl.textContent = item.sku;
      skuEl.addEventListener("click", () => {
        shiftPlanSelectedSku = item.sku;
        renderShiftPlanList(items);
      });

      const qtyEl = document.createElement("div");
      qtyEl.textContent = `√ó${item.qty}`;

      const minusBtn = document.createElement("div");
      minusBtn.className = "shift-plan-mini-btn";
      minusBtn.textContent = "‚àí";
      minusBtn.addEventListener("click", () => updateShiftPlanQty(item.sku, -1));

      const plusBtn = document.createElement("div");
      plusBtn.className = "shift-plan-mini-btn";
      plusBtn.textContent = "+";
      plusBtn.addEventListener("click", () => updateShiftPlanQty(item.sku, 1));

      const runBtn = document.createElement("div");
      runBtn.className = "shift-plan-mini-btn";
      runBtn.textContent = "–ó–∞–ø—É—Å—Ç–∏—Ç—å (—Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä)";
      if (!manualModeEnabled) {
        runBtn.classList.add("disabled");
      } else {
        runBtn.addEventListener("click", () => startSkuFromPlan(item.sku));
      }

      row.appendChild(skuEl);
      row.appendChild(qtyEl);
      row.appendChild(minusBtn);
      row.appendChild(plusBtn);
      row.appendChild(runBtn);
      listEl.appendChild(row);
    });
  }

  function updateShiftPlanQty(sku, delta) {
    /**
     * –ú–µ–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ SKU –≤ —Å–ø–∏—Å–∫–µ.
     * –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω—É–ª–µ–≤—ã–º ‚Äî —É–¥–∞–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é, —á—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –±—ã–ª —á–∏—Å—Ç—ã–º.
     */
    if (!shiftPlanSelected) return;
    const item = shiftPlanSelected.items.find((it) => it.sku === sku);
    if (!item) return;
    item.qty = Math.max(0, item.qty + delta);
    if (item.qty === 0) {
      shiftPlanSelected.items = shiftPlanSelected.items.filter((it) => it.sku !== sku);
      if (shiftPlanSelectedSku === sku) {
        shiftPlanSelectedSku = null;
      }
    }
    saveShiftPlansToStorage();
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  function addSkuToShiftPlan() {
    /**
     * –î–æ–±–∞–≤–ª—è–µ–º SKU –≤ –∞–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω.
     * –ï—Å–ª–∏ –ø–ª–∞–Ω –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–≥ —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ä–∞–∑—É.
     */
    const sku = (shiftPlanSkuInput.value || "").trim();
    const qty = Math.max(1, parseInt(shiftPlanQtyInput.value || "1", 10));
    if (!sku) {
      showPackToast("–í—ã–±–µ—Ä–∏—Ç–µ SKU –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.");
      return;
    }

    if (!shiftPlanSelected) {
      const newPlan = {
        id: Date.now(),
        name: "–°–º–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ",
        items: [],
      };
      shiftPlanList.unshift(newPlan);
      shiftPlanSelected = newPlan;
    }

    const existing = shiftPlanSelected.items.find((item) => item.sku === sku);
    if (existing) {
      existing.qty += qty;
    } else {
      shiftPlanSelected.items.push({ sku, qty });
    }

    shiftPlanSkuInput.value = "";
    shiftPlanQtyInput.value = "1";
    saveShiftPlansToStorage();
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  function removeSelectedSkuFromShiftPlan() {
    /**
     * –£–¥–∞–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –∏–∑ –ø–ª–∞–Ω–∞.
     * –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–≥ –±—ã—Å—Ç—Ä–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –±–µ–∑ –º–æ–¥–∞–ª–∫–∏.
     */
    if (!shiftPlanSelected || !shiftPlanSelectedSku) {
      showPackToast("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –≤ —Å–ø–∏—Å–∫–µ, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å.");
      return;
    }
    shiftPlanSelected.items = shiftPlanSelected.items.filter((item) => item.sku !== shiftPlanSelectedSku);
    shiftPlanSelectedSku = null;
    saveShiftPlansToStorage();
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  function initShiftPlanCatalog() {
    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ SKU –ª–æ–∫–∞–ª—å–Ω—ã–º –∫–∞—Ç–∞–ª–æ–≥–æ–º.
     * –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ä–∞: –ø–æ–∑–∂–µ –∫–∞—Ç–∞–ª–æ–≥ –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ API –±–µ–∑ —Å–º–µ–Ω—ã UI.
     */
    const dataList = document.getElementById("shiftPlanSkuCatalog");
    if (!dataList) return;
    dataList.innerHTML = "";
    SHIFT_PLAN_SKU_CATALOG.forEach((sku) => {
      const option = document.createElement("option");
      option.value = sku;
      dataList.appendChild(option);
    });
  }

  async function startSkuFromPlan(sku) {
    /**
     * –ó–∞–ø—É—Å–∫ SKU –∏–∑ —Å–ø–∏—Å–∫–∞ ‚Äî —Ç–æ–ª—å–∫–æ –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ —Å—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä–∞.
     * –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —á—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –æ—Ç—Ä–∞–∂–∞–ª –ø—Ä–æ–≥—Ä–µ—Å—Å.
     */
    if (!manualModeEnabled) return;
    await handlePackAction("/api/kiosk/pack/start", { sku });
    updateShiftPlanQty(sku, -1);
  }

  function renderShiftPlanSelectActions() {
    /**
     * –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ –≤ –≤–∏–¥–µ –∫–Ω–æ–ø–æ–∫.
     * –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å –ø–ª–∞–Ω –±—ã—Å—Ç—Ä–æ, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ä–º –≤–≤–æ–¥–∞.
     */
    shiftPlanSelectActions.innerHTML = "";

    if (!shiftPlanList.length) {
      shiftPlanSelectActions.appendChild(mkModalBtn("–ü–ª–∞–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", "primary", () => {}));
      return;
    }

    shiftPlanList.forEach((plan) => {
      const totalCount = plan.items.reduce((sum, item) => sum + item.qty, 0);
      shiftPlanSelectActions.appendChild(
        mkModalBtn(`${plan.name} (${totalCount} SKU)`, "success", async () => {
          selectShiftPlan(plan.id);
          closeShiftPlanSelectModal();
        })
      );
    });
  }

  function parseShiftPlanText(text) {
    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ SKU –≤ –º–∞—Å—Å–∏–≤ –ø–æ–∑–∏—Ü–∏–π —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º.
     * –ï—Å–ª–∏ SKU –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, —Å—É–º–º–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–µ–ª –∏—Ç–æ–≥.
     */
    const lines = text.split("\n").map((line) => line.trim()).filter(Boolean);
    const map = new Map();
    lines.forEach((sku) => {
      const count = map.get(sku) || 0;
      map.set(sku, count + 1);
    });
    return Array.from(map.entries()).map(([sku, qty]) => ({ sku, qty }));
  }

  function uploadShiftPlan(text, name) {
    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–º–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –≤ backend.
     * –ó–¥–µ—Å—å —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã –æ–Ω –Ω–µ —Ç–µ—Ä—è–ª—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
     */
    const items = parseShiftPlanText(text);
    if (!items.length) {
      showPackToast("–°–ø–∏—Å–æ–∫ SKU –ø—É—Å—Ç. –ü–ª–∞–Ω –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.");
      return;
    }

    const planName = (name || "–°–º–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ").trim();
    if (shiftPlanSelected) {
      shiftPlanSelected.name = planName;
      shiftPlanSelected.items = items;
      shiftPlanSelectedSku = null;
    } else {
      const newPlan = {
        id: Date.now(),
        name: planName,
        items,
      };
      shiftPlanList.unshift(newPlan);
      shiftPlanSelected = newPlan;
      shiftPlanSelectedSku = null;
    }

    saveShiftPlansToStorage();
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  function selectShiftPlan(planId) {
    /**
     * –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞ –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ UI.
     * –£–ø–∞–∫–æ–≤–æ—á–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è QR –∏ FSM.
     */
    shiftPlanSelected = shiftPlanList.find((plan) => plan.id === planId) || null;
    shiftPlanSelectedSku = null;
    saveShiftPlansToStorage();
    renderShiftPlanPanel();
    renderPackPlanPreview();
  }

  async function handlePackAction(url, body) {
    // –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–∑–æ–≤ —É–ø–∞–∫–æ–≤–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.
    // –ï—Å–ª–∏ backend –≤–µ—Ä–Ω—É–ª 409/400, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.
    try {
      const resp = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: body ? JSON.stringify(body) : null,
      });
      if (!resp.ok) {
        const detail = await resp.json().catch(() => ({}));
        showPackToast(detail.detail || "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ.");
        return;
      }
      await refreshPackData();
    } catch (e) {
      showPackToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.");
    }
  }

  async function refreshPackData() {
    // –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º UI: —Å–æ—Å—Ç–æ—è–Ω–∏—è, —à–∞–≥–∏ –∏ –ø–ª–∞–Ω.
    await fetchPackUiState();
    await fetchPackStepsState();
    loadShiftPlansFromStorage();
  }

  setInterval(fetchState, 1500);
  setInterval(refreshPackData, 2000);
  setInterval(tickTimers, 1000);
  fetchState();
  refreshPackData();
  initShiftPlanCatalog();
  loadShiftPlansFromStorage();

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –°–∫–∞–Ω–µ—Ä, —Å–º–µ–Ω—ã –∏ —Ä–∞–±–æ—á–∏–µ —Ü–µ–Ω—Ç—Ä—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  let scanBuffer = "";

  // UI —ç–ª–µ–º–µ–Ω—Ç—ã
  const workerScanHintEl = document.getElementById("workerScanHint");
  const btnAddWorker = document.getElementById("btnAddWorker");
  const btnEndShift = document.getElementById("btnEndShift");

  // –ú–æ–¥–∞–ª–∫–∞
  const modalBackdrop = document.getElementById("shiftModalBackdrop");
  const modalTitleEl = document.getElementById("shiftModalTitle");
  const modalSubEl = document.getElementById("shiftModalSub");
  const modalCancelEl = document.getElementById("shiftModalCancel");
  const modalScanEl = document.getElementById("shiftModalScan");
  const modalHintEl = document.getElementById("shiftModalHint");
  const modalActionsEl = document.getElementById("shiftModalActions");

  // –ú–æ–¥–∞–ª–∫–∞ —É–ø–∞–∫–æ–≤–∫–∏: –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤–≤–æ–¥ SKU, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–µ–ª —è–≤–Ω—ã–π —Å—Ç–∞—Ä—Ç.
  const packModalBackdrop = document.getElementById("packModalBackdrop");
  const packModalSku = document.getElementById("packModalSku");
  const packModalHint = document.getElementById("packModalHint");
  const packModalCancel = document.getElementById("packModalCancel");
  const packModalActions = document.getElementById("packModalActions");

  // –ú–æ–¥–∞–ª–∫–∏ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏ –≤—ã–±–æ—Ä –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö.
  const shiftPlanUploadBackdrop = document.getElementById("shiftPlanUploadBackdrop");
  const shiftPlanNameInput = document.getElementById("shiftPlanNameInput");
  const shiftPlanTextarea = document.getElementById("shiftPlanTextarea");
  const shiftPlanUploadHint = document.getElementById("shiftPlanUploadHint");
  const shiftPlanUploadActions = document.getElementById("shiftPlanUploadActions");
  const shiftPlanUploadCancel = document.getElementById("shiftPlanUploadCancel");

  const shiftPlanSelectBackdrop = document.getElementById("shiftPlanSelectBackdrop");
  const shiftPlanSelectActions = document.getElementById("shiftPlanSelectActions");
  const shiftPlanSelectCancel = document.getElementById("shiftPlanSelectCancel");

  let modalOpen = false;
  let modalMode = "add"; // "add" | "end"
  let modalWorkerId = null;
  let initialShiftModalShown = false;

  let packModalOpen = false;
  let shiftPlanUploadOpen = false;
  let shiftPlanSelectOpen = false;

  // —Ñ–æ—Ä–º–∞—Ç QR –∫—Ä–æ–≤–∞—Ç–∏:

  // —Ñ–æ—Ä–º–∞—Ç QR –∫—Ä–æ–≤–∞—Ç–∏:
  //   MM.BED.003-16-VelutaLux.07
  //   –∏–ª–∏ MM.–ö—Ä–æ–≤–∞—Ç—å.003-16-VelutaLux.07
  function normalizeSkuFromQr(raw) {
    let sku = (raw || "").trim();
    if (!sku) return "";

    // BED -> –ö—Ä–æ–≤–∞—Ç—å
    sku = sku.replace("BED", "–ö—Ä–æ–≤–∞—Ç—å");

    // –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç —Å –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è–º–∏: MM_BED_003-16-VelutaLux_07
    if (sku.startsWith("MM_")) {
      const parts = sku.split("_"); // ["MM","BED","003-16-VelutaLux","07"] –∏–ª–∏ ["MM","003-16-VelutaLux","07"]
      if (parts.length >= 4 && parts[1] === "BED") {
        const body = parts[2];
        const color = parts[3];
        sku = "MM.–ö—Ä–æ–≤–∞—Ç—å." + body + "." + color;
      } else if (parts.length >= 3 && parts[1] !== "–ö—Ä–æ–≤–∞—Ç—å") {
        const body = parts[1];
        const color = parts[2];
        sku = "MM.–ö—Ä–æ–≤–∞—Ç—å." + body + "." + color;
      }
    }

    return sku;
  }

  function setActionPillActive(el, active) {
    if (!el) return;
    el.classList.toggle("active", !!active);
  }

  function setActionPillDisabled(el, disabled) {
    if (!el) return;
    el.classList.toggle("disabled", !!disabled);
    el.setAttribute("aria-disabled", disabled ? "true" : "false");
  }

  function showPackToast(message) {
    const toast = document.getElementById("packToast");
    if (!toast) return;
    toast.textContent = message;
    toast.style.display = "block";
    setTimeout(() => {
      toast.style.display = "none";
    }, 4000);
  }

  function openShiftModal(mode) {
    modalMode = mode || "add";
    modalWorkerId = null;
    modalOpen = true;
    modalBackdrop.classList.add("open");
    modalBackdrop.setAttribute("aria-hidden", "false");

    modalScanEl.textContent = "‚Äî";
    modalHintEl.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶";
    modalActionsEl.innerHTML = "";

    if (modalMode === "add") {
      modalTitleEl.textContent = "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞";
      modalSubEl.textContent = "–ü—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—á–∏–π —Ü–µ–Ω—Ç—Ä.";
    } else {
      modalTitleEl.textContent = "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É";
      modalSubEl.textContent = "–ü—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ —á—Ç–æ –∑–∞–∫—Ä—ã—Ç—å.";
    }
  }

  function closeShiftModal() {
    modalOpen = false;
    modalBackdrop.classList.remove("open");
    modalBackdrop.setAttribute("aria-hidden", "true");
    modalWorkerId = null;
  }

  function openPackModal() {
    /**
     * –ú–æ–¥–∞–ª–∫–∞ —Å—Ç–∞—Ä—Ç–∞ —É–ø–∞–∫–æ–≤–∫–∏.
     *
     * –ó–∞—á–µ–º:
     * - –æ–ø–µ—Ä–∞—Ç–æ—Ä —è–≤–Ω–æ –≤–≤–æ–¥–∏—Ç SKU –∏ –≤–∏–¥–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ;
     * - –º—ã –Ω–µ –ø—ã—Ç–∞–µ–º—Å—è "—É–≥–∞–¥—ã–≤–∞—Ç—å" SKU –≤ UI, —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –≤ backend.
     */
    packModalOpen = true;
    packModalBackdrop.classList.add("open");
    packModalBackdrop.setAttribute("aria-hidden", "false");
    packModalHint.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞‚Ä¶";
    packModalSku.value = "";
    packModalActions.innerHTML = "";

    const btnStart = mkModalBtn("–ó–∞–ø—É—Å—Ç–∏—Ç—å —É–ø–∞–∫–æ–≤–∫—É", "success", async () => {
      const sku = (packModalSku.value || "").trim();
      if (!sku) {
        packModalHint.textContent = "–í–≤–µ–¥–∏—Ç–µ SKU –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º.";
        return;
      }
      await handlePackAction("/api/kiosk/pack/start", { sku });
      closePackModal();
    });
    packModalActions.appendChild(btnStart);
    packModalSku.focus();
  }

  function closePackModal() {
    packModalOpen = false;
    packModalBackdrop.classList.remove("open");
    packModalBackdrop.setAttribute("aria-hidden", "true");
  }

  function openShiftPlanUploadModal() {
    /**
     * –ú–æ–¥–∞–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è.
     *
     * –°–ø–∏—Å–æ–∫ SKU –∑–∞–¥–∞—ë—Ç—Å—è –ø–æ—Å—Ç—Ä–æ—á–Ω–æ, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–≥ –≤—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ
     * –∏–∑ Excel/—Ç–∞–±–ª–∏—Ü—ã –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
     */
    shiftPlanUploadOpen = true;
    shiftPlanUploadBackdrop.classList.add("open");
    shiftPlanUploadBackdrop.setAttribute("aria-hidden", "false");
    if (shiftPlanSelected) {
      shiftPlanNameInput.value = shiftPlanSelected.name;
      shiftPlanTextarea.value = shiftPlanSelected.items
        .flatMap((item) => Array(item.qty).fill(item.sku))
        .join("\n");
    } else {
      shiftPlanNameInput.value = "";
      shiftPlanTextarea.value = "";
    }
    shiftPlanUploadHint.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞‚Ä¶";
    shiftPlanUploadActions.innerHTML = "";

    const btnUpload = mkModalBtn("–ó–∞–≥—Ä—É–∑–∏—Ç—å", "success", async () => {
      const text = (shiftPlanTextarea.value || "").trim();
      if (!text) {
        shiftPlanUploadHint.textContent = "–°–ø–∏—Å–æ–∫ SKU –ø—É—Å—Ç. –í—Å—Ç–∞–≤—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Å—Ç—Ä–æ—á–Ω–æ.";
        return;
      }
      const name = (shiftPlanNameInput.value || "").trim();
      uploadShiftPlan(text, name);
      closeShiftPlanUploadModal();
    });
    shiftPlanUploadActions.appendChild(btnUpload);
    shiftPlanTextarea.focus();
  }

  function closeShiftPlanUploadModal() {
    shiftPlanUploadOpen = false;
    shiftPlanUploadBackdrop.classList.remove("open");
    shiftPlanUploadBackdrop.setAttribute("aria-hidden", "true");
  }

  function openShiftPlanSelectModal() {
    /**
     * –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–º–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞.
     *
     * –ú—ã –≤—ã–≤–æ–¥–∏–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–ª–∞–Ω—ã –∫–∞–∫ –Ω–∞–±–æ—Ä –∫–Ω–æ–ø–æ–∫,
     * —á—Ç–æ–±—ã –≤—ã–±–æ—Ä –∑–∞–Ω–∏–º–∞–ª 1‚Äì2 –∫–ª–∏–∫–∞ –∏ –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª –≤–≤–æ–¥–∞.
     */
    shiftPlanSelectOpen = true;
    shiftPlanSelectBackdrop.classList.add("open");
    shiftPlanSelectBackdrop.setAttribute("aria-hidden", "false");
    renderShiftPlanSelectActions();
  }

  function closeShiftPlanSelectModal() {
    shiftPlanSelectOpen = false;
    shiftPlanSelectBackdrop.classList.remove("open");
    shiftPlanSelectBackdrop.setAttribute("aria-hidden", "true");
  }

function mkModalBtn(text, kind, onClick) {
  /**
   * –ú—ã —Ö–æ—Ç–∏–º –ï–î–ò–ù–´–ô —Å—Ç–∏–ª—å –ø–æ –≤—Å–µ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É.
   * –ü–æ—ç—Ç–æ–º—É –∫–Ω–æ–ø–∫–∏ –≤ –º–æ–¥–∞–ª–∫–µ –¥–µ–ª–∞–µ–º –∫–∞–∫ "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞":
   * - —Ñ–æ—Ä–º–∞ "–ø–∏–ª—é–ª—è"
   * - —Å–ª–µ–≤–∞ —Ç–æ—á–∫–∞-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
   */

  const b = document.createElement("div");

  // –ë–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å ‚Äî action-pill (–∫–∞–∫ –≤ –≤–µ—Ä—Ö–Ω–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ)
  b.className = "action-pill";

  // –î–æ–±–∞–≤–∏–º "—Ç–∏–ø" –∫–Ω–æ–ø–∫–∏ (–∑–µ–ª—ë–Ω–∞—è/–∫—Ä–∞—Å–Ω–∞—è/—Å–∏–Ω—è—è)
  // kind –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ "success" / "danger" / "primary"
  if (kind) b.classList.add("modal-" + kind);

  // –í–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏ –¥–µ–ª–∞–µ–º —Ç–æ—á–∫—É + —Ç–µ–∫—Å—Ç (–∫–∞–∫ –≤–µ–∑–¥–µ)
  b.innerHTML = `<span class="dot"></span><span>${text}</span>`;

  // –ß—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ "–Ω–∞—Å—Ç–æ—è—â–µ–π" –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
  b.setAttribute("role", "button");
  b.setAttribute("tabindex", "0");

  // –ö–ª–∏–∫
  b.addEventListener("click", onClick);

  return b;
}


  async function apiShiftAdd(workerId, workCenter) {
    await fetch("/api/kiosk/shift/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ worker_id: workerId, work_center: workCenter }),
    });
  }

  async function apiShiftEnd(workerId, centersOrNull) {
    await fetch("/api/kiosk/shift/end", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ worker_id: workerId, work_centers: centersOrNull || null }),
    });
  }

  function getWorkerCentersFromState(workerId) {
    const list = (lastState && lastState.active_workers) ? lastState.active_workers : [];
    const w = String(workerId || "").trim();
    return list.filter(x => (x.worker_id || "") === w).map(x => (x.work_center || "").toUpperCase());
  }

  function renderModalActions() {
    modalActionsEl.innerHTML = "";
    if (!modalWorkerId) {
      modalActionsEl.appendChild(mkModalBtn("–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", "primary", () => {}));
      return;
    }

    if (modalMode === "add") {
      modalActionsEl.appendChild(mkModalBtn("–£–ü–ê–ö–û–í–ö–ê", "success", async () => {
        await apiShiftAdd(modalWorkerId, "–£–ü–ê–ö–û–í–ö–ê");
        modalHintEl.textContent = `–ì–æ—Ç–æ–≤–æ: ${modalWorkerId} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –£–ü–ê–ö–û–í–ö–ê. –ú–æ–∂–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–π –†–¶.`;
        modalWorkerId = null;
        modalScanEl.textContent = "‚Äî";
        renderModalActions();
        fetchState();
      }));
      modalActionsEl.appendChild(mkModalBtn("–£–ö–û–ú–ü–õ–ï–ö–¢–û–í–ö–ê", "success", async () => {
        await apiShiftAdd(modalWorkerId, "–£–ö–û–ú–ü–õ–ï–ö–¢–û–í–ö–ê");
        modalHintEl.textContent = `–ì–æ—Ç–æ–≤–æ: ${modalWorkerId} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –£–ö–û–ú–ü–õ–ï–ö–¢–û–í–ö–ê. –ú–æ–∂–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–π –†–¶.`;
        modalWorkerId = null;
        modalScanEl.textContent = "‚Äî";
        renderModalActions();
        fetchState();
      }));
      return;
    }

    // end
    const centers = getWorkerCentersFromState(modalWorkerId);
    if (!centers.length) {
      modalHintEl.textContent = `–£ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ${modalWorkerId} –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã.`;
      modalWorkerId = null;
      modalScanEl.textContent = "‚Äî";
      return;
    }

    if (centers.length > 1) {
      modalActionsEl.appendChild(mkModalBtn("–ó–∞–∫—Ä—ã—Ç—å –û–ë–ê –†–¶", "danger", async () => {
        await apiShiftEnd(modalWorkerId, null);
        modalHintEl.textContent = `–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞: ${modalWorkerId} (–æ–±–∞ –†–¶).`;
        modalWorkerId = null;
        modalScanEl.textContent = "‚Äî";
        renderModalActions();
        fetchState();
      }));
    }
    centers.forEach((c) => {
      modalActionsEl.appendChild(mkModalBtn(`–ó–∞–∫—Ä—ã—Ç—å ${c}`, "danger", async () => {
        await apiShiftEnd(modalWorkerId, [c]);
        modalHintEl.textContent = `–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞: ${modalWorkerId} (${c}).`;
        modalWorkerId = null;
        modalScanEl.textContent = "‚Äî";
        renderModalActions();
        fetchState();
      }));
    });
  }

  if (btnAddWorker) {
    btnAddWorker.addEventListener("click", () => openShiftModal("add"));
  }
  if (btnEndShift) {
    btnEndShift.addEventListener("click", () => openShiftModal("end"));
  }
  if (modalCancelEl) {
    modalCancelEl.addEventListener("click", () => closeShiftModal());
  }
  if (packModalCancel) {
    packModalCancel.addEventListener("click", () => closePackModal());
  }
  if (shiftPlanUploadCancel) {
    shiftPlanUploadCancel.addEventListener("click", () => closeShiftPlanUploadModal());
  }
  if (shiftPlanSelectCancel) {
    shiftPlanSelectCancel.addEventListener("click", () => closeShiftPlanSelectModal());
  }

  btnPackStart = document.getElementById("btnPackStart");
  btnPackStepComplete = document.getElementById("btnPackStepComplete");
  btnPackPhaseNext = document.getElementById("btnPackPhaseNext");
  btnPackCloseBox = document.getElementById("btnPackCloseBox");
  btnPackPrintLabel = document.getElementById("btnPackPrintLabel");
  btnPackTableEmpty = document.getElementById("btnPackTableEmpty");
  const btnManualToggle = document.getElementById("btnManualToggle");
  const manualControls = document.getElementById("manualControls");
  const btnShiftPlanUpload = document.getElementById("btnShiftPlanUpload");
  const btnShiftPlanSelect = document.getElementById("btnShiftPlanSelect");
  const btnShiftPlanAdd = document.getElementById("btnShiftPlanAdd");
  const btnShiftPlanRemoveSelected = document.getElementById("btnShiftPlanRemoveSelected");
  const shiftPlanSkuInput = document.getElementById("shiftPlanSkuInput");
  const shiftPlanQtyInput = document.getElementById("shiftPlanQtyInput");

  if (btnPackStart) {
    btnPackStart.addEventListener("click", () => {
      if (btnPackStart.classList.contains("disabled")) return;
      openPackModal();
    });
  }
  if (btnPackStepComplete) {
    btnPackStepComplete.addEventListener("click", () => {
      if (btnPackStepComplete.classList.contains("disabled")) return;
      handlePackAction("/api/kiosk/pack/step/complete");
    });
  }
  if (btnPackPhaseNext) {
    btnPackPhaseNext.addEventListener("click", () => {
      if (btnPackPhaseNext.classList.contains("disabled")) return;
      handlePackAction("/api/kiosk/pack/phase/next");
    });
  }
  if (btnPackCloseBox) {
    btnPackCloseBox.addEventListener("click", () => {
      if (btnPackCloseBox.classList.contains("disabled")) return;
      handlePackAction("/api/kiosk/pack/close-box");
    });
  }
  if (btnPackPrintLabel) {
    btnPackPrintLabel.addEventListener("click", () => {
      if (btnPackPrintLabel.classList.contains("disabled")) return;
      handlePackAction("/api/kiosk/pack/print-label");
    });
  }
  if (btnPackTableEmpty) {
    btnPackTableEmpty.addEventListener("click", () => {
      if (btnPackTableEmpty.classList.contains("disabled")) return;
      handlePackAction("/api/kiosk/pack/table-empty");
    });
  }

  if (btnManualToggle && manualControls) {
    btnManualToggle.addEventListener("click", () => {
      /**
       * –ö–Ω–æ–ø–∫–∏ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é,
       * —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –Ω–∞ —Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.
       * –°—É–ø–µ—Ä–≤–∞–π–∑–µ—Ä –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç –±–ª–æ–∫ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
       */
      manualControls.classList.toggle("open");
      manualModeEnabled = manualControls.classList.contains("open");
      if (shiftPlanSelected) {
        renderShiftPlanList(shiftPlanSelected.items);
      }
    });
  }

  if (btnShiftPlanUpload) {
    btnShiftPlanUpload.addEventListener("click", () => openShiftPlanUploadModal());
  }
  if (btnShiftPlanSelect) {
    btnShiftPlanSelect.addEventListener("click", () => openShiftPlanSelectModal());
  }
  if (btnShiftPlanAdd) {
    btnShiftPlanAdd.addEventListener("click", () => addSkuToShiftPlan());
  }
  if (btnShiftPlanRemoveSelected) {
    btnShiftPlanRemoveSelected.addEventListener("click", () => removeSelectedSkuFromShiftPlan());
  }

  // helper –¥–ª—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏ –≤–Ω–∏–∑—É
  const scanDebug = document.createElement("div");
  scanDebug.style.position = "fixed";
  scanDebug.style.left = "8px";
  scanDebug.style.bottom = "6px";
  scanDebug.style.fontSize = "11px";
  scanDebug.style.color = "#6b7280";
  scanDebug.style.opacity = "0.8";
  scanDebug.style.pointerEvents = "none";
  scanDebug.style.zIndex = "9999";
  document.body.appendChild(scanDebug);

  async function startPackSession(workerId, sku) {
    const payload = {
      worker_id: workerId,
      // —á—Ç–æ–±—ã –±—ç–∫ –Ω–µ –ø–∞–¥–∞–ª –Ω–∞ None –∏ –º–æ–≥ –ø–æ–∫–∞–∑–∞—Ç—å –∏–º—è —Å—Ä–∞–∑—É
      worker_name: workerId,
      shift_label: "–°–º–µ–Ω–∞ –ê",
      // —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: –∫—Ç–æ-—Ç–æ –∂–¥—ë—Ç sku, –∫—Ç–æ-—Ç–æ product_code
      sku: sku,
      product_code: sku,
    };

    console.log("START SESSION:", payload);

    try {
      await fetch("/api/kiosk/session/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ /api/kiosk/session/start:", err);
    }
  }


    // –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏, –Ω–∞–±—Ä–∞–Ω–Ω–æ–π –≤ —Ä—É—Å—Å–∫–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ, –∫ –ª–∞—Ç–∏–Ω—Å–∫–æ–π (QWERTY ‚Üí –ô–¶–£–ö–ï–ù)
  function normalizeLayout(str) {
    const map = {
      '–π':'q','—Ü':'w','—É':'e','–∫':'r','–µ':'t','–Ω':'y','–≥':'u','—à':'i','—â':'o','–∑':'p','—Ö':'[','—ä':']',
      '—Ñ':'a','—ã':'s','–≤':'d','–∞':'f','–ø':'g','—Ä':'h','–æ':'j','–ª':'k','–¥':'l','–∂':';','—ç':'\'',
      '—è':'z','—á':'x','—Å':'c','–º':'v','–∏':'b','—Ç':'n','—å':'m','—é':'.','–±':',',
      '–ô':'Q','–¶':'W','–£':'E','–ö':'R','–ï':'T','–ù':'Y','–ì':'U','–®':'I','–©':'O','–ó':'P','–•':'{','–™':'}',
      '–§':'A','–´':'S','–í':'D','–ê':'F','–ü':'G','–†':'H','–û':'J','–õ':'K','–î':'L','–ñ':':','–≠':'"',
      '–Ø':'Z','–ß':'X','–°':'C','–ú':'V','–ò':'B','–¢':'N','–¨':'M','–Æ':'.','–ë':',',
    };
    return str.split("").map(ch => map[ch] || ch).join("");
  }

  function getDefaultPackingWorkerId() {
    const list = (lastState && lastState.active_workers) ? lastState.active_workers : [];
    const packers = list.filter(x => (x.work_center || "").toUpperCase() === "–£–ü–ê–ö–û–í–ö–ê");
    if (!packers.length) return null;
    // –±–µ—Ä—ë–º —Å–∞–º–æ–≥–æ —Ä–∞–Ω–Ω–µ–≥–æ (–ø–µ—Ä–≤—ã–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ) ‚Äî —É—Å—Ç–æ–π—á–∏–≤–æ
    return packers[0].worker_id || null;
  }

  async function handleScan(codeRaw) {
    // 1) –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É —Å–∫–∞–Ω–µ—Ä–∞ (—á–∞—Å—Ç–∞—è –ø—Ä–æ–±–ª–µ–º–∞, –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –≤ RU –∏ –≤–º–µ—Å—Ç–æ —Ç–æ—á–∫–∏/–ª–∞—Ç–∏–Ω–∏—Ü—ã –ø—Ä–∏–ª–µ—Ç–∞—é—Ç —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã)
    const normalized = normalizeLayout(codeRaw || "");
    const code = (normalized || "").trim();
    if (!code) return;

    scanDebug.textContent = "SCAN: " + code;
    console.log("SCAN RAW:", JSON.stringify(codeRaw));
    console.log("SCAN NORM:", JSON.stringify(code));

    // 2) –°–∫–∞–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    const mWorker = code.match(/^W?(\d{1,10})$/i);
    if (mWorker) {
      const num = mWorker[1];
      const wid = "W" + num;

      // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫–∞–Ω –≤–Ω—É—Ç—Ä–∏ –Ω–µ—ë
      if (modalOpen) {
        modalWorkerId = wid;
        modalScanEl.textContent = wid;
        modalHintEl.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ.";
        renderModalActions();
        return;
      }

      // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∏ –Ω–µ—Ç ‚Äî —É–¥–æ–±–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" —Å—Ä–∞–∑—É –ø–æ —Å–∫–∞–Ω—É
      openShiftModal("add");
      modalWorkerId = wid;
      modalScanEl.textContent = wid;
      modalHintEl.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—á–∏–π —Ü–µ–Ω—Ç—Ä –Ω–∏–∂–µ.";
      renderModalActions();
      return;
    }

    // 3) –°–∫–∞–Ω –∫—Ä–æ–≤–∞—Ç–∏ (SKU)
    const sku = normalizeSkuFromQr(code);
    if (!sku) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–æ–¥:", code);
      return;
    }

    // –Ω–µ–ª—å–∑—è –Ω–∞—á–∏–Ω–∞—Ç—å –±–µ–∑ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–º–µ–Ω—ã (—Ö–æ—Ç—è –±—ã 1 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–∞ –£–ü–ê–ö–û–í–ö–ê)
    const workerId = getDefaultPackingWorkerId();
    if (!workerId) {
      if (workerScanHintEl) {
        workerScanHintEl.textContent = "–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ –†–¶ –£–ü–ê–ö–û–í–ö–ê (–∫–Ω–æ–ø–∫–∞ '–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞').";
      }
      // –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
      if (!modalOpen) openShiftModal("add");
      return;
    }

    await startPackSession(workerId, sku);
  }

  // –°–∫–∞–Ω–µ—Ä –∫–∞–∫ HID-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞: –∫–æ–ø–∏–º –≤—Å—ë –¥–æ Enter
  document.addEventListener("keydown", (e) => {
    const tag = (e.target && e.target.tagName) || "";
    if (tag === "INPUT" || tag === "TEXTAREA") return;

    if (e.key === "Enter") {
      const code = scanBuffer;
      scanBuffer = "";
      if (code) {
        handleScan(code);
      }
      e.preventDefault();
      return;
    }

    if (e.key.length === 1) {
      scanBuffer += e.key;
    }
  });

  // –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ ESC
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalOpen) {
      closeShiftModal();
    }
    if (e.key === "Escape" && packModalOpen) {
      closePackModal();
    }
    if (e.key === "Escape" && shiftPlanUploadOpen) {
      closeShiftPlanUploadModal();
    }
    if (e.key === "Escape" && shiftPlanSelectOpen) {
      closeShiftPlanSelectModal();
    }
  });
</script>
</body>
</html>
